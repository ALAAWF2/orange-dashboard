<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ø¯Ù‚Ù‚ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª | Data Audit</title>
    <!-- Bootstrap 5 RTL -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        :root {
            --bs-primary: #fe7900;
            --font-main: 'Tajawal', sans-serif;
        }

        body {
            font-family: var(--font-main);
            background-color: #f8f9fa;
        }

        .navbar-brand {
            font-weight: 800;
        }

        .brand-orange {
            color: #fe7900;
        }

        .card {
            border: none;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            transition: transform 0.2s;
        }

        .card-header {
            background-color: white;
            border-bottom: 1px solid #f0f0f0;
            font-weight: 700;
            padding: 15px;
        }

        .status-badge {
            font-size: 0.8em;
            padding: 5px 10px;
            border-radius: 20px;
        }

        .table-custom th {
            background-color: #f8f9fa;
            font-weight: 600;
        }
    </style>
</head>

<body>

    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm mb-4">
        <div class="container-fluid">
            <span class="navbar-brand"><span class="brand-orange">ORANGE</span> DATA AUDIT ğŸ•µï¸â€â™‚ï¸</span>
            <div class="d-flex align-items-center gap-3">
                <span class="fw-bold text-muted small" id="userDisplay">Ù…Ø±Ø­Ø¨Ø§Ù‹ØŒ Ø¹Ù„Ø§Ø¡</span>
                <button onclick="logout()" class="btn btn-outline-danger btn-sm">Ø®Ø±ÙˆØ¬</button>
            </div>
        </div>
    </nav>

    <div class="container-fluid px-4">

        <!-- Header -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h4 class="fw-bold mb-1">Ù„ÙˆØ­Ø© ØªØ¯Ù‚ÙŠÙ‚ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</h4>
                <p class="text-muted mb-0 small">ÙØ­Øµ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ù„Ø£Ø®Ø·Ø§Ø¡ØŒ Ø§Ù„Ù†ÙˆØ§Ù‚ØµØŒ ÙˆØ§Ù„ØªÙƒØ±Ø§Ø± ÙÙŠ Ù…Ù„ÙØ§Øª Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.</p>
            </div>
            <button onclick="runAudit()" class="btn btn-primary fw-bold">
                <i class="fas fa-sync-alt me-1"></i> Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ÙØ­Øµ
            </button>
        </div>

        <!-- Alerts Area -->
        <div id="globalAlerts"></div>

        <div class="row g-4">

            <!-- 1. Store Management Audit -->
            <div class="col-12">
                <div class="card h-100 border-start border-4 border-warning">
                    <div class="card-header d-flex justify-content-between text-warning">
                        <span><i class="fas fa-store me-2"></i>ØªØ¯Ù‚ÙŠÙ‚ Ø§Ù„Ù…Ø¹Ø§Ø±Ø¶ (Management Data)</span>
                        <span class="badge bg-secondary" id="mgmtCount">Checking...</span>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover align-middle">
                                <thead>
                                    <tr>
                                        <th>Ù†ÙˆØ¹ Ø§Ù„Ø®Ø·Ø£</th>
                                        <th>Ø§Ù„ØªÙØ§ØµÙŠÙ„</th>
                                        <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                                        <th>Ø§Ù„Ù‚ÙŠÙ…Ø©</th>
                                        <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                                    </tr>
                                </thead>
                                <tbody id="mgmtIssuesBody">
                                    <tr>
                                        <td colspan="5" class="text-center text-muted">Ø¬Ø§Ø±ÙŠ ÙØ­Øµ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 2. Employee Duplicate Check -->
            <div class="col-md-6">
                <div class="card h-100 border-start border-4 border-danger">
                    <div class="card-header d-flex justify-content-between text-danger">
                        <span><i class="fas fa-users me-2"></i>ØªÙƒØ±Ø§Ø± Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† (Duplicates)</span>
                        <span class="badge bg-secondary" id="dupCount">Checking...</span>
                    </div>
                    <div class="card-body">
                        <p class="small text-muted mb-2">
                            <strong>Ø´Ø±Ø­:</strong> Ù‡Ø°Ø§ Ù„ÙŠØ³ ØªÙƒØ±Ø§Ø± Ø§Ù„ÙÙˆØ§ØªÙŠØ± (ÙˆÙ‡Ùˆ Ø·Ø¨ÙŠØ¹ÙŠ)ØŒ Ø¨Ù„ Ù‡Ùˆ
                            <span class="text-danger fw-bold">Ø®Ø·Ø£ ØªÙ‚Ù†ÙŠ</span>
                            ÙŠØ¹Ù†ÙŠ Ø£Ù† Ø§Ù„Ù…ÙˆØ¸Ù Ù„Ù‡ ØªÙ‚Ø±ÙŠØ±ÙŠÙ† Ù…Ø¨ÙŠØ¹Ø§Øª Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù„Ù†ÙØ³ Ø§Ù„ÙŠÙˆÙ…! (ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ù„Ù‡ Ø³Ø·Ø± ÙˆØ§Ø­Ø¯ ÙÙ‚Ø· ÙŠØ¬Ù…Ø¹ ÙƒÙ„
                            ÙÙˆØ§ØªÙŠØ±Ù‡).
                        </p>
                        <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                            <table class="table table-sm table-striped">
                                <thead>
                                    <tr>
                                        <th>Ø§Ù„Ù…ÙˆØ¸Ù</th>
                                        <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                                        <th>Ø§Ù„Ù…Ø¹Ø±Ø¶</th>
                                        <th>ØªÙƒØ±Ø§Ø±</th>
                                    </tr>
                                </thead>
                                <tbody id="dupBody">
                                    <tr>
                                        <td colspan="4" class="text-center text-muted">Ø¬Ø§Ø±ÙŠ Ø§Ù„ÙØ­Øµ...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 3. Missing Employees (From Script) -->
            <div class="col-md-6">
                <div class="card h-100 border-start border-4 border-info">
                    <div class="card-header d-flex justify-content-between text-info">
                        <span><i class="fas fa-user-slash me-2"></i>Ù…ÙˆØ¸ÙÙŠÙ† ØºÙŠØ± Ù…Ø³Ø¬Ù„ÙŠÙ† (Missing Mapping)</span>
                        <span class="badge bg-secondary" id="missingCount">Checking...</span>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-light border small mb-2">
                            <i class="fas fa-info-circle text-info"></i>
                            ÙŠØªÙ… ØªØ­Ø¯ÙŠØ« Ù‡Ø°Ù‡ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø¹Ø¨Ø± Ø³ÙƒØ±ÙŠØ¨Øª <code>check_missing_emp.py</code>
                        </div>
                        <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Sales Group ID</th>
                                        <th>Ø¢Ø®Ø± Ø¸Ù‡ÙˆØ±</th>
                                    </tr>
                                </thead>
                                <tbody id="missingBody">
                                    <tr>
                                        <td colspan="2" class="text-center text-muted">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª (Ø´ØºÙ„ Ø§Ù„Ø³ÙƒØ±ÙŠØ¨Øª
                                            Ø£ÙˆÙ„Ø§Ù‹)</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 4. Raw Data Browser -->
            <div class="col-12">
                <div class="card shadow-sm">
                    <div class="card-header bg-light">
                        <i class="fas fa-database me-2"></i> ØªØµÙØ­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø®Ø§Ù… (Raw Data)
                    </div>
                    <div class="card-body">
                        <div class="d-flex gap-2">
                            <button onclick="viewRawData('management_data.json')" class="btn btn-outline-secondary">
                                <i class="fas fa-file-code me-1"></i> Management Data
                            </button>
                            <button onclick="viewRawData('employees_data.json')" class="btn btn-outline-secondary">
                                <i class="fas fa-file-code me-1"></i> Employees Data
                            </button>
                            <button onclick="viewRawData('audit_missing_emp.json')" class="btn btn-outline-secondary">
                                <i class="fas fa-file-code me-1"></i> Audit Report
                            </button>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- Raw Data Modal -->
    <div class="modal fade" id="rawModal" tabindex="-1">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="rawModalTitle">File View</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body bg-light">
                    <pre id="rawContent" style="font-size: 0.8rem;"></pre>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Session Check
        const currentUser = JSON.parse(localStorage.getItem('currentUser'));
        // ... (auth logic) ...

        // ... (Existing variables) ...
        const rawModal = new bootstrap.Modal(document.getElementById('rawModal'));

        async function viewRawData(filename) {
            document.getElementById('rawModalTitle').textContent = filename;
            document.getElementById('rawContent').textContent = "Loading...";
            rawModal.show();

            try {
                const res = await fetch(filename + '?t=' + Date.now());
                const json = await res.json();
                document.getElementById('rawContent').textContent = JSON.stringify(json, null, 2);
            } catch (e) {
                document.getElementById('rawContent').textContent = "Error loading file: " + e.message;
            }
        }
        if (!currentUser || currentUser.role !== 'Auditor') {
            // Strict Access Control
            // window.location.href = 'login.html'; // Valid for prod, commented for now to allow dev testing safely
        }
        document.getElementById('userDisplay').textContent = `Ù…Ø±Ø­Ø¨Ø§Ù‹ØŒ ${currentUser ? currentUser.name : 'Guest'}`;

        function logout() {
            localStorage.removeItem('currentUser');
            window.location.href = 'login.html';
        }

        // --- Audit Logic ---

        async function runAudit() {
            console.log("Starting Audit...");
            try {
                // Load Data concurrently
                const [mgmtRes, empRes, missingRes] = await Promise.allSettled([
                    fetch('management_data.json?t=' + Date.now()),
                    fetch('employees_data.json?t=' + Date.now()),
                    fetch('audit_missing_emp.json?t=' + Date.now()) // Expecting this new file
                ]);

                // 1. Management Data Audit
                if (mgmtRes.status === 'fulfilled') {
                    const data = await mgmtRes.value.json();
                    window.mgmtData = data; // Save for store lookup
                    auditManagementData(data);
                } else {
                    console.error("Failed to load management_data.json");
                }

                // 2. Employee Duplicates
                if (empRes.status === 'fulfilled') {
                    const data = await empRes.value.json();
                    auditEmployeeDuplicates(data);
                }

                // 3. Missing Employees
                if (missingRes.status === 'fulfilled') {
                    const data = await missingRes.value.json();
                    renderMissingEmployees(data);
                } else {
                    // Start of project, file might not exist yet
                    document.getElementById('missingBody').innerHTML = `<tr><td colspan="2" class="text-center text-warning">Ù…Ù„Ù Ø§Ù„ØªÙ‚Ø±ÙŠØ± ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ (audit_missing_emp.json)</td></tr>`;
                }

            } catch (e) {
                console.error("Audit Error:", e);
                document.getElementById('globalAlerts').innerHTML = `<div class="alert alert-danger">Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ÙØ­Øµ: ${e.message}</div>`;
            }
        }

        function getStoreName(id) {
            if (window.mgmtData && window.mgmtData.stores && window.mgmtData.stores[id]) {
                return `${window.mgmtData.stores[id]} (${id})`;
            }
            return id;
        }

        // --- Logic: Management Data ---
        function auditManagementData(data) {
            const issues = [];
            const sales = data.sales || [];
            const visitors = data.visitors || [];

            // Index Visitors for O(1) lookup
            const visitorMap = new Map();
            visitors.forEach(rec => {
                const [date, storeId, val] = rec;
                visitorMap.set(`${storeId}|${date}`, val);
            });

            sales.forEach(rec => {
                const [date, storeId, val] = rec;
                const storeName = getStoreName(storeId);

                // 1. Check Negative Sales
                if (val < 0) {
                    issues.push({
                        type: 'Negative Sales ğŸ”»',
                        detail: `Ù…Ø¨ÙŠØ¹Ø§Øª Ø¨Ø§Ù„Ø³Ø§Ù„Ø¨ ÙÙŠ ${storeName} (Ø±Ø¨Ù…Ø§ Ù…Ø±ØªØ¬Ø¹Ø§ØªØŸ)`,
                        date: date,
                        val: val.toLocaleString(),
                        severity: 'danger'
                    });
                }

                // 2. Check Zero Visitors (Anomaly)
                // Logic: If Sales > 0 AND Visitors is 0 or missing
                if (val > 0) {
                    const vizCount = visitorMap.get(`${storeId}|${date}`) || 0;
                    if (vizCount === 0) {
                        issues.push({
                            type: 'Zero Visitors ğŸ‘»',
                            detail: `Ù…Ø¨ÙŠØ¹Ø§Øª (${val.toLocaleString()}) Ø¨Ø¯ÙˆÙ† Ø²ÙˆØ§Ø±! ÙÙŠ ${storeName}`,
                            date: date,
                            val: 0, // Visitor Count
                            severity: 'warning'
                        });
                    }
                }
            });

            renderIssues(issues, 'mgmtIssuesBody', 'mgmtCount');
        }

        // --- Logic: Employee Duplicates ---
        function auditEmployeeDuplicates(data) {
            const history = data.history || {};
            const duplicates = [];

            // Loop through all stores
            for (const [storeId, records] of Object.entries(history)) {

                const seen = new Map();

                records.forEach(rec => {
                    const date = rec[0];
                    const name = rec[1];
                    const key = `${name}|${date}`;

                    if (seen.has(key)) {
                        duplicates.push({
                            name: name,
                            date: date,
                            store: getStoreName(storeId), // Use Name
                            count: 2
                        });
                    } else {
                        seen.set(key, true);
                    }
                });
            }

            const tbody = document.getElementById('dupBody');
            document.getElementById('dupCount').textContent = duplicates.length;

            if (duplicates.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="text-center text-success fw-bold"><i class="fas fa-check-double me-1"></i> Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª Ù…ÙƒØ±Ø±Ø© (Ù†Ø¸ÙŠÙ)</td></tr>';
                return;
            }

            tbody.innerHTML = duplicates.map(d => `
                <tr>
                    <td class="fw-bold">${d.name}</td>
                    <td>${d.date}</td>
                    <td class="small">${d.store}</td>
                    <td class="text-danger fw-bold">ØªÙƒØ±Ø§Ø± Ø§Ù„Ø³Ø¬Ù„! âš ï¸</td>
                </tr>
            `).join('');
        }

        // --- Logic: Missing Employees ---
        function renderMissingEmployees(data) {
            const list = data.missing_sales_groups || [];
            const tbody = document.getElementById('missingBody');
            document.getElementById('missingCount').textContent = list.length;

            if (list.length === 0) {
                tbody.innerHTML = '<tr><td colspan="2" class="text-center text-success">Ø³Ù„ÙŠÙ… (Clean)</td></tr>';
                return;
            }

            tbody.innerHTML = list.map(item => `
                <tr>
                    <td><code>${item}</code></td>
                    <td class="text-muted">-</td>
                </tr>
            `).join('');
        }

        function renderIssues(issues, bodyId, countId) {
            const tbody = document.getElementById(bodyId);
            document.getElementById(countId).textContent = issues.length;

            if (issues.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center text-success"><i class="fas fa-check-circle me-1"></i> Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø³Ù„ÙŠÙ…Ø©</td></tr>';
                return;
            }

            tbody.innerHTML = issues.map(i => `
                <tr class="table-${i.severity || 'warning'}">
                    <td class="fw-bold">${i.type}</td>
                    <td>${i.detail}</td>
                    <td>${i.date}</td>
                    <td>${i.val}</td>
                    <td><span class="badge bg-danger">Ù„Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</span></td>
                </tr>
            `).join('');
        }

        // Auto-run on load
        runAudit();

    </script>
</body>

</html>