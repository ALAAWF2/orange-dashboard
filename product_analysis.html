<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Orange | ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</title>

    <!-- Bootstrap 5 RTL -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">

    <style>
        :root {
            --bs-primary: #fe7900;
            --bs-secondary: #6c757d;
            --bg-light: #f8f9fa;
            --card-radius: 12px;
            --font-main: 'Tajawal', sans-serif;
        }

        body {
            font-family: var(--font-main);
            background-color: var(--bg-light);
            color: #212529;
        }

        .navbar {
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            background: white !important;
        }

        .navbar-brand {
            font-weight: 800;
            color: #000 !important;
        }

        .brand-orange {
            color: #fe7900;
        }

        .card-custom {
            background: white;
            border: none;
            border-radius: var(--card-radius);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.03);
            margin-bottom: 20px;
        }

        .section-title {
            font-weight: 700;
            margin-bottom: 20px;
            border-right: 4px solid #fe7900;
            padding-right: 10px;
        }

        .table-custom thead th {
            background-color: #fe7900;
            color: white;
            font-weight: 500;
            border: none;
        }

        .table-hover tbody tr:hover {
            background-color: #fff3e0;
            cursor: pointer;
        }
    </style>
</head>

<body>

    <!-- Navbar -->
    <nav class="navbar mb-4 sticky-top">
        <div class="container-fluid">
            <span class="navbar-brand"><span class="brand-orange">ORANGE</span> PRODUCT ANALYSIS</span>
            <div class="d-flex gap-2 align-items-center">
                <span class="badge bg-light text-dark border" id="periodDisplay">...</span>
                <a href="index.html" class="btn btn-outline-secondary btn-sm fw-bold">
                    ğŸ  Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
                </a>
                <button onclick="logout()" class="btn btn-danger btn-sm fw-bold">Ø®Ø±ÙˆØ¬</button>
            </div>
        </div>
    </nav>

    <script src="users.js"></script>
    <script>
        const currentUser = JSON.parse(localStorage.getItem('currentUser'));
        if (!currentUser) {
            window.location.href = 'login.html';
        }

        function logout() {
            localStorage.removeItem('currentUser');
            window.location.href = 'login.html';
        }
    </script>

    <div class="container-fluid px-4">

        <!-- Controls -->
        <div class="row align-items-center mb-4">
            <div class="col-md-6">
                <!-- Period Toggle -->
                <div class="d-flex flex-wrap gap-2 mb-2 align-items-center">
                    <div class="btn-group" role="group" aria-label="Period Toggle">
                        <input type="radio" class="btn-check" name="periodbtn" id="btnMtd" autocomplete="off" checked
                            onchange="switchPeriod('mtd')">
                        <label class="btn btn-outline-primary fw-bold" for="btnMtd">ğŸ“… Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ</label>

                        <input type="radio" class="btn-check" name="periodbtn" id="btn7" autocomplete="off"
                            onchange="switchPeriod('7d')">
                        <label class="btn btn-outline-primary fw-bold" for="btn7">7 Ø£ÙŠØ§Ù…</label>

                        <input type="radio" class="btn-check" name="periodbtn" id="btn14" autocomplete="off"
                            onchange="switchPeriod('14d')">
                        <label class="btn btn-outline-primary fw-bold" for="btn14">14 ÙŠÙˆÙ…</label>

                        <input type="radio" class="btn-check" name="periodbtn" id="btn30" autocomplete="off"
                            onchange="switchPeriod('30d')">
                        <label class="btn btn-outline-primary fw-bold" for="btn30">30 ÙŠÙˆÙ…</label>

                        <input type="radio" class="btn-check" name="periodbtn" id="btnYest" autocomplete="off"
                            onchange="switchPeriod('yest')">
                        <label class="btn btn-outline-primary fw-bold" for="btnYest">â³ Ø£Ù…Ø³</label>
                    </div>

                    <div class="d-inline-flex align-items-center p-1 border rounded bg-white">
                        <span class="me-2 small fw-bold text-muted">Ø§Ù„Ø¹Ø±Ø¶:</span>
                        <div class="form-check form-switch m-0">
                            <input class="form-check-input" type="checkbox" id="metricToggle" onchange="toggleMetric()">
                            <label class="form-check-label fw-bold" for="metricToggle" id="metricLabel">ğŸ’°
                                Ø§Ù„Ù‚ÙŠÙ…Ø©</label>
                        </div>
                    </div>
                </div>

                <!-- Filters Row -->
                <div class="d-flex gap-2">
                    <select class="form-select form-select-sm fw-bold" id="regionFilter"
                        style="width: 150px; display:none;" onchange="applyFilters()">
                        <option value="all">ğŸ“ ÙƒÙ„ Ø§Ù„Ù…Ù†Ø§Ø·Ù‚</option>
                    </select>
                    <select class="form-select form-select-sm fw-bold" id="storeFilter"
                        style="width: 180px; display:none;" onchange="applyFilters()">
                        <option value="all">ğŸª ÙƒÙ„ Ø§Ù„Ù…Ø¹Ø§Ø±Ø¶</option>
                    </select>
                </div>
            </div>
            <div class="col-md-6 text-end">
                <div class="d-flex justify-content-end align-items-center gap-2">
                    <button class="btn btn-warning fw-bold text-dark" onclick="openCatalogModal()">ğŸ“‚ ØªØµÙØ­
                        Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</button>
                    <div class="input-group" style="width: 250px;">
                        <span class="input-group-text bg-white border-end-0">ğŸ”</span>
                        <input type="text" class="form-control border-start-0" id="productSearchInput"
                            placeholder="Ø¨Ø­Ø« Ø¹Ù† Ù…Ù†ØªØ¬..." onkeyup="handleSearch()">
                    </div>
                    <!-- Date Label (Restored) -->
                    <h5 class="section-title mb-0 border-0 ms-2" id="currentPeriodLabel">...</h5>
                </div>
            </div>
        </div>

        <!-- Summary Section -->
        <h5 class="section-title">Ù…Ù„Ø®Øµ Ø£Ø¯Ø§Ø¡ Ø§Ù„ÙØ¦Ø§Øª ÙˆØ§Ù„Ù…Ù†ØªØ¬Ø§Øª (Category & Product Performance)</h5>
        <div class="row mb-4">
            <!-- Top Products per Category -->
            <div class="col-md-6">
                <div class="card-custom p-3" style="height: 450px; overflow-y: auto;">
                    <h6 class="text-muted fw-bold mb-3">
                        Ø§Ù„Ù…Ù†ØªØ¬ Ø§Ù„Ø£ÙƒØ«Ø± Ù…Ø¨ÙŠØ¹Ø§Ù‹ Ø­Ø³Ø¨ Ø§Ù„ÙØ¦Ø© (<span id="topCatLabel">Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ</span>)
                    </h6>
                    <table class="table table-sm align-middle table-hover">
                        <thead class="table-light sticky-top" style="top: 0; z-index: 1;">
                            <tr>
                                <th>Ø§Ù„ØªØµÙ†ÙŠÙ</th>
                                <th>Ø±Ù‚Ù… Ø§Ù„Ù…Ù†ØªØ¬ (Item ID)</th>
                                <th onclick="setSort('topProd', 'qty')" style="cursor: pointer;">Ø§Ù„ÙƒÙ…ÙŠØ© â†•</th>
                                <th onclick="setSort('topProd', 'val')" style="cursor: pointer;">Ø§Ù„Ù‚ÙŠÙ…Ø© â†•</th>
                            </tr>
                        </thead>
                        <tbody id="topProductsBody">
                            <!-- JS -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Top Categories List (Existing) -->
            <div class="col-md-6">
                <div class="card-custom p-3" style="height: 450px; overflow-y: auto;">
                    <h6 class="text-muted fw-bold mb-3">Ø£Ø¯Ø§Ø¡ Ø§Ù„ÙØ¦Ø§Øª (Category Performance) - <span
                            id="topCatLabel"></span></h6>
                    <table class="table table-sm align-middle">
                        <thead class="table-light sticky-top" style="top: 0; z-index: 1;">
                            <tr>
                                <th>#</th>
                                <th>Ø§Ù„ØªØµÙ†ÙŠÙ</th>
                                <th onclick="setSort('catPerf', 'qty')" style="cursor: pointer;">Ø§Ù„ÙƒÙ…ÙŠØ© â†•</th>
                                <th onclick="setSort('catPerf', 'val')" style="cursor: pointer;">Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª â†•</th>
                                <th>Ù…Ø³Ø§Ù‡Ù…Ø© %</th>
                            </tr>
                        </thead>
                        <tbody id="topCategoriesBody">
                            <!-- JS -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Market Basket Analysis Section (NEW) -->
        <h5 class="section-title">Ø£ÙƒØ«Ø± Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„ØªÙŠ ØªØ´ØªØ±Ù‰ Ù…Ø¹Ø§Ù‹ (Items Bought Together)</h5>
        <div class="card-custom p-3 mb-4" style="height: 400px; overflow-y: auto;">
            <table class="table table-sm align-middle table-hover">
                <thead class="table-light sticky-top" style="top: 0; z-index: 1;">
                    <tr>
                        <th>#</th>
                        <th>Ø§Ù„Ù…Ù†ØªØ¬ Ø§Ù„Ø£ÙˆÙ„</th>
                        <th>Ø§Ù„Ù…Ù†ØªØ¬ Ø§Ù„Ø«Ø§Ù†ÙŠ</th>
                        <th onclick="setSort('basket', 'freq')" style="cursor: pointer;">Ù…Ø±Ø§Øª Ø§Ù„Ø´Ø±Ø§Ø¡ Ù…Ø¹Ø§Ù‹ â†•</th>
                    </tr>
                </thead>
                <tbody id="marketBasketBody">
                    <!-- JS -->
                </tbody>
            </table>
        </div>

        <!-- Outlets Table -->
        <h5 class="section-title">ØªÙØ§ØµÙŠÙ„ Ø§Ù„ÙØ±ÙˆØ¹ (Outlets Breakdown)</h5>
        <div class="card-custom p-3">
            <div class="table-responsive">
                <table class="table table-custom table-hover align-middle">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Ø§Ù„ÙØ±Ø¹ (Outlet)</th>
                            <th onclick="setSort('outlets', 'qty')" style="cursor: pointer;">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ…ÙŠØ© (Total Qty) â†•
                            </th>
                            <th onclick="setSort('outlets', 'val')" style="cursor: pointer;">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª (Total
                                Sales) â†•</th>
                            <th>Ø£Ø¹Ù„Ù‰ ØªØµÙ†ÙŠÙ Ù…Ø¨ÙŠØ¹Ø§Ù‹ (Top Category)</th>
                            <th>Ø¥Ø¬Ø±Ø§Ø¡</th>
                        </tr>
                    </thead>
                    <tbody id="outletsTableBody">
                        <!-- JS -->
                    </tbody>
                </table>
            </div>
        </div>

    </div>

    <!-- Store Details Modal -->
    <div class="modal fade" id="detailsModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-light">
                    <h5 class="modal-title fw-bold" id="modalTitle">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="table-responsive">
                        <table class="table table-hover table-striped mb-0">
                            <thead class="table-dark">
                                <tr>
                                    <th class="text-center">Ø§Ù„ØªØµÙ†ÙŠÙ (Category)</th>
                                    <th class="text-center" onclick="setSort('modal', 'qty')" style="cursor: pointer;">
                                        Ø§Ù„ÙƒÙ…ÙŠØ© (Qty) â†•</th>
                                    <th class="text-center" onclick="setSort('modal', 'val')" style="cursor: pointer;">
                                        Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª (Amount) â†•</th>
                                    <th class="text-center" style="width: 30%;">Ø£Ø¹Ù„Ù‰ Ù…Ù†ØªØ¬ (Top Product)</th>
                                    <th class="text-center">Q</th>
                                    <th class="text-center">V</th>
                                </tr>
                            </thead>
                            <tbody id="modalTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Product Details Modal (NEW) -->
    <div class="modal fade" id="productModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header text-white" style="background-color: var(--bs-primary);">
                    <div>
                        <h5 class="modal-title fw-bold" id="prodModalName">Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬</h5>
                        <small id="prodModalId" class="opacity-75">Item ID</small>
                    </div>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                        aria-label="Close"></button>
                </div>
                <div class="modal-body bg-light">

                    <!-- KPI Cards -->
                    <div class="row g-2 mb-3">
                        <div class="col-4">
                            <div class="card p-2 text-center border-0 shadow-sm">
                                <small class="text-muted">Ø£ÙØ¶Ù„ ÙŠÙˆÙ…</small>
                                <div class="fw-bold text-success" id="pmBestDay">-</div>
                                <small class="text-muted" style="font-size: 0.7em;" id="pmBestDayVal">-</small>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="card p-2 text-center border-0 shadow-sm">
                                <small class="text-muted">Ø£Ø³ÙˆØ£ ÙŠÙˆÙ…</small>
                                <div class="fw-bold text-danger" id="pmWorstDay">-</div>
                                <small class="text-muted" style="font-size: 0.7em;" id="pmWorstDayVal">-</small>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="card p-2 text-center border-0 shadow-sm">
                                <small class="text-muted">Ø£ÙŠØ§Ù… Ø¨Ù„Ø§ Ù…Ø¨ÙŠØ¹Ø§Øª</small>
                                <div class="fw-bold text-warning" id="pmZeroDays">-</div>
                                <small class="text-muted" style="font-size: 0.7em;">Ø®Ù„Ø§Ù„ Ø§Ù„ÙØªØ±Ø©</small>
                            </div>
                        </div>
                    </div>

                    <!-- Chart -->
                    <div class="card border-0 shadow-sm p-3 mb-3">
                        <h6 class="fw-bold mb-3 border-bottom pb-2">Ø³Ø¬Ù„ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„ÙŠÙˆÙ…ÙŠ (Daily Sales Trend)</h6>
                        <div style="height: 250px;">
                            <canvas id="productTrendChart"></canvas>
                        </div>
                        <div id="chartNoDataMsg" class="text-center text-muted py-5 d-none">
                            <i class="fs-1">ğŸ“‰</i><br>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ØªØ§Ø±ÙŠØ®ÙŠØ© Ù…ÙØµÙ„Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†ØªØ¬ Ø­Ø§Ù„ÙŠØ§Ù‹
                        </div>
                    </div>

                    <!-- Trend Analysis Badge -->
                    <div class="alert alert-info d-flex align-items-center mb-3" role="alert" id="trendAlertBox">
                        <span id="trendIcon" class="me-2 fs-4"></span>
                        <div>
                            <strong>ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø§ØªØ¬Ø§Ù‡:</strong> <span id="trendText">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù„ÙŠÙ„...</span>
                        </div>
                    </div>

                    <!-- Frequently Bought Together (Modal) -->
                    <div class="card border-0 shadow-sm p-3">
                        <h6 class="fw-bold mb-3 border-bottom pb-2">ØºØ§Ù„Ø¨Ø§Ù‹ ÙŠØ´ØªØ±Ù‰ Ù…Ø¹ (Frequently Bought With)</h6>
                        <ul class="list-group list-group-flush" id="modalRelatedItems">
                            <li class="list-group-item text-muted small">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</li>
                        </ul>
                    </div>

                </div>
            </div>
        </div>
    </div>

    <!-- Category Explorer Modal -->
    <div class="modal fade" id="catalogModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header bg-warning">
                    <h5 class="modal-title fw-bold text-dark">ğŸ“‚ Ø¯Ù„ÙŠÙ„ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… ÙˆØ§Ù„Ù…Ù†ØªØ¬Ø§Øª</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body bg-light">
                    <!-- Search inside Catalog -->
                    <div class="mb-3">
                        <input type="text" class="form-control form-control-lg" id="catalogSearch"
                            placeholder="Ø¨Ø­Ø« Ø¯Ø§Ø®Ù„ Ø§Ù„Ø¯Ù„ÙŠÙ„ (Ø§Ø³Ù… Ø§Ù„Ù‚Ø³Ù… Ø£Ùˆ Ø§Ù„Ù…Ù†ØªØ¬)..." onkeyup="filterCatalog()">
                    </div>

                    <!-- Accordion Container -->
                    <div class="accordion" id="categoryAccordion">
                        <!-- Dynamic Content -->
                    </div>
                    <div id="catalogNoData" class="text-center text-muted mt-5 d-none">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ù…Ø·Ø§Ø¨Ù‚Ø©</div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        let rawData = null;
        let currentData = null;
        let currentMode = 'mtd';
        let currentMetric = 'val';
        let chartInstance = null;

        // Log Auth for debugging
        console.log("Current User:", currentUser);

        // Modal Instances
        let detailsModalObj = null;
        let productModalObj = null;
        let catalogModalObj = null;

        // Filter Scope
        let activeRegion = 'all';
        let activeStore = 'all';

        // Mock Data for History (Temporary until backend is ready)
        const mockHistoryCache = {};

        let storeMeta = {};
        let currentOpenStoreId = null; // Track open modal

        // Sorting State
        let sortState = {
            topProd: { col: 'val', asc: false },
            catPerf: { col: 'val', asc: false },
            outlets: { col: 'val', asc: false },
            modal: { col: 'val', asc: false }
        };

        function setSort(table, col) {
            if (sortState[table].col === col) {
                sortState[table].asc = !sortState[table].asc;
            } else {
                sortState[table].col = col;
                sortState[table].asc = false;
            }

            if (table === 'modal') {
                if (currentOpenStoreId) showStoreDetails(currentOpenStoreId);
            } else {
                renderDashboard();
            }
        }

        async function init() {
            try {
                // Fetch both data files
                const [resAnalysis, resMgmt] = await Promise.all([
                    fetch('product_analysis_data.json?t=' + Date.now()),
                    fetch('management_data.json?t=' + Date.now())
                ]);

                if (!resAnalysis.ok || !resMgmt.ok) throw new Error("Failed to load data");

                rawData = await resAnalysis.json();
                const mgmtData = await resMgmt.json();
                storeMeta = mgmtData.store_meta || {};

                // Update Badge for period
                const meta = rawData.metadata || {};
                const periodText = `${meta.period_start} Ø¥Ù„Ù‰ ${meta.period_end}`;
                document.getElementById('periodDisplay').textContent = periodText;

                // Default to MTD
                switchPeriod('mtd');

                // Check Role & Init Filters
                setupFilters(mgmtData);

            } catch (e) {
                console.error(e);
                alert("ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª. Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ØªØ´ØºÙŠÙ„ Ø§Ù„ØªØ­Ø¯ÙŠØ«.");
            }
        }

        function setupFilters(mgmtData) {
            const role = (currentUser.role || 'guest').toLowerCase().replace(' ', '_');
            // Normalize: 'Sales Manager' -> 'sales_manager', 'Admin' -> 'admin'
            console.log("Normalized Role:", role);

            // Check aliases
            const allowed = ['admin', 'sales_manager', 'manager', 'salesmanager'];

            if (allowed.includes(role) || role.includes('admin') || role.includes('manager')) {
                const regSel = document.getElementById('regionFilter');
                const storeSel = document.getElementById('storeFilter');

                regSel.style.display = 'inline-block';
                storeSel.style.display = 'inline-block';

                // Populate Regions
                const regions = new Set();
                const stores = [];

                // Use Analysis MTD as the source of truth for "Active Stores"
                // storeMeta might contain IDs with no names, or old stores.
                // data.analysis_mtd contains { storeId: { store_name: "..." } }

                const sourceData = rawData.analysis_mtd || {};

                Object.keys(sourceData).forEach(sid => {
                    const storeObj = sourceData[sid];
                    const m = storeMeta[sid] || {};

                    // Prefer name from data (it's usually correct), then meta, then ID
                    const sName = storeObj.store_name || m.name_ar || m.name || sid;

                    const region = m.region; // Region usually comes from meta

                    if (region) regions.add(region);

                    stores.push({ id: sid, name: sName, region: region });
                });

                // Fill Region
                const sortedRegions = Array.from(regions).sort();
                sortedRegions.forEach(r => {
                    const opt = document.createElement('option');
                    opt.value = r;
                    opt.textContent = `ğŸ“ ${r}`;
                    regSel.appendChild(opt);
                });

                // Fill Store
                populateStoreFilter(stores);
            }
        }

        function populateStoreFilter(stores) {
            const storeSel = document.getElementById('storeFilter');
            storeSel.innerHTML = '<option value="all">ğŸª ÙƒÙ„ Ø§Ù„Ù…Ø¹Ø§Ø±Ø¶</option>';

            stores.sort((a, b) => a.name.localeCompare(b.name));
            stores.forEach(s => {
                const opt = document.createElement('option');
                opt.value = s.id;
                opt.textContent = s.name;
                storeSel.appendChild(opt);
            });
        }

        function applyFilters() {
            activeRegion = document.getElementById('regionFilter').value;
            activeStore = document.getElementById('storeFilter').value;

            // If Region changed, maybe filter stores? optional UX improvement
            // For now specific Logic:
            renderDashboard();
        }

        function switchPeriod(mode) {
            currentMode = mode; // Update global mode
            const meta = rawData.metadata || {};
            const lbl = document.getElementById('currentPeriodLabel');

            // Reset Data
            if (mode === 'mtd') {
                currentData = rawData.analysis_mtd;
                lbl.textContent = `Ø§Ù„ÙØªØ±Ø©: ${meta.period_start} Ø¥Ù„Ù‰ ${meta.period_end}`;
                document.getElementById('topCatLabel').textContent = "Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ";
            } else if (mode === 'yest') {
                currentData = rawData.analysis_yest;
                lbl.textContent = `Ø§Ù„ÙØªØ±Ø©: ${meta.yesterday_date} (ÙŠÙˆÙ… Ø£Ù…Ø³ ÙÙ‚Ø·)`;
                document.getElementById('topCatLabel').textContent = "ÙŠÙˆÙ… Ø£Ù…Ø³";
            } else {
                // Future implementation for 7d, 14d, 30d
                // For NOW, we fallback to MTD data but showing filtering simulation logic if we had daily data
                // Since we don't have real 7d data json, we will use MTD as placeholder but warn user
                currentData = rawData.analysis_mtd;
                let days = mode === '7d' ? 7 : (mode === '14d' ? 14 : 30);
                lbl.textContent = `Ø¢Ø®Ø± ${days} ÙŠÙˆÙ… (Ø¨ÙŠØ§Ù†Ø§Øª ØªØ¬Ø±ÙŠØ¨ÙŠØ© MTD)`;
                document.getElementById('topCatLabel').textContent = `Ø¢Ø®Ø± ${days} ÙŠÙˆÙ…`;
            }

            renderDashboard();
        }

        function toggleMetric() {
            const isChecked = document.getElementById('metricToggle').checked;
            currentMetric = isChecked ? 'val' : 'qty';
            document.getElementById('metricLabel').textContent = isChecked ? 'ğŸ’° Ø§Ù„Ù‚ÙŠÙ…Ø© (Value)' : 'ğŸ“¦ Ø§Ù„ÙƒÙ…ÙŠØ© (Qty)';

            // Auto update sorts to match metric for better UX
            sortState.topProd.col = currentMetric;
            sortState.catPerf.col = currentMetric;
            sortState.outlets.col = currentMetric;

            renderDashboard();
        }

        function renderDashboard() {
            processGlobalStats(currentMode); // Pass current mode
            renderOutletsTable();
            renderMarketBasketTable();

            // Re-apply search if exists
            handleSearch();
        }

        // ... (Existing Functions) ...

        function renderMarketBasketTable() {
            const tbody = document.getElementById('marketBasketBody');
            tbody.innerHTML = '';

            const allBasketData = rawData.market_basket || {};
            let basketData = allBasketData[activeStore] || [];

            // If activeStore is 'all', use global 'all' key
            if (activeStore === 'all') {
                basketData = allBasketData['all'] || [];
            }

            // If specific store selected but no data found (empty list or undefined)
            if (activeStore !== 'all' && (!basketData || basketData.length === 0)) {
                // Try falling back to global? No, user wants specific.
                // Just show empty message
                tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ù†Ù…Ø§Ø· Ø´Ø±Ø§Ø¦ÙŠØ© ÙƒØ§ÙÙŠØ© Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…Ø¹Ø±Ø¶ ØªØ­Ø¯ÙŠØ¯Ø§Ù‹</td></tr>';
                return;
            }

            if (basketData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ÙƒØ§ÙÙŠØ© Ù„Ù„ØªØ­Ù„ÙŠÙ„</td></tr>';
                return;
            }

            // Show Top 20 for brevity
            basketData.slice(0, 20).forEach((pair, i) => {
                let row = `
                    <tr>
                        <td class="fw-bold">${i + 1}</td>
                        <td class="fw-bold text-primary">${pair.item_a_name} <small class="text-muted d-block font-monospace">${pair.item_a_id}</small></td>
                        <td class="fw-bold text-primary">${pair.item_b_name} <small class="text-muted d-block font-monospace">${pair.item_b_id}</small></td>
                        <td class="text-center fw-bold fs-5">${pair.frequency}</td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }

        // ...

        function openProductDetails(itemId, name, category, totalQty, totalAmt) {
            // 1. Setup Modal Header
            document.getElementById('prodModalName').textContent = name;
            document.getElementById('prodModalId').textContent = `${itemId} | ${category}`;

            // ... (Existing History Logic) ...

            // 2. Shortened Logic for brevity in replacement (keeping history generation same)
            // Check if backend provided history (Future Proofing)
            let history = [];
            if (rawData.product_daily_history && rawData.product_daily_history[itemId]) {
                history = rawData.product_daily_history[itemId];
            } else {
                // Generate Mock Data for now
                if (!mockHistoryCache[itemId]) {
                    mockHistoryCache[itemId] = generateMockHistory(totalQty, totalAmt);
                }
                history = mockHistoryCache[itemId];
            }

            // 3. Calculate KPIs (Same as before)
            history.sort((a, b) => new Date(a.date) - new Date(b.date));
            const sortedByVal = [...history].sort((a, b) => b.amount - a.amount);
            const best = sortedByVal[0] || { date: '-', amount: 0 };
            const worst = sortedByVal[sortedByVal.length - 1] || { date: '-', amount: 0 };
            const zeroDays = history.filter(d => d.qty === 0).length;

            document.getElementById('pmBestDay').textContent = best.date;
            document.getElementById('pmBestDayVal').textContent = Math.round(best.amount).toLocaleString() + ' SR';
            document.getElementById('pmWorstDay').textContent = worst.date !== '-' ? worst.date : '-';
            document.getElementById('pmWorstDayVal').textContent = worst.amount > 0 ? Math.round(worst.amount).toLocaleString() + ' SR' : '0 SR';
            document.getElementById('pmZeroDays').textContent = zeroDays + ' ÙŠÙˆÙ…';

            // 4. Trend Analysis
            const trend = calculateTrend(history);
            const alerts = detectAlerts(history);
            renderTrendUI(trend, alerts);

            // 5. Render Chart
            renderProductChart(history);

            // 6. Related Products (Market Basket)
            const relatedList = document.getElementById('modalRelatedItems');
            relatedList.innerHTML = '';

            const basketData = rawData.market_basket || [];
            // Find pairs containing this item
            const related = basketData.filter(p => p.item_a_id == itemId || p.item_b_id == itemId);

            if (related.length === 0) {
                relatedList.innerHTML = '<li class="list-group-item text-muted text-center small">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø±Ø¨Ø· Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†ØªØ¬</li>';
            } else {
                // Sort by frequency
                related.sort((a, b) => b.frequency - a.frequency);

                // Show Top 5
                related.slice(0, 5).forEach(p => {
                    const isA = (p.item_a_id == itemId);
                    const otherId = isA ? p.item_b_id : p.item_a_id;
                    const otherName = isA ? p.item_b_name : p.item_a_name;

                    let html = `
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <div>
                                <span class="fw-bold">${otherName}</span>
                                <small class="text-muted ms-2">${otherId}</small>
                            </div>
                            <span class="badge bg-primary rounded-pill">${p.frequency} Ù…Ø±Ø©</span>
                        </li>
                    `;
                    relatedList.innerHTML += html;
                });
            }

            // Show Modal
            if (!productModalObj) productModalObj = new bootstrap.Modal(document.getElementById('productModal'));
            productModalObj.show();
        }

        function handleSearch() {
            const query = document.getElementById('productSearchInput').value.toLowerCase().trim();
            const rows = document.querySelectorAll('#topProductsBody tr');

            rows.forEach(row => {
                // If it's the "No Data" row, ignore or handle differently? 
                // Actually if we hide all rows, we should show "No Filter Results"
                if (row.cells.length < 2) return;

                const catName = row.cells[0].textContent.toLowerCase();
                const prodName = row.cells[1].textContent.toLowerCase(); // Name + ID is in this cell text content essentially

                if (query === '' || catName.includes(query) || prodName.includes(query)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }

        function processGlobalStats(mode) {
            // 0. Filter Data based on Filters (Region/Store)
            let filteredKeys = Object.keys(currentData); // specific store IDs

            if (activeStore !== 'all') {
                filteredKeys = filteredKeys.filter(id => id === activeStore);
            } else if (activeRegion !== 'all') {
                filteredKeys = filteredKeys.filter(id => {
                    const m = storeMeta[id];
                    return m && m.region === activeRegion;
                });
            }

            // If user has specific store access only (currentUser.stores), filter further
            if (currentUser.stores && currentUser.stores.length > 0 && !currentUser.stores.includes('all')) {
                filteredKeys = filteredKeys.filter(id => currentUser.stores.includes(id));
            }

            // 1. Calculate Category Performance (Aggregation)
            const catMap = {}; // Cat -> {qty, amount}
            let grandTotal = 0;

            filteredKeys.forEach(storeId => {
                const store = currentData[storeId];
                if (!store) return;

                store.categories.forEach(c => {
                    if (!catMap[c.category]) {
                        catMap[c.category] = { name: c.category, qty: 0, amount: 0, share: 0 };
                    }
                    catMap[c.category].qty += c.qty;
                    catMap[c.category].amount += c.amount;
                    grandTotal += c.amount;
                });
            });

            const sortedCats = Object.values(catMap).sort((a, b) => {
                let valA = currentMetric === 'qty' ? a.qty : a.amount;
                let valB = currentMetric === 'qty' ? b.qty : b.amount;
                return valB - valA;
            });

            // Calculate share
            sortedCats.forEach(c => {
                c.share = grandTotal > 0 ? (c.amount / grandTotal * 100) : 0;
            });


            // 2. Render Categories Table
            const catBody = document.getElementById('topCategoriesBody');
            catBody.innerHTML = '';

            if (sortedCats.length === 0) {
                catBody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</td></tr>';
            } else {
                sortedCats.forEach((c, i) => {

                    // Demo Trend for Categories
                    let trendIcon = 'â–';
                    let trendClass = 'text-muted';
                    const rnd = Math.random();
                    if (rnd > 0.6) { trendIcon = 'â–²'; trendClass = 'text-success'; }
                    else if (rnd < 0.2) { trendIcon = 'â–¼'; trendClass = 'text-danger'; }

                    let row = `
                        <tr>
                            <td class="fw-bold text-center">${i + 1}</td>
                            <td class="text-center">${c.name} <span class="${trendClass} small">${trendIcon}</span></td>
                            <td dir="ltr" class="text-center ${currentMetric === 'qty' ? 'fw-bold' : ''}">${c.qty.toLocaleString()}</td>
                            <td class="fw-bold text-center ${currentMetric === 'val' ? 'fw-bold' : ''}">${Math.round(c.amount).toLocaleString()}</td>
                            <td>
                                <div class="d-flex align-items-center justify-content-center">
                                    <span class="me-2">${c.share.toFixed(1)}%</span>
                                    <div class="progress flex-grow-1" style="height: 6px; max-width: 100px;">
                                        <div class="progress-bar bg-warning" style="width: ${c.share}%"></div>
                                    </div>
                                </div>
                            </td>
                        </tr>
                    `;
                    catBody.innerHTML += row;
                });
            }

            // 3. Recalculate Top Products (Global vs Filtered)
            // Original code used 'global_mtd' pre-calculated from backend.
            // PROBLEM: Backend 'global_mtd' is GLOBAL. If we filter by Region, we can't use it directly.
            // We must re-aggregate Top Products from the filtered stores.
            // BUT: currentData (analysis_mtd) only has "Top Item" per category per store.
            // It does NOT have all items. So we can't perfectly re-calculate "Top Product globally in this region" 
            // if the top product in the region wasn't the top product in any single store.
            // However, usually the top product in a region IS top in many stores. 
            // Approximation: We will collect all 'top_item's from the filtered stores and aggregate them.

            const itemMap = {}; // ItemID -> {name, cat, qty, amount}

            filteredKeys.forEach(storeId => {
                const store = currentData[storeId];
                if (!store) return;

                store.categories.forEach(c => {
                    // We only know the top item of this category in this store
                    const tid = c.top_item_id;
                    if (tid && tid !== '-') {
                        if (!itemMap[tid]) itemMap[tid] = {
                            id: tid,
                            name: c.top_item_name,
                            category: c.category,
                            qty: 0,
                            amount: 0
                        };
                        itemMap[tid].qty += c.top_item_qty;
                        itemMap[tid].amount += c.top_item_amount;
                    }
                });
            });

            // Convert to list & Sort
            const topItems = Object.values(itemMap).sort((a, b) => {
                let valA = currentMetric === 'qty' ? a.qty : a.amount;
                let valB = currentMetric === 'qty' ? b.qty : b.amount;
                return valB - valA;
            });

            // Render Top Products
            const prodBody = document.getElementById('topProductsBody');
            prodBody.innerHTML = '';

            if (topItems.length === 0) {
                prodBody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</td></tr>';
            } else {
                // Show top 50?
                topItems.slice(0, 100).forEach(item => {
                    // Trend/Alert Simulation (Mock)
                    let trendIcon = 'â–';
                    let trendClass = 'text-muted';
                    const rnd = Math.random();
                    if (rnd > 0.7) { trendIcon = 'â–²'; trendClass = 'text-success'; }
                    else if (rnd < 0.3) { trendIcon = 'â–¼'; trendClass = 'text-danger'; }

                    let alertBadge = '';
                    if (Math.random() < 0.1) alertBadge = '<span class="badge bg-warning text-dark ms-1" style="font-size:0.6em">âš </span>';

                    let row = `
                        <tr>
                            <td class="fw-bold text-center">${item.category}</td>
                            <td class="text-center">
                                <a href="#" onclick="openProductDetails('${item.id}', '${item.name}', '${item.category}', ${item.qty}, ${item.amount}); return false;" class="text-decoration-none fw-bold text-dark hover-primary">${item.name}</a>
                                <small class="text-muted d-block">${item.id} ${alertBadge}</small>
                            </td>
                            <td dir="ltr" class="text-center ${currentMetric === 'qty' ? 'fw-bold text-primary' : ''}">${item.qty}</td>
                            <td class="text-center ${currentMetric === 'val' ? 'fw-bold text-primary' : ''}">
                                ${Math.round(item.amount).toLocaleString()}
                                <small class="${trendClass} ms-1">${trendIcon}</small>
                            </td>
                        </tr>
                    `;
                    prodBody.innerHTML += row;
                });
            }
        }
        // Pie Chart Logic Removed


        function renderOutletsTable() {
            const tbody = document.getElementById('outletsTableBody');
            tbody.innerHTML = '';

            if (!currentData || Object.keys(currentData).length === 0) {
                tbody.innerHTML = `<tr><td colspan="5" class="text-center text-muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù‡Ø°Ù‡ Ø§Ù„ÙØªØ±Ø©</td></tr>`;
                return;
            }

            // Convert to array and sort by Total Sales
            let outlets = Object.entries(currentData).map(([id, data]) => ({
                id, ...data
            }));

            // Permission Filter
            if (currentUser.role !== 'Admin') {
                outlets = outlets.filter(o => {
                    const meta = storeMeta[o.id];
                    return meta && meta.manager === currentUser.name;
                });
            }

            // Calculate Totals (Qty needed for sort)
            outlets.forEach(o => {
                let tQty = 0;
                o.categories.forEach(c => tQty += c.qty);
                o.total_qty = tQty;
            });

            // Sort
            outlets.sort((a, b) => {
                let valA = sortState.outlets.col === 'qty' ? a.total_qty : a.total_sales;
                let valB = sortState.outlets.col === 'qty' ? b.total_qty : b.total_sales;
                return sortState.outlets.asc ? valA - valB : valB - valA;
            });

            outlets.forEach((o, i) => {
                // Find top category
                let topCat = o.categories.length > 0 ? o.categories[0] : null;
                let topCatStr = topCat ? `${topCat.category} (${Math.round(topCat.amount).toLocaleString()})` : '-';

                let row = `
                    <tr onclick="showStoreDetails('${o.id}')">
                        <td>${i + 1}</td>
                        <td class="fw-bold">${o.store_name}</td>
                        <td dir="ltr" class="text-center">${o.total_qty.toLocaleString()}</td>
                        <td class="text-success fw-bold">${o.total_sales.toLocaleString()}</td>
                        <td class="text-muted small">${topCatStr}</td>
                        <td><button class="btn btn-sm btn-outline-primary">Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„</button></td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }

        function showStoreDetails(storeId) {
            currentOpenStoreId = storeId;
            const meta = storeMeta[storeId] || {};

            document.getElementById('modalTitle').textContent = `ØªÙØ§ØµÙŠÙ„ Ù…Ø¹Ø±Ø¶: ${meta.name_ar || meta.name || storeId}`;

            // Filter categories for this store
            const storeData = currentData[storeId];
            if (!storeData) return;

            // Sort logic (same as before)
            // ... (omitted for brevity, keeping existing sort logic is handled by renderDashboard usually, but here we do ad-hoc)
            // Actually existing code does rendering here. Let's just fix the modal call.

            // Copying existing logic briefly to ensure I don't break sorting/rendering:
            const tbody = document.getElementById('modalTableBody');
            tbody.innerHTML = '';

            let cats = [...storeData.categories];
            // Sort
            if (sortState.modal.col === 'qty') {
                cats.sort((a, b) => sortState.modal.asc ? a.qty - b.qty : b.qty - a.qty);
            } else {
                cats.sort((a, b) => sortState.modal.asc ? a.amount - b.amount : b.amount - a.amount);
            }

            cats.forEach(cat => {
                let row = `
                    <tr>
                        <td class="fw-bold text-center">${cat.category}</td>
                        <td dir="ltr" class="text-center ${currentMetric === 'qty' ? 'bg-light fw-bold' : ''}">${cat.qty}</td>
                        <td class="text-center ${currentMetric === 'val' ? 'bg-light fw-bold' : ''}">${cat.amount.toLocaleString()}</td>
                        <td class="text-center">
                            <a href="#" onclick="openProductDetails('${cat.top_item_id}', '${cat.top_item_name}', '${cat.category}', ${cat.top_item_qty}, ${cat.top_item_amount}); return false;" class="text-decoration-none fw-bold text-dark small d-block text-truncate hover-primary" style="max-width: 200px; margin: 0 auto;" title="${cat.top_item_name}">${cat.top_item_name}</a>
                            <small class="text-muted d-block" style="font-size: 0.75em;">${cat.top_item_id}</small>
                        </td>
                        <td dir="ltr" class="text-center small">${cat.top_item_qty}</td>
                        <td class="text-center small fw-bold">${cat.top_item_amount.toLocaleString()}</td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });

            if (!detailsModalObj) detailsModalObj = new bootstrap.Modal(document.getElementById('detailsModal'));
            detailsModalObj.show();
        }

        // ==========================================
        // PRODUCT DETAILS LOGIC
        // ==========================================

        function openProductDetails(itemId, name, category, totalQty, totalAmt) {
            // 1. Setup Modal Header
            document.getElementById('prodModalName').textContent = name;
            document.getElementById('prodModalId').textContent = `${itemId} | ${category}`;

            // 2. Get or Generate History
            // Check if backend provided history (Future Proofing)
            let history = [];
            if (rawData.product_daily_history && rawData.product_daily_history[itemId]) {
                history = rawData.product_daily_history[itemId];
            } else {
                // Generate Mock Data for now
                if (!mockHistoryCache[itemId]) {
                    mockHistoryCache[itemId] = generateMockHistory(totalQty, totalAmt);
                }
                history = mockHistoryCache[itemId];
            }

            // 3. Calculate KPIs
            // Sort by Date
            history.sort((a, b) => new Date(a.date) - new Date(b.date));

            // Best/Worst Day
            // Sort by sales value
            const sortedByVal = [...history].sort((a, b) => b.amount - a.amount);
            const best = sortedByVal[0] || { date: '-', amount: 0 };
            const worst = sortedByVal[sortedByVal.length - 1] || { date: '-', amount: 0 };

            // Zero Days
            const zeroDays = history.filter(d => d.qty === 0).length;

            document.getElementById('pmBestDay').textContent = best.date;
            document.getElementById('pmBestDayVal').textContent = Math.round(best.amount).toLocaleString() + ' SR';

            document.getElementById('pmWorstDay').textContent = worst.date !== '-' ? worst.date : '-';
            document.getElementById('pmWorstDayVal').textContent = worst.amount > 0 ? Math.round(worst.amount).toLocaleString() + ' SR' : '0 SR';

            document.getElementById('pmZeroDays').textContent = zeroDays + ' ÙŠÙˆÙ…';

            // 4. Trend Analysis
            const trend = calculateTrend(history);
            const alerts = detectAlerts(history);
            renderTrendUI(trend, alerts);

            // 5. Render Chart
            renderProductChart(history);

            // 6. Related Products (Market Basket)
            const relatedList = document.getElementById('modalRelatedItems');
            relatedList.innerHTML = '';

            const allBasketData = rawData.market_basket || {};
            // Select Dataset based on Active Store Filter
            let basketData = allBasketData[activeStore] || [];

            if (activeStore === 'all') {
                basketData = allBasketData['all'] || [];
            }

            // Find pairs containing this item
            const related = basketData.filter(p => p.item_a_id == itemId || p.item_b_id == itemId);

            if (related.length === 0) {
                relatedList.innerHTML = '<li class="list-group-item text-muted text-center small">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø±Ø¨Ø· Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†ØªØ¬</li>';
            } else {
                // Sort by frequency
                related.sort((a, b) => b.frequency - a.frequency);

                // Show Top 5
                related.slice(0, 5).forEach(p => {
                    const isA = (p.item_a_id == itemId);
                    const otherId = isA ? p.item_b_id : p.item_a_id;
                    const otherName = isA ? p.item_b_name : p.item_a_name;

                    let html = `
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <div>
                                <span class="fw-bold">${otherName}</span>
                                <small class="text-muted ms-2">${otherId}</small>
                            </div>
                            <span class="badge bg-primary rounded-pill">${p.frequency} Ù…Ø±Ø©</span>
                        </li>
                    `;
                    relatedList.innerHTML += html;
                });
            }

            // Show Modal
            if (!productModalObj) productModalObj = new bootstrap.Modal(document.getElementById('productModal'));
            productModalObj.show();
        }

        function generateMockHistory(totalQty, totalAmount) {
            // Generate data for approx 30 days or current range
            let days = 30;
            if (currentMode === '7d') days = 7;
            if (currentMode === '14d') days = 14;

            const history = [];
            const today = new Date();

            // Random distribution but summing up roughly to totals
            // Simplified: just random variations
            let remainingQty = totalQty;
            let avgPrice = totalQty > 0 ? (totalAmount / totalQty) : 0;

            for (let i = days - 1; i >= 0; i--) {
                let d = new Date();
                d.setDate(today.getDate() - i);
                let dateStr = d.toISOString().split('T')[0];

                // Randomize
                // Make some days 0 to test alerts
                let isZero = Math.random() < 0.2;
                let dailyQty = isZero ? 0 : Math.ceil((totalQty / days) * (0.5 + Math.random()));

                let dailyAmt = dailyQty * avgPrice;

                history.push({
                    date: dateStr,
                    qty: dailyQty,
                    amount: dailyAmt
                });
            }
            return history;
        }

        function calculateTrend(history) {
            if (history.length < 5) return 'STABLE';

            // LAST DAY vs AVG LAST 5
            const lastDay = history[history.length - 1];
            const last5 = history.slice(-6, -1); // prev 5 days excluding today(last)? Or just last 5.
            // Let's compare Last Day vs Average of Previous 5 days (excluding last day)
            // If we only have 5 days, take prev 4.

            if (last5.length === 0) return 'STABLE';

            const avgPrev = last5.reduce((sum, d) => sum + d.amount, 0) / last5.length;
            const diff = lastDay.amount - avgPrev;
            const pct = avgPrev > 0 ? (diff / avgPrev) * 100 : 0;

            if (pct > 15) return 'UP';
            if (pct < -15) return 'DOWN';
            return 'STABLE';
        }

        function detectAlerts(history) {
            // Simple alerts
            const alerts = [];

            // Spike detection
            // If last day is > 200% of average
            if (history.length > 5) {
                const avg = history.reduce((s, d) => s + d.amount, 0) / history.length;
                const last = history[history.length - 1];
                if (avg > 0 && last.amount > avg * 2.5) {
                    alerts.push({ type: 'spike', msg: 'Ø§Ø±ØªÙØ§Ø¹ Ù…ÙØ§Ø¬Ø¦ ÙÙŠ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª' });
                }
                if (avg > 100 && last.amount === 0) {
                    alerts.push({ type: 'drop', msg: 'ØªÙˆÙ‚Ù Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª ÙØ¬Ø£Ø©' });
                }
            }
            return alerts;
        }

        function renderTrendUI(trend, alerts) {
            const box = document.getElementById('trendAlertBox');
            const icon = document.getElementById('trendIcon');
            const text = document.getElementById('trendText');

            box.className = 'alert d-flex align-items-center mb-0'; // reset

            let html = '';

            if (trend === 'UP') {
                box.classList.add('alert-success');
                icon.innerHTML = 'ğŸ’¹';
                html = 'Ø£Ø¯Ø§Ø¡ <strong>Ù…ØªØµØ§Ø¹Ø¯</strong> Ù…Ù‚Ø§Ø±Ù†Ø© Ø¨Ø§Ù„Ø£ÙŠØ§Ù… Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©.';
            } else if (trend === 'DOWN') {
                box.classList.add('alert-danger');
                icon.innerHTML = 'ğŸ”»';
                html = 'Ø£Ø¯Ø§Ø¡ <strong>Ù…ØªØ±Ø§Ø¬Ø¹</strong> Ù…Ù‚Ø§Ø±Ù†Ø© Ø¨Ø§Ù„Ù…ØªÙˆØ³Ø·.';
            } else {
                box.classList.add('alert-secondary');
                icon.innerHTML = 'â–';
                html = 'Ø£Ø¯Ø§Ø¡ <strong>Ù…Ø³ØªÙ‚Ø±</strong> Ø·Ø¨ÙŠØ¹ÙŠ.';
            }

            // Append Alerts
            if (alerts.length > 0) {
                html += '<div class="mt-1 border-top pt-1">';
                alerts.forEach(a => {
                    html += `<div class="badge bg-warning text-dark me-1">âš ï¸ ${a.msg}</div>`;
                });
                html += '</div>';
            }

            text.innerHTML = html;
        }

        function renderProductChart(history) {
            const ctx = document.getElementById('productTrendChart').getContext('2d');

            // Destroy OLD chart if exists
            if (window.prodChart) {
                window.prodChart.destroy();
            }

            if (!history || history.length === 0) {
                document.getElementById('productTrendChart').style.display = 'none';
                document.getElementById('chartNoDataMsg').classList.remove('d-none');
                return;
            } else {
                document.getElementById('productTrendChart').style.display = 'block';
                document.getElementById('chartNoDataMsg').classList.add('d-none');
            }

            const labels = history.map(d => d.date); // e.g., '2025-02-20'
            const dataVal = history.map(d => currentMetric === 'qty' ? d.qty : d.amount);
            const labelStr = currentMetric === 'qty' ? 'Ø§Ù„ÙƒÙ…ÙŠØ©' : 'Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª';
            const color = currentMetric === 'qty' ? '#0d6efd' : '#fe7900'; // Blue for Qty, Orange for Sales

            window.prodChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: labelStr,
                        data: dataVal,
                        borderColor: color,
                        backgroundColor: color + '20', // transparent version
                        fill: true,
                        tension: 0.3,
                        pointRadius: 3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    return context.parsed.y.toLocaleString() + (currentMetric === 'qty' ? ' Pcs' : ' SR');
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { borderDash: [2, 2] }
                        },
                        x: {
                            grid: { display: false },
                            ticks: {
                                maxTicksLimit: 7
                            }
                        }
                    }
                }
            });
        }

        // ==========================================
        // CATALOG / ACCORDION SEARCH LOGIC
        // ==========================================

        function openCatalogModal() {
            renderCatalog();
            if (!catalogModalObj) catalogModalObj = new bootstrap.Modal(document.getElementById('catalogModal'));
            catalogModalObj.show();
        }

        function closeCatalogAndOpenProduct(id, name, cat, qty, amt) {
            // Close catalog first
            if (catalogModalObj) catalogModalObj.hide();

            // Small delay to allow transition? Bootstrap usually handles swapping fine, but safe side.
            setTimeout(() => {
                openProductDetails(id, name, cat, qty, amt);
            }, 150);
        }

        function renderCatalog(filter = '') {
            const container = document.getElementById('categoryAccordion');
            container.innerHTML = '';

            const catalog = rawData.product_catalog || {};
            // If no catalog data (e.g. unexpected missing backend update), try to build from currentData
            // But currentData is limited. Best to check if catalog exists or warn.

            const categories = Object.keys(catalog).sort();

            if (categories.length === 0) {
                container.innerHTML = '<div class="text-center text-muted p-4">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ÙÙ‡Ø±Ø³ Ù…ØªØ§Ø­Ø© Ø­Ø§Ù„ÙŠØ§Ù‹ - Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±.</div>';
                return;
            }

            let hasMatches = false;
            filter = filter.toLowerCase();

            categories.forEach((cat, index) => {
                const items = catalog[cat];

                // Filter items
                const filteredItems = items.filter(item => {
                    return filter === '' ||
                        item.name.toLowerCase().includes(filter) ||
                        item.id.includes(filter) ||
                        cat.toLowerCase().includes(filter); // If cat matches, show all? Or just items?
                    // Let's say: If Cat matches, show all items. If Item match, show item.
                });

                // If filter is active and cat name matches, we can show ALL items, or just continue filtering items?
                // User requirement: "Search category... display category... click to open items".
                // If I type "Accessory", I expect to see "Accessories" category.
                // If I type "iPhone", I expect to see "Phones" category expanded with iPhone inside.

                const isCatMatch = cat.toLowerCase().includes(filter);
                const showItems = isCatMatch ? items : filteredItems; // If cat matches, show ALL. Else show filtered.

                if (showItems.length === 0) return; // Skip empty categories

                hasMatches = true;

                // Unique IDs for accordion
                const headerId = `heading${index}`;
                const collapseId = `collapse${index}`;

                // Auto-expand if filter is active
                const isExpanded = filter !== '';
                const btnClass = isExpanded ? '' : 'collapsed';
                const divClass = isExpanded ? 'show' : '';

                let itemsHtml = '<ul class="list-group list-group-flush">';
                showItems.forEach(item => {
                    // Item Row
                    itemsHtml += `
                    <li class="list-group-item list-group-item-action d-flex justify-content-between align-items-center" 
                        role="button"
                        onclick="closeCatalogAndOpenProduct('${item.id}', '${item.name}', '${cat}', ${item.qty}, ${item.amount})">
                        <div>
                            <div class="fw-bold text-dark">${item.name}</div>
                            <small class="text-muted">${item.id}</small>
                        </div>
                        <div class="text-end">
                            <div class="badge bg-light text-dark border">${item.qty} pcs</div>
                            <div class="fw-bold small text-primary">${Math.round(item.amount).toLocaleString()}</div>
                        </div>
                    </li>
                `;
                });
                itemsHtml += '</ul>';

                const accordionItem = `
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="${headerId}">
                            <button class="accordion-button ${btnClass} fw-bold" type="button" data-bs-toggle="collapse" data-bs-target="#${collapseId}" aria-expanded="${isExpanded}" aria-controls="${collapseId}">
                                ${cat} 
                                <span class="badge bg-secondary ms-2 rounded-pill">${showItems.length} Ù…Ù†ØªØ¬</span>
                            </button>
                        </h2>
                        <div id="${collapseId}" class="accordion-collapse collapse ${divClass}" aria-labelledby="${headerId}" data-bs-parent="#categoryAccordion">
                            <div class="accordion-body p-0">
                                ${itemsHtml}
                            </div>
                        </div>
                    </div>
                `;

                container.innerHTML += accordionItem;
            });

            const noDataMsg = document.getElementById('catalogNoData');
            if (!hasMatches) {
                noDataMsg.classList.remove('d-none');
            } else {
                noDataMsg.classList.add('d-none');
            }
        }

        function filterCatalog() {
            const query = document.getElementById('catalogSearch').value;
            renderCatalog(query);
        }

        // Run
        init();

    </script>
</body>

</html>