<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Orange | ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</title>

    <!-- Bootstrap 5 RTL -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">

    <style>
        :root {
            --bs-primary: #fe7900;
            --bs-secondary: #6c757d;
            --bg-light: #f8f9fa;
            --card-radius: 12px;
            --font-main: 'Tajawal', sans-serif;
        }

        body {
            font-family: var(--font-main);
            background-color: var(--bg-light);
            color: #212529;
        }

        .navbar {
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            background: white !important;
        }

        .navbar-brand {
            font-weight: 800;
            color: #000 !important;
        }

        .brand-orange {
            color: #fe7900;
        }

        .card-custom {
            background: white;
            border: none;
            border-radius: var(--card-radius);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.03);
            margin-bottom: 20px;
        }

        .section-title {
            font-weight: 700;
            margin-bottom: 20px;
            border-right: 4px solid #fe7900;
            padding-right: 10px;
        }

        .table-custom thead th {
            background-color: #fe7900;
            color: white;
            font-weight: 500;
            border: none;
        }

        .table-hover tbody tr:hover {
            background-color: #fff3e0;
            cursor: pointer;
        }
    </style>
</head>

<body>

    <!-- Navbar -->
    <nav class="navbar mb-4 sticky-top">
        <div class="container-fluid">
            <span class="navbar-brand"><span class="brand-orange">ORANGE</span> PRODUCT ANALYSIS</span>
            <div class="d-flex gap-2 align-items-center">
                <span class="badge bg-light text-dark border" id="periodDisplay">...</span>
                <a href="index.html" class="btn btn-outline-secondary btn-sm fw-bold">
                    ğŸ  Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
                </a>
                <button onclick="logout()" class="btn btn-danger btn-sm fw-bold">Ø®Ø±ÙˆØ¬</button>
            </div>
        </div>
    </nav>

    <script src="users.js"></script>
    <script>
        const currentUser = JSON.parse(localStorage.getItem('currentUser'));
        if (!currentUser) {
            window.location.href = 'login.html';
        }

        function logout() {
            localStorage.removeItem('currentUser');
            window.location.href = 'login.html';
        }
    </script>

    <div class="container-fluid px-4">

        <!-- Controls -->
        <div class="row align-items-center mb-4">
            <div class="col-md-6">
                <!-- Period Toggle -->
                <div class="btn-group" role="group" aria-label="Period Toggle">
                    <input type="radio" class="btn-check" name="periodbtn" id="btnMtd" autocomplete="off" checked
                        onchange="switchPeriod('mtd')">
                    <label class="btn btn-outline-primary fw-bold" for="btnMtd">ğŸ“… Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ (MTD)</label>

                    <input type="radio" class="btn-check" name="periodbtn" id="btnYest" autocomplete="off"
                        onchange="switchPeriod('yest')">
                    <label class="btn btn-outline-primary fw-bold" for="btnYest">â³ ÙŠÙˆÙ… Ø£Ù…Ø³ (Yesterday)</label>
                </div>
            </div>
            <div class="col-md-6 text-end">
                <h5 class="section-title mb-0" id="currentPeriodLabel">...</h5>
            </div>
        </div>

        <!-- Summary Section -->
        <h5 class="section-title">Ù…Ù„Ø®Øµ Ø£Ø¯Ø§Ø¡ Ø§Ù„ÙØ¦Ø§Øª ÙˆØ§Ù„Ù…Ù†ØªØ¬Ø§Øª (Category & Product Performance)</h5>
        <div class="row mb-4">
            <!-- Top Products per Category -->
            <div class="col-md-6">
                <div class="card-custom p-3" style="height: 450px; overflow-y: auto;">
                    <h6 class="text-muted fw-bold mb-3">Ø§Ù„Ù…Ù†ØªØ¬ Ø§Ù„Ø£ÙƒØ«Ø± Ù…Ø¨ÙŠØ¹Ø§Ù‹ Ø­Ø³Ø¨ Ø§Ù„ÙØ¦Ø© (Top Product by Category)</h6>
                    <table class="table table-sm align-middle table-hover">
                        <thead class="table-light sticky-top" style="top: 0; z-index: 1;">
                            <tr>
                                <th>Ø§Ù„ØªØµÙ†ÙŠÙ</th>
                                <th>Ø±Ù‚Ù… Ø§Ù„Ù…Ù†ØªØ¬ (Item ID)</th>
                                <th>Ø§Ù„ÙƒÙ…ÙŠØ©</th>
                                <th>Ø§Ù„Ù‚ÙŠÙ…Ø©</th>
                            </tr>
                        </thead>
                        <tbody id="topProductsBody">
                            <!-- JS -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Top Categories List (Existing) -->
            <div class="col-md-6">
                <div class="card-custom p-3" style="height: 450px; overflow-y: auto;">
                    <h6 class="text-muted fw-bold mb-3">Ø£Ø¯Ø§Ø¡ Ø§Ù„ÙØ¦Ø§Øª (Category Performance) - <span
                            id="topCatLabel"></span></h6>
                    <table class="table table-sm align-middle">
                        <thead class="table-light sticky-top" style="top: 0; z-index: 1;">
                            <tr>
                                <th>#</th>
                                <th>Ø§Ù„ØªØµÙ†ÙŠÙ</th>
                                <th>Ø§Ù„ÙƒÙ…ÙŠØ©</th>
                                <th>Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</th>
                                <th>Ù…Ø³Ø§Ù‡Ù…Ø© %</th>
                            </tr>
                        </thead>
                        <tbody id="topCategoriesBody">
                            <!-- JS -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Outlets Table -->
        <h5 class="section-title">ØªÙØ§ØµÙŠÙ„ Ø§Ù„ÙØ±ÙˆØ¹ (Outlets Breakdown)</h5>
        <div class="card-custom p-3">
            <div class="table-responsive">
                <table class="table table-custom table-hover align-middle">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Ø§Ù„ÙØ±Ø¹ (Outlet)</th>
                            <th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª (Total Sales)</th>
                            <th>Ø£Ø¹Ù„Ù‰ ØªØµÙ†ÙŠÙ Ù…Ø¨ÙŠØ¹Ø§Ù‹ (Top Category)</th>
                            <th>Ø¥Ø¬Ø±Ø§Ø¡</th>
                        </tr>
                    </thead>
                    <tbody id="outletsTableBody">
                        <!-- JS -->
                    </tbody>
                </table>
            </div>
        </div>

    </div>

    <!-- Details Modal -->
    <div class="modal fade" id="detailsModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-light">
                    <h5 class="modal-title fw-bold" id="modalTitle">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="table-responsive">
                        <table class="table table-hover table-striped mb-0">
                            <thead class="table-dark">
                                <tr>
                                    <th class="text-center">Ø§Ù„ØªØµÙ†ÙŠÙ (Category)</th>
                                    <th class="text-center">Ø§Ù„ÙƒÙ…ÙŠØ© (Qty)</th>
                                    <th class="text-center">Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª (Amount)</th>
                                    <th class="text-center" style="width: 30%;">Ø£Ø¹Ù„Ù‰ Ù…Ù†ØªØ¬ (Top Product)</th>
                                    <th class="text-center">Q</th>
                                    <th class="text-center">V</th>
                                </tr>
                            </thead>
                            <tbody id="modalTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        let rawData = null;
        let currentData = null; // Filtered subset (analysis_mtd or analysis_yest)
        let currentMode = 'mtd'; // Track active mode
        let chartInstance = null;

        let storeMeta = {};

        async function init() {
            try {
                // Fetch both data files
                const [resAnalysis, resMgmt] = await Promise.all([
                    fetch('product_analysis_data.json?t=' + Date.now()),
                    fetch('management_data.json?t=' + Date.now())
                ]);

                if (!resAnalysis.ok || !resMgmt.ok) throw new Error("Failed to load data");

                rawData = await resAnalysis.json();
                const mgmtData = await resMgmt.json();
                storeMeta = mgmtData.store_meta || {};

                // Update Badge for period
                const meta = rawData.metadata || {};
                const periodText = `${meta.period_start} Ø¥Ù„Ù‰ ${meta.period_end}`;
                document.getElementById('periodDisplay').textContent = periodText;

                // Default to MTD
                switchPeriod('mtd');

            } catch (e) {
                console.error(e);
                alert("ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª. Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ØªØ´ØºÙŠÙ„ Ø§Ù„ØªØ­Ø¯ÙŠØ«.");
            }
        }

        function switchPeriod(mode) {
            currentMode = mode; // Update global mode
            const meta = rawData.metadata || {};

            if (mode === 'mtd') {
                currentData = rawData.analysis_mtd;
                document.getElementById('currentPeriodLabel').textContent = `Ø§Ù„ÙØªØ±Ø©: ${meta.period_start} Ø¥Ù„Ù‰ ${meta.period_end}`;
                document.getElementById('topCatLabel').textContent = "Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ";
            } else {
                currentData = rawData.analysis_yest;
                document.getElementById('currentPeriodLabel').textContent = `Ø§Ù„ÙØªØ±Ø©: ${meta.yesterday_date} (ÙŠÙˆÙ… Ø£Ù…Ø³ ÙÙ‚Ø·)`;
                document.getElementById('topCatLabel').textContent = "ÙŠÙˆÙ… Ø£Ù…Ø³";
            }

            renderDashboard();
        }

        function renderDashboard() {
            processGlobalStats(currentMode); // Pass current mode
            renderOutletsTable();
        }

        function processGlobalStats(mode) {
            // mode is 'mtd' or 'yest'
            let globalTopItems = [];
            if (mode === 'mtd') {
                globalTopItems = rawData.global_mtd || [];
            } else {
                globalTopItems = rawData.global_yest || [];
            }

            // 1. Render Top Products per Category
            const prodBody = document.getElementById('topProductsBody');
            prodBody.innerHTML = '';

            if (globalTopItems.length === 0) {
                prodBody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</td></tr>';
            } else {
                globalTopItems.forEach(item => {
                    let row = `
                        <tr>
                            <td class="fw-bold text-center">${item.category}</td>
                            <td class="text-center">
                                <div class="fw-bold text-dark">${item.top_item_name}</div>
                                <small class="text-muted">${item.top_item_id}</small>
                            </td>
                            <td dir="ltr" class="text-center">${item.top_item_qty}</td>
                            <td class="fw-bold text-center">${Math.round(item.top_item_amount).toLocaleString()}</td>
                        </tr>
                    `;
                    prodBody.innerHTML += row;
                });
            }

            // 2. Render Top Categories List (Existing Logic)
            const globalCats = {};
            let totalSales = 0;

            if (currentData) {
                Object.values(currentData).forEach((store, idx) => {
                    const storeId = Object.keys(currentData)[idx]; // Need ID to check meta

                    // Filter for Global Stats too
                    if (currentUser.role !== 'Admin') {
                        const meta = storeMeta[storeId];
                        if (!meta || meta.manager !== currentUser.name) return;
                    }

                    store.categories.forEach(cat => {
                        if (!globalCats[cat.category]) {
                            globalCats[cat.category] = { qty: 0, amount: 0 };
                        }
                        globalCats[cat.category].qty += cat.qty;
                        globalCats[cat.category].amount += cat.amount;
                        totalSales += cat.amount;
                    });
                });
            }

            // Convert to Array
            const sortedCats = Object.entries(globalCats).map(([name, data]) => ({
                name,
                ...data,
                share: totalSales > 0 ? (data.amount / totalSales * 100) : 0
            })).sort((a, b) => b.amount - a.amount);

            // Render Table
            const catBody = document.getElementById('topCategoriesBody');
            catBody.innerHTML = '';

            if (sortedCats.length === 0) {
                catBody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</td></tr>';
            } else {
                sortedCats.forEach((c, i) => {
                    let row = `
                        <tr>
                            <td class="fw-bold text-center">${i + 1}</td>
                            <td class="text-center">${c.name}</td>
                            <td dir="ltr" class="text-center">${c.qty.toLocaleString()}</td>
                            <td class="fw-bold text-center">${Math.round(c.amount).toLocaleString()}</td>
                            <td>
                                <div class="d-flex align-items-center justify-content-center">
                                    <span class="me-2">${c.share.toFixed(1)}%</span>
                                    <div class="progress flex-grow-1" style="height: 6px; max-width: 100px;">
                                        <div class="progress-bar bg-warning" style="width: ${c.share}%"></div>
                                    </div>
                                </div>
                            </td>
                        </tr>
                    `;
                    catBody.innerHTML += row;
                });
            }

            // Pie Chart Logic Removed
        }

        function renderOutletsTable() {
            const tbody = document.getElementById('outletsTableBody');
            tbody.innerHTML = '';

            if (!currentData || Object.keys(currentData).length === 0) {
                tbody.innerHTML = `<tr><td colspan="5" class="text-center text-muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù‡Ø°Ù‡ Ø§Ù„ÙØªØ±Ø©</td></tr>`;
                return;
            }

            // Convert to array and sort by Total Sales
            let outlets = Object.entries(currentData).map(([id, data]) => ({
                id, ...data
            }));

            // Permission Filter
            if (currentUser.role !== 'Admin') {
                outlets = outlets.filter(o => {
                    const meta = storeMeta[o.id];
                    return meta && meta.manager === currentUser.name;
                });
            }

            outlets.sort((a, b) => b.total_sales - a.total_sales);

            outlets.forEach((o, i) => {
                // Find top category
                let topCat = o.categories.length > 0 ? o.categories[0] : null;
                let topCatStr = topCat ? `${topCat.category} (${Math.round(topCat.amount).toLocaleString()})` : '-';

                let row = `
                    <tr onclick="showStoreDetails('${o.id}')">
                        <td>${i + 1}</td>
                        <td class="fw-bold">${o.store_name}</td>
                        <td class="text-success fw-bold">${o.total_sales.toLocaleString()}</td>
                        <td class="text-muted small">${topCatStr}</td>
                        <td><button class="btn btn-sm btn-outline-primary">Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„</button></td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }

        function showStoreDetails(storeId) {
            const store = currentData[storeId];
            if (!store) return;

            document.getElementById('modalTitle').textContent = `ØªÙØ§ØµÙŠÙ„: ${store.store_name}`;
            const tbody = document.getElementById('modalTableBody');
            tbody.innerHTML = '';

            store.categories.forEach(cat => {
                let row = `
                    <tr>
                        <td class="fw-bold text-center">${cat.category}</td>
                        <td dir="ltr" class="text-center">${cat.qty}</td>
                        <td class="text-center">${cat.amount.toLocaleString()}</td>
                        <td class="text-center">
                            <div class="fw-bold text-dark small" style="max-width: 200px; margin: 0 auto; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" title="${cat.top_item_name}">${cat.top_item_name}</div>
                            <small class="text-muted d-block" style="font-size: 0.75em;">${cat.top_item_id}</small>
                        </td>
                        <td dir="ltr" class="text-center small">${cat.top_item_qty}</td>
                        <td class="text-center small fw-bold">${cat.top_item_amount.toLocaleString()}</td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });

            new bootstrap.Modal(document.getElementById('detailsModal')).show();
        }

        // Run
        init();

    </script>
</body>

</html>