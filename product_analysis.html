<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Orange | ุชุญููู ุงูููุชุฌุงุช</title>

    <!-- Bootstrap 5 RTL -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">

    <style>
        :root {
            --bs-primary: #fe7900;
            --bs-secondary: #6c757d;
            --bg-light: #f8f9fa;
            --card-radius: 12px;
            --font-main: 'Tajawal', sans-serif;
        }

        body {
            font-family: var(--font-main);
            background-color: var(--bg-light);
            color: #212529;
        }

        .navbar {
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            background: white !important;
        }

        .navbar-brand {
            font-weight: 800;
            color: #000 !important;
        }

        .brand-orange {
            color: #fe7900;
        }

        .card-custom {
            background: white;
            border: none;
            border-radius: var(--card-radius);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.03);
            margin-bottom: 20px;
        }

        .section-title {
            font-weight: 700;
            margin-bottom: 20px;
            border-right: 4px solid #fe7900;
            padding-right: 10px;
        }

        .table-custom thead th {
            background-color: #fe7900;
            color: white;
            font-weight: 500;
            border: none;
        }

        .table-hover tbody tr:hover {
            background-color: #fff3e0;
            cursor: pointer;
        }
    </style>
</head>

<body>

    <!-- Navbar -->
    <nav class="navbar mb-4 sticky-top">
        <div class="container-fluid">
            <span class="navbar-brand"><span class="brand-orange">ORANGE</span> PRODUCT ANALYSIS</span>
            <div class="d-flex gap-2 align-items-center">
                <span class="badge bg-light text-dark border" id="periodDisplay">...</span>
                <a href="index.html" class="btn btn-outline-secondary btn-sm fw-bold">
                    ๐ ุงูุฑุฆูุณูุฉ
                </a>
                <button onclick="logout()" class="btn btn-danger btn-sm fw-bold">ุฎุฑูุฌ</button>
            </div>
        </div>
    </nav>

    <script src="users.js"></script>
    <script>
        const currentUser = JSON.parse(localStorage.getItem('currentUser'));
        if (!currentUser) {
            window.location.href = 'login.html';
        }

        function logout() {
            localStorage.removeItem('currentUser');
            window.location.href = 'login.html';
        }
    </script>

    <div class="container-fluid px-4">

        <!-- Controls -->
        <div class="row align-items-center mb-4">
            <div class="col-md-6">
                <!-- Period Toggle -->
                <div class="d-flex flex-wrap gap-2 mb-2 align-items-center">
                    <div class="btn-group" role="group" aria-label="Period Toggle">
                        <input type="radio" class="btn-check" name="periodbtn" id="btnMtd" autocomplete="off" checked
                            onchange="switchPeriod('mtd')">
                        <label class="btn btn-outline-primary fw-bold" for="btnMtd">๐ ุงูุดูุฑ ุงูุญุงูู</label>

                        <input type="radio" class="btn-check" name="periodbtn" id="btn7" autocomplete="off"
                            onchange="switchPeriod('7d')">
                        <label class="btn btn-outline-primary fw-bold" for="btn7">7 ุฃูุงู</label>

                        <input type="radio" class="btn-check" name="periodbtn" id="btn14" autocomplete="off"
                            onchange="switchPeriod('14d')">
                        <label class="btn btn-outline-primary fw-bold" for="btn14">14 ููู</label>

                        <input type="radio" class="btn-check" name="periodbtn" id="btn30" autocomplete="off"
                            onchange="switchPeriod('30d')">
                        <label class="btn btn-outline-primary fw-bold" for="btn30">30 ููู</label>

                        <input type="radio" class="btn-check" name="periodbtn" id="btnYest" autocomplete="off"
                            onchange="switchPeriod('yest')">
                        <label class="btn btn-outline-primary fw-bold" for="btnYest">โณ ุฃูุณ</label>
                    </div>

                    <div class="d-inline-flex align-items-center p-1 border rounded bg-white">
                        <span class="me-2 small fw-bold text-muted">ุงูุนุฑุถ:</span>
                        <div class="form-check form-switch m-0">
                            <input class="form-check-input" type="checkbox" id="metricToggle" onchange="toggleMetric()">
                            <label class="form-check-label fw-bold" for="metricToggle" id="metricLabel">๐ฐ
                                ุงููููุฉ</label>
                        </div>
                    </div>
                </div>

                <!-- Filters Row -->
                <div class="d-flex gap-2">
                    <select class="form-select form-select-sm fw-bold" id="regionFilter"
                        style="width: 150px; display:none;" onchange="applyFilters()">
                        <option value="all">๐ ูู ุงูููุงุทู</option>
                    </select>
                    <select class="form-select form-select-sm fw-bold" id="storeFilter"
                        style="width: 180px; display:none;" onchange="applyFilters()">
                        <option value="all">๐ช ูู ุงููุนุงุฑุถ</option>
                    </select>
                </div>
            </div>
            <div class="col-md-6 text-end">
                <div class="d-flex justify-content-end align-items-center gap-2">
                    <button class="btn btn-danger fw-bold text-white shadow-sm" onclick="openPdfModal()">ุชุตุฏูุฑ
                        PDF</button>
                    <button class="btn btn-warning fw-bold text-dark" onclick="openCatalogModal()">๐ ุชุตูุญ
                        ุงูุฃูุณุงู</button>
                    <div class="input-group" style="width: 250px;">
                        <span class="input-group-text bg-white border-end-0">๐</span>
                        <input type="text" class="form-control border-start-0" id="productSearchInput"
                            placeholder="ุจุญุซ ุนู ููุชุฌ..." onkeyup="handleSearch()">
                    </div>
                    <!-- Date Label (Restored) -->
                    <h5 class="section-title mb-0 border-0 ms-2" id="currentPeriodLabel">...</h5>
                </div>
            </div>
        </div>

        <!-- Summary Section -->
        <h5 class="section-title">ููุฎุต ุฃุฏุงุก ุงููุฆุงุช ูุงูููุชุฌุงุช (Category & Product Performance)</h5>
        <div class="row mb-4">
            <!-- Top Products per Category -->
            <div class="col-md-6">
                <div class="card-custom p-3" style="height: 450px; overflow-y: auto;">
                    <h6 class="text-muted fw-bold mb-3">
                        ุงูููุชุฌ ุงูุฃูุซุฑ ูุจูุนุงู ุญุณุจ ุงููุฆุฉ (<span id="topCatLabel">ุงูุดูุฑ ุงูุญุงูู</span>)
                    </h6>
                    <table class="table table-sm align-middle table-hover">
                        <thead class="table-light sticky-top" style="top: 0; z-index: 1;">
                            <tr>
                                <th>ุงูุชุตููู</th>
                                <th>ุฑูู ุงูููุชุฌ (Item ID)</th>
                                <th onclick="setSort('topProd', 'qty')" style="cursor: pointer;">ุงููููุฉ โ</th>
                                <th onclick="setSort('topProd', 'val')" style="cursor: pointer;">ุงููููุฉ โ</th>
                            </tr>
                        </thead>
                        <tbody id="topProductsBody">
                            <!-- JS -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Top Categories List (Existing) -->
            <div class="col-md-6">
                <div class="card-custom p-3" style="height: 450px; overflow-y: auto;">
                    <h6 class="text-muted fw-bold mb-3">ุฃุฏุงุก ุงููุฆุงุช (Category Performance) - <span
                            id="topCatLabel"></span></h6>
                    <table class="table table-sm align-middle">
                        <thead class="table-light sticky-top" style="top: 0; z-index: 1;">
                            <tr>
                                <th>#</th>
                                <th>ุงูุชุตููู</th>
                                <th onclick="setSort('catPerf', 'qty')" style="cursor: pointer;">ุงููููุฉ โ</th>
                                <th onclick="setSort('catPerf', 'val')" style="cursor: pointer;">ุงููุจูุนุงุช โ</th>
                                <th>ูุณุงููุฉ %</th>
                            </tr>
                        </thead>
                        <tbody id="topCategoriesBody">
                            <!-- JS -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Offers Analysis Section (NEW) -->
        <h5 class="section-title">ุชุญููู ูุจูุนุงุช ุงูุนุฑูุถ (Sales Analysis of Offers)</h5>
        <div class="card-custom p-3 mb-4" style="height: 400px; overflow-y: auto;">
            <div class="alert alert-info small py-2 d-flex align-items-center">
                <i class="fs-5 me-2">๐ท๏ธ</i>
                <div>
                    <strong>ููุงุญุธุฉ:</strong> ุงูุฃุฑูุงู ุฃุฏูุงู ุชูุซู ุฅุฌูุงูู ุฃุฏุงุก ุงูุนุฑุถ ููุฐ ุจุฏุงูุชู ูุญุชู ุงูุขู (Lifetime).
                </div>
            </div>
            <table class="table table-sm align-middle table-hover">
                <thead class="table-light sticky-top" style="top: 0; z-index: 1;">
                    <tr>
                        <th>#</th>
                        <th>ุงุณู ุงูุนุฑุถ (Offer Name)</th>
                        <th>ุงููุชุฑุฉ (Duration)</th>
                        <th>ุงูุญุงูุฉ (Status)</th>
                        <th class="text-center">ุนุฏุฏ ุงูุนูููุงุช</th>
                        <th class="text-center">ุฅุฌูุงูู ุงูุฎุตู (Discount)</th>
                        <th class="text-center">ุฅุฌูุงูู ุงููุจูุนุงุช (Sales)</th>
                    </tr>
                </thead>
                <tbody id="offersAnlaysisBody">
                    <!-- JS -->
                </tbody>
            </table>
        </div>

        <!-- Market Basket Analysis Section (NEW) -->
        <h5 class="section-title">ุฃูุซุฑ ุงูููุชุฌุงุช ุงูุชู ุชุดุชุฑู ูุนุงู (Items Bought Together)</h5>
        <div class="card-custom p-3 mb-4" style="height: 400px; overflow-y: auto;">
            <table class="table table-sm align-middle table-hover">
                <thead class="table-light sticky-top" style="top: 0; z-index: 1;">
                    <tr>
                        <th>#</th>
                        <th>ุงูููุชุฌ ุงูุฃูู</th>
                        <th>ุงูููุชุฌ ุงูุซุงูู</th>
                        <th onclick="setSort('basket', 'freq')" style="cursor: pointer;">ูุฑุงุช ุงูุดุฑุงุก ูุนุงู โ</th>
                    </tr>
                </thead>
                <tbody id="marketBasketBody">
                    <!-- JS -->
                </tbody>
            </table>
        </div>


        <!-- Missed Opportunities Section (NEW) -->
        <h5 class="section-title text-danger">ูุฑุต ุงูุจูุน ุงูุถุงุฆุนุฉ ุญุณุจ ุงูููุธู (Missed Opportunities)</h5>
        <div class="card-custom p-3 mb-4" style="height: 400px; overflow-y: auto;">
            <div class="alert alert-warning small py-2">
                <i class="me-1">๐ก</i>
                ูุนุฑุถ ูุฐุง ุงูุฌุฏูู ุงูุญุงูุงุช ุงูุชู ูุงู ูููุง ุงูููุธู ุจุจูุน ููุชุฌ ูุฑุชุจุท ุจููุชุฌ ุขุฎุฑ (ุญุณุจ ุณููู ุงูุนููุงุก ุงูุนุงู) ููููู
                <strong>ูู ูุจุน</strong> ุงูููุชุฌ ุงูุขุฎุฑ.
            </div>
            <table class="table table-sm align-middle table-hover">
                <thead class="table-light sticky-top" style="top: 0; z-index: 1;">
                    <tr>
                        <th>#</th>
                        <th>ุงูููุธู (Salesman)</th>
                        <th>ุงูููุชุฌ ุงููุจุงุน (Trigger)</th>
                        <th>ุงููุฑุตุฉ ุงูุถุงุฆุนุฉ (Missed Item)</th>
                        <th class="text-center">ุนุฏุฏ ุงููุฑุงุช</th>
                    </tr>
                </thead>
                <tbody id="missedOppBody">
                    <!-- JS -->
                </tbody>
            </table>
        </div>

        <!-- Outlets Table -->
        <h5 class="section-title">ุชูุงุตูู ุงููุฑูุน (Outlets Breakdown)</h5>
        <div class="card-custom p-3">
            <div class="table-responsive">
                <table class="table table-custom table-hover align-middle">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>ุงููุฑุน (Outlet)</th>
                            <th onclick="setSort('outlets', 'qty')" style="cursor: pointer;">ุฅุฌูุงูู ุงููููุฉ (Total Qty) โ
                            </th>
                            <th onclick="setSort('outlets', 'val')" style="cursor: pointer;">ุฅุฌูุงูู ุงููุจูุนุงุช (Total
                                Sales) โ</th>
                            <th>ุฃุนูู ุชุตููู ูุจูุนุงู (Top Category)</th>
                            <th>ุฅุฌุฑุงุก</th>
                        </tr>
                    </thead>
                    <tbody id="outletsTableBody">
                        <!-- JS -->
                    </tbody>
                </table>
            </div>
        </div>

    </div>

    <!-- Store Details Modal -->
    <div class="modal fade" id="detailsModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-light">
                    <h5 class="modal-title fw-bold" id="modalTitle">ุชูุงุตูู ุงููุจูุนุงุช</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="table-responsive">
                        <table class="table table-hover table-striped mb-0">
                            <thead class="table-dark">
                                <tr>
                                    <th class="text-center">ุงูุชุตููู (Category)</th>
                                    <th class="text-center" onclick="setSort('modal', 'qty')" style="cursor: pointer;">
                                        ุงููููุฉ (Qty) โ</th>
                                    <th class="text-center" onclick="setSort('modal', 'val')" style="cursor: pointer;">
                                        ุงููุจูุนุงุช (Amount) โ</th>
                                    <th class="text-center" style="width: 30%;">ุฃุนูู ููุชุฌ (Top Product)</th>
                                    <th class="text-center">Q</th>
                                    <th class="text-center">V</th>
                                </tr>
                            </thead>
                            <tbody id="modalTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Product Details Modal (NEW) -->
    <div class="modal fade" id="productModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header text-white" style="background-color: var(--bs-primary);">
                    <div>
                        <h5 class="modal-title fw-bold" id="prodModalName">ุงุณู ุงูููุชุฌ</h5>
                        <small id="prodModalId" class="opacity-75">Item ID</small>
                    </div>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                        aria-label="Close"></button>
                </div>
                <div class="modal-body bg-light">

                    <!-- KPI Cards -->
                    <div class="row g-2 mb-3">
                        <div class="col-4">
                            <div class="card p-2 text-center border-0 shadow-sm">
                                <small class="text-muted">ุฃูุถู ููู</small>
                                <div class="fw-bold text-success" id="pmBestDay">-</div>
                                <small class="text-muted" style="font-size: 0.7em;" id="pmBestDayVal">-</small>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="card p-2 text-center border-0 shadow-sm">
                                <small class="text-muted">ุฃุณูุฃ ููู</small>
                                <div class="fw-bold text-danger" id="pmWorstDay">-</div>
                                <small class="text-muted" style="font-size: 0.7em;" id="pmWorstDayVal">-</small>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="card p-2 text-center border-0 shadow-sm">
                                <small class="text-muted">ุฃูุงู ุจูุง ูุจูุนุงุช</small>
                                <div class="fw-bold text-warning" id="pmZeroDays">-</div>
                                <small class="text-muted" style="font-size: 0.7em;">ุฎูุงู ุงููุชุฑุฉ</small>
                            </div>
                        </div>
                    </div>

                    <!-- Chart -->
                    <div class="card border-0 shadow-sm p-3 mb-3">
                        <h6 class="fw-bold mb-3 border-bottom pb-2">ุณุฌู ุงููุจูุนุงุช ุงููููู (Daily Sales Trend)</h6>
                        <div style="height: 250px;">
                            <canvas id="productTrendChart"></canvas>
                        </div>
                        <div id="chartNoDataMsg" class="text-center text-muted py-5 d-none">
                            <i class="fs-1">๐</i><br>ูุง ุชูุฌุฏ ุจูุงูุงุช ุชุงุฑูุฎูุฉ ููุตูุฉ ููุฐุง ุงูููุชุฌ ุญุงููุงู
                        </div>
                    </div>

                    <!-- Trend Analysis Badge -->
                    <div class="alert alert-info d-flex align-items-center mb-3" role="alert" id="trendAlertBox">
                        <span id="trendIcon" class="me-2 fs-4"></span>
                        <div>
                            <strong>ุชุญููู ุงูุงุชุฌุงู:</strong> <span id="trendText">ุฌุงุฑู ุงูุชุญููู...</span>
                        </div>
                    </div>

                    <!-- Frequently Bought Together (Modal) -->
                    <div class="card border-0 shadow-sm p-3">
                        <h6 class="fw-bold mb-3 border-bottom pb-2">ุบุงูุจุงู ูุดุชุฑู ูุน (Frequently Bought With)</h6>
                        <ul class="list-group list-group-flush" id="modalRelatedItems">
                            <li class="list-group-item text-muted small">ุฌุงุฑู ุงูุชุญููู...</li>
                        </ul>
                    </div>

                </div>
            </div>
        </div>
    </div>

    <!-- Category Explorer Modal -->
    <div class="modal fade" id="catalogModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header bg-warning">
                    <h5 class="modal-title fw-bold text-dark">๐ ุฏููู ุงูุฃูุณุงู ูุงูููุชุฌุงุช</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body bg-light">
                    <!-- Search inside Catalog -->
                    <div class="mb-3">
                        <input type="text" class="form-control form-control-lg" id="catalogSearch"
                            placeholder="ุจุญุซ ุฏุงุฎู ุงูุฏููู (ุงุณู ุงููุณู ุฃู ุงูููุชุฌ)..." onkeyup="filterCatalog()">
                    </div>

                    <!-- Accordion Container -->
                    <div class="accordion" id="categoryAccordion">
                        <!-- Dynamic Content -->
                    </div>
                    <div id="catalogNoData" class="text-center text-muted mt-5 d-none">ูุง ุชูุฌุฏ ูุชุงุฆุฌ ูุทุงุจูุฉ</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Missed Opportunities Details Modal -->
    <div class="modal fade" id="missedDetailsModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title fw-bold">ุชูุงุตูู ุงููุฑุต ุงูุถุงุฆุนุฉ</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                        aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <strong>ุงูููุธู:</strong> <span id="mdSalesman"></span><br>
                        <strong>ุงูููุชุฌ ุงููุจุงุน:</strong> <span id="mdSoldItem" class="text-success fw-bold"></span>
                    </div>
                    <h6>ุงูููุชุฌุงุช ุงูุชู ูู ูุชู ุนุฑุถูุง/ุจูุนูุง:</h6>
                    <ul class="list-group" id="mdList">
                        <!-- Items -->
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- PDF Export Modal (NEW) -->
    <div class="modal fade" id="pdfExportModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title fw-bold">ุชุตุฏูุฑ ุงูุชูุฑูุฑ (PDF)</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                        aria-label="Close"></button>
                </div>
                <div class="modal-body">

                    <!-- Store Selector -->
                    <div class="mb-3">
                        <label class="form-label fw-bold">ูุทุงู ุงูุชุตุฏูุฑ:</label>
                        <select class="form-select" id="pdfStoreSelect" onchange="togglePdfDetailOption()">
                            <option value="all">ุงููู (ุญุณุจ ุงูููุชุฑ ุงูุญุงูู)</option>
                            <!-- Populated by JS -->
                        </select>
                    </div>

                    <!-- Detailed Option (Visible only when All is selected) -->
                    <div class="form-check mb-3 bg-light p-2 rounded" id="divPdfDetailed">
                        <input class="form-check-input" type="checkbox" id="chkPdfDetailed">
                        <label class="form-check-label fw-bold" for="chkPdfDetailed">
                            ุชูููุฏ ุตูุญุฉ ุชูุตูููุฉ ููู ูุนุฑุถ
                        </label>
                        <div class="form-text small">ุณูุชู ุฅูุดุงุก ููุฎุต ุนุงูุ ูููู ุชูุฑูุฑ ูุณุชูู ููู ูุนุฑุถ ูู ููุณ ุงูููู.</div>
                    </div>

                    <hr>
                    <p class="text-muted mb-2 small">ุงูุฃูุณุงู ุงููุทููุจุฉ:</p>

                    <div class="form-check mb-2">
                        <input class="form-check-input" type="checkbox" value="perf" id="chkPerf" checked>
                        <label class="form-check-label fw-bold" for="chkPerf">
                            ููุฎุต ุงูุฃุฏุงุก (Performance Summary)
                        </label>
                        <div class="form-text small ms-4">ุฃูุถู ุงูููุชุฌุงุช ูุฃุฏุงุก ุงููุฆุงุช</div>
                    </div>

                    <div class="form-check mb-2">
                        <input class="form-check-input" type="checkbox" value="adv" id="chkAdv" checked>
                        <label class="form-check-label fw-bold" for="chkAdv">
                            ุชุญููู ูุชูุฏู (Advanced Analysis)
                        </label>
                        <div class="form-text small ms-4">ุงูููุชุฌุงุช ุงููุฑุชุจุทุฉ (Market Basket) ูุงููุฑุต ุงูุถุงุฆุนุฉ</div>
                    </div>

                    <div class="form-check mb-2">
                        <input class="form-check-input" type="checkbox" value="store" id="chkStore" checked>
                        <label class="form-check-label fw-bold" for="chkStore">
                            ุชูุงุตูู ุงููุฑูุน (Store Breakdown)
                        </label>
                        <div class="form-text small ms-4">ุฌุฏูู ุชูุตููู ููู ูุฑุน</div>
                    </div>

                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" value="cat_det" id="chkCatDet">
                        <label class="form-check-label fw-bold" for="chkCatDet">
                            ุชูุงุตูู ุงูุฃุตูุงู (Category Details)
                        </label>
                        <div class="form-text small ms-4">ูุงุฆูุฉ ุงูููุชุฌุงุช ุงููุจุงุนุฉ ุชุญุช ูู ุชุตููู (ูุฏ ูุฒูุฏ ุนุฏุฏ ุงูุตูุญุงุช)
                        </div>
                    </div>

                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ุฅูุบุงุก</button>
                    <button type="button" class="btn btn-danger fw-bold" onclick="generateProductPDF()">ุชุตุฏูุฑ
                        PDF</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Category Items Modal (NEW) -->
    <div class="modal fade" id="categoryItemsModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <div>
                        <h5 class="modal-title fw-bold" id="catItemsTitle">ููุชุฌุงุช ุงูุชุตููู</h5>
                        <small id="catItemsSubtitle" class="opacity-75">ุงููุฑุน - ุงููุชุฑุฉ</small>
                    </div>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                        aria-label="Close"></button>
                </div>
                <div class="modal-body p-0">
                    <table class="table table-hover table-striped mb-0">
                        <thead class="table-dark sticky-top">
                            <tr>
                                <th class="text-center">#</th>
                                <th>ุงูููุชุฌ (Product)</th>
                                <th class="text-center">ุงููููุฉ (Qty)</th>
                                <th class="text-center">ุงููุจูุนุงุช (Amount)</th>
                            </tr>
                        </thead>
                        <tbody id="catItemsBody"></tbody>
                    </table>
                    <div id="catItemsNoData" class="text-center text-muted p-4 d-none">ูุง ุชูุฌุฏ ุจูุงูุงุช ููุฐุง ุงูุชุตููู</div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- PDF Libs -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <script src="assets/amiri_font.js"></script>
    <script src="product_pdf_export.js"></script>
    <script>
        let rawData = null;
        let currentData = null;
        let currentMode = 'mtd';
        let currentMetric = 'val';
        let chartInstance = null;

        // Log Auth for debugging
        console.log("Current User:", currentUser);

        // Modal Instances
        let detailsModalObj = null;
        let productModalObj = null;
        let catalogModalObj = null;
        let missedDetailsModalObj = null;
        let categoryItemsModalObj = null;

        // Filter Scope
        let activeRegion = 'all';
        let activeStore = 'all';

        // Mock Data for History (Temporary until backend is ready)
        const mockHistoryCache = {};

        let storeMeta = {};
        let currentOpenStoreId = null; // Track open modal

        // Sorting State
        let sortState = {
            topProd: { col: 'val', asc: false },
            catPerf: { col: 'val', asc: false },
            outlets: { col: 'val', asc: false },
            modal: { col: 'val', asc: false }
        };

        function setSort(table, col) {
            if (sortState[table].col === col) {
                sortState[table].asc = !sortState[table].asc;
            } else {
                sortState[table].col = col;
                sortState[table].asc = false;
            }

            if (table === 'modal') {
                if (currentOpenStoreId) showStoreDetails(currentOpenStoreId);
            } else {
                renderDashboard();
            }
        }

        async function init() {
            try {
                // Fetch both data files
                const [resAnalysis, resMgmt] = await Promise.all([
                    fetch('product_analysis_data.json?t=' + Date.now()),
                    fetch('management_data.json?t=' + Date.now())
                ]);

                if (!resAnalysis.ok || !resMgmt.ok) throw new Error("Failed to load data");

                rawData = await resAnalysis.json();
                const mgmtData = await resMgmt.json();
                window.mgmtData = mgmtData; // Store globally
                storeMeta = mgmtData.store_meta || {};

                // Update Badge for period
                const meta = rawData.metadata || {};
                const periodText = `${meta.period_start} ุฅูู ${meta.period_end}`;
                document.getElementById('periodDisplay').textContent = periodText;

                // Default to MTD
                switchPeriod('mtd');

                // Check Role & Init Filters
                setupFilters(mgmtData);

                // Initial Offers Render
                renderOffersTable();

            } catch (e) {
                console.error(e);
                alert("ุชุนุฐุฑ ุชุญููู ุงูุจูุงูุงุช. ุงูุฑุฌุงุก ุงูุชุฃูุฏ ูู ุชุดุบูู ุงูุชุญุฏูุซ.");
            }
        }

        // Helper to check if user has access to a store
        function isStoreAccessible(sid) {
            if (!currentUser) return false;
            if (currentUser.role === 'Admin') return true;

            const meta = storeMeta[sid];
            // For Manager role, only show stores where this user is the manager
            if (currentUser.role === 'Manager') {
                return meta && meta.manager === currentUser.name;
            }

            // For other roles, check explicit store list
            if (currentUser.stores && (currentUser.stores.includes(sid) || currentUser.stores.includes('all'))) {
                return true;
            }
            return false;
        }

        function setupFilters(mgmtData) {
            const role = (currentUser.role || 'guest').toLowerCase().replace(' ', '_');
            const allowed = ['admin', 'sales_manager', 'manager', 'salesmanager'];

            if (allowed.includes(role) || role.includes('admin') || role.includes('manager')) {
                const regSel = document.getElementById('regionFilter');
                const storeSel = document.getElementById('storeFilter');

                regSel.style.display = 'inline-block';
                storeSel.style.display = 'inline-block';

                const regions = new Set();
                const stores = [];

                const sourceData = rawData.analysis_mtd || {};

                Object.keys(sourceData).forEach(sid => {
                    if (!isStoreAccessible(sid)) return;

                    const storeObj = sourceData[sid];
                    const m = storeMeta[sid] || {};
                    const sName = storeObj.store_name || m.name_ar || m.name || sid;
                    const region = m.region;

                    if (region) regions.add(region);
                    stores.push({ id: sid, name: sName, region: region });
                });

                const sortedRegions = Array.from(regions).sort();
                sortedRegions.forEach(r => {
                    const opt = document.createElement('option');
                    opt.value = r;
                    opt.textContent = `๐ ${r}`;
                    regSel.appendChild(opt);
                });

                populateStoreFilter(stores);
            }
        }

        function populateStoreFilter(stores) {
            const storeSel = document.getElementById('storeFilter');
            storeSel.innerHTML = '<option value="all">๐ช ูู ุงููุนุงุฑุถ</option>';

            stores.sort((a, b) => a.name.localeCompare(b.name));
            stores.forEach(s => {
                const opt = document.createElement('option');
                opt.value = s.id;
                opt.textContent = s.name;
                storeSel.appendChild(opt);
            });
        }

        function applyFilters() {
            activeRegion = document.getElementById('regionFilter').value;
            activeStore = document.getElementById('storeFilter').value;
            renderDashboard();
        }

        function switchPeriod(mode) {
            currentMode = mode; // Update global mode
            const meta = rawData.metadata || {};
            const lbl = document.getElementById('currentPeriodLabel');

            // Access the correct period data
            // Backend structure: rawData.periods['mtd'], rawData.periods['7d'], etc.
            const pData = rawData.periods ? rawData.periods[mode] : null;

            if (pData) {
                currentData = pData.analysis; // The store/category/top_item structure
                // We also have pData.global_top, pData.catalog, pData.missed_opportunities
            } else {
                console.error("No data found for period:", mode);
                currentData = {};
            }

            // Update Labels
            // Update Labels
            if (pData && pData.date_range && pData.date_range !== "N/A") {
                lbl.textContent = `ุงููุชุฑุฉ: ${pData.date_range}`;
            } else if (mode === 'mtd') {
                lbl.textContent = `ุงููุชุฑุฉ: ${meta.period_start} ุฅูู ${meta.period_end}`;
            } else if (mode === 'yest') {
                lbl.textContent = `ุงููุชุฑุฉ: ${meta.yesterday_date}`;
            } else {
                lbl.textContent = `ุงููุชุฑุฉ: ${meta.period_start} ุฅูู ${meta.period_end}`;
            }

            // Sub-labels
            if (mode === 'mtd') document.getElementById('topCatLabel').textContent = "ุงูุดูุฑ ุงูุญุงูู";
            else if (mode === 'yest') document.getElementById('topCatLabel').textContent = "ููู ุฃูุณ";
            else if (mode === '7d') document.getElementById('topCatLabel').textContent = "ุขุฎุฑ 7 ุฃูุงู";
            else if (mode === '14d') document.getElementById('topCatLabel').textContent = "ุขุฎุฑ 14 ููู";
            else if (mode === '30d') document.getElementById('topCatLabel').textContent = "ุขุฎุฑ 30 ููู";

            renderDashboard();
        }

        function toggleMetric() {
            const isChecked = document.getElementById('metricToggle').checked;
            currentMetric = isChecked ? 'val' : 'qty';
            document.getElementById('metricLabel').textContent = isChecked ? '๐ฐ ุงููููุฉ (Value)' : '๐ฆ ุงููููุฉ (Qty)';

            // Auto update sorts to match metric for better UX
            sortState.topProd.col = currentMetric;
            sortState.catPerf.col = currentMetric;
            sortState.outlets.col = currentMetric;

            renderDashboard();
        }

        function renderDashboard() {
            processGlobalStats(currentMode); // Pass current mode
            renderOutletsTable();
            renderMarketBasketTable();
            renderMissedOppTable();

            // Re-apply search if exists
            handleSearch();
        }

        // ... (Existing Functions) ...

        function renderOffersTable() {
            const tbody = document.getElementById('offersAnlaysisBody');
            tbody.innerHTML = '';

            // Data comes from management_data.json -> mgmtData.offers_analysis
            // We need to access global mgmtData if possible. 
            // Currently init() loads it into `storeMeta` but maybe we should store the whole thing?
            // Let's modify init() to store `window.mgmtData` or similar.
            // Assuming we will fix init() next.

            const offersData = window.mgmtData ? (window.mgmtData.offers_analysis || []) : [];

            if (offersData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">ูุง ุชูุฌุฏ ุนุฑูุถ ูุณุฌูุฉ</td></tr>';
                return;
            }

            // Sort by Start Date Descending
            // offersData.sort((a, b) => new Date(b.start_date) - new Date(a.start_date));

            offersData.forEach((offer, i) => {
                let statusBadge = '<span class="badge bg-secondary">Unknown</span>';
                if (offer.status === 'Active') statusBadge = '<span class="badge bg-success">Active</span>';
                else if (offer.status === 'Expired') statusBadge = '<span class="badge bg-danger">Expired</span>';
                else if (offer.status === 'Upcoming') statusBadge = '<span class="badge bg-warning text-dark">Upcoming</span>';

                let row = `
                    <tr>
                        <td class="fw-bold">${i + 1}</td>
                        <td class="fw-bold" title="${offer.id}">${offer.name}</td>
                        <td class="small text-muted">${offer.start_date} <span class="mx-1">โก</span> ${offer.end_date}</td>
                        <td>${statusBadge}</td>
                        <td class="text-center font-monospace">${offer.count.toLocaleString()}</td>
                        <td class="text-center font-monospace text-danger">-${offer.total_discount.toLocaleString()}</td>
                        <td class="text-center font-monospace text-success fw-bold">${offer.total_sales.toLocaleString()}</td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }

        function renderMarketBasketTable() {
            const tbody = document.getElementById('marketBasketBody');
            tbody.innerHTML = '';

            const allBasketData = rawData.market_basket || {};
            let basketData = allBasketData[activeStore] || [];

            // If activeStore is 'all', use global 'all' key
            if (activeStore === 'all') {
                basketData = allBasketData['all'] || [];
            }

            // If specific store selected but no data found (empty list or undefined)
            if (activeStore !== 'all' && (!basketData || basketData.length === 0)) {
                // Try falling back to global? No, user wants specific.
                // Just show empty message
                tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">ูุง ุชูุฌุฏ ุฃููุงุท ุดุฑุงุฆูุฉ ูุงููุฉ ููุฐุง ุงููุนุฑุถ ุชุญุฏูุฏุงู</td></tr>';
                return;
            }

            if (basketData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">ูุง ุชูุฌุฏ ุจูุงูุงุช ูุงููุฉ ููุชุญููู</td></tr>';
                return;
            }

            // Show Top 20 for brevity
            basketData.slice(0, 20).forEach((pair, i) => {
                let row = `
                    <tr>
                        <td class="fw-bold">${i + 1}</td>
                        <td class="fw-bold text-primary">${pair.item_a_name} <small class="text-muted d-block font-monospace">${pair.item_a_id}</small></td>
                        <td class="fw-bold text-primary">${pair.item_b_name} <small class="text-muted d-block font-monospace">${pair.item_b_id}</small></td>
                        <td class="text-center fw-bold fs-5">${pair.frequency}</td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }

        function renderMissedOppTable() {
            const tbody = document.getElementById('missedOppBody');
            tbody.innerHTML = '';

            // Get Data from current period
            const pData = rawData.periods ? rawData.periods[currentMode] : null;
            const missedByStore = pData ? (pData.missed_opportunities || {}) : {};

            let data = [];

            if (activeStore === 'all') {
                // Aggregate allowed stores
                Object.entries(missedByStore).forEach(([sId, storeList]) => {
                    if (isStoreAccessible(sId)) {
                        data = data.concat(storeList);
                    }
                });
                data.sort((a, b) => b.total_count - a.total_count);
                data = data.slice(0, 100);
            } else {
                data = missedByStore[activeStore] || [];
            }

            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">ูุง ุชูุฌุฏ ุจูุงูุงุช (ุฃู ูุฑุต ุถุงุฆุนุฉ) ูุณุฌูุฉ ููุฐุง ุงููุทุงู</td></tr>';
                return;
            }

            // Store for modal access
            window.currentMissedData = data;

            data.forEach((row, i) => {
                // row.missed_items is list of {name, count}
                // Sort to get top 1
                const missed = row.missed_items || [];
                missed.sort((a, b) => b.count - a.count);

                const topItem = missed.length > 0 ? missed[0].name : '-';
                const othersCount = missed.length - 1;

                let missedHtml = `<span class="fw-bold">${topItem}</span>`;
                if (othersCount > 0) {
                    missedHtml += `<br><a href="#" onclick="showMissedDetails(${i}); return false;" class="badge bg-secondary text-decoration-none mt-1">+${othersCount} ููุชุฌุงุช ุฃุฎุฑู</a>`;
                }

                let html = `
                    <tr>
                        <td>${i + 1}</td>
                        <td class="fw-bold text-dark">${row.employee_name} <br><small class="text-muted font-monospace">${row.employee_id}</small></td>
                        <td class="text-success">${row.sold_item}</td>
                        <td class="text-danger">
                           ${missedHtml}
                        </td>
                        <td class="text-center fw-bold fs-5">${row.total_count}</td>
                    </tr>
                `;
                tbody.innerHTML += html;
            });
        }

        function showMissedDetails(index) {
            const row = window.currentMissedData[index];
            if (!row) return;

            document.getElementById('mdSalesman').textContent = row.employee_name;
            document.getElementById('mdSoldItem').textContent = row.sold_item;

            const list = document.getElementById('mdList');
            list.innerHTML = '';

            row.missed_items.forEach(m => {
                list.innerHTML += `<li class="list-group-item d-flex justify-content-between align-items-center">
                    <span>${m.name}</span>
                    <span class="badge bg-danger rounded-pill">${m.count} ูุฑุฉ</span>
                 </li>`;
            });

            if (!missedDetailsModalObj) missedDetailsModalObj = new bootstrap.Modal(document.getElementById('missedDetailsModal'));
            missedDetailsModalObj.show();
        }

        // ...

        function openProductDetails(itemId, name, category, totalQty, totalAmt) {
            // 1. Setup Modal Header
            document.getElementById('prodModalName').textContent = name;
            document.getElementById('prodModalId').textContent = `${itemId} | ${category}`;

            // ... (Existing History Logic) ...

            // 2. Shortened Logic for brevity in replacement (keeping history generation same)
            // Check if backend provided history (Future Proofing)
            let history = [];
            if (rawData.product_daily_history && rawData.product_daily_history[itemId]) {
                history = rawData.product_daily_history[itemId];
            } else {
                // Generate Mock Data for now
                if (!mockHistoryCache[itemId]) {
                    mockHistoryCache[itemId] = generateMockHistory(totalQty, totalAmt);
                }
                history = mockHistoryCache[itemId];
            }

            // 3. Calculate KPIs (Same as before)
            history.sort((a, b) => new Date(a.date) - new Date(b.date));
            const sortedByVal = [...history].sort((a, b) => b.amount - a.amount);
            const best = sortedByVal[0] || { date: '-', amount: 0 };
            const worst = sortedByVal[sortedByVal.length - 1] || { date: '-', amount: 0 };
            const zeroDays = history.filter(d => d.qty === 0).length;

            document.getElementById('pmBestDay').textContent = best.date;
            document.getElementById('pmBestDayVal').textContent = Math.round(best.amount).toLocaleString() + ' SR';
            document.getElementById('pmWorstDay').textContent = worst.date !== '-' ? worst.date : '-';
            document.getElementById('pmWorstDayVal').textContent = worst.amount > 0 ? Math.round(worst.amount).toLocaleString() + ' SR' : '0 SR';
            document.getElementById('pmZeroDays').textContent = zeroDays + ' ููู';

            // 4. Trend Analysis
            const trend = calculateTrend(history);
            const alerts = detectAlerts(history);
            renderTrendUI(trend, alerts);

            // 5. Render Chart
            renderProductChart(history);

            // 6. Related Products (Market Basket)
            const relatedList = document.getElementById('modalRelatedItems');
            relatedList.innerHTML = '';

            const basketData = rawData.market_basket || [];
            // Find pairs containing this item
            const related = basketData.filter(p => p.item_a_id == itemId || p.item_b_id == itemId);

            if (related.length === 0) {
                relatedList.innerHTML = '<li class="list-group-item text-muted text-center small">ูุง ุชูุฌุฏ ุจูุงูุงุช ุฑุจุท ููุฐุง ุงูููุชุฌ</li>';
            } else {
                // Sort by frequency
                related.sort((a, b) => b.frequency - a.frequency);

                // Show Top 5
                related.slice(0, 5).forEach(p => {
                    const isA = (p.item_a_id == itemId);
                    const otherId = isA ? p.item_b_id : p.item_a_id;
                    const otherName = isA ? p.item_b_name : p.item_a_name;

                    let html = `
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <div>
                                <span class="fw-bold">${otherName}</span>
                                <small class="text-muted ms-2">${otherId}</small>
                            </div>
                            <span class="badge bg-primary rounded-pill">${p.frequency} ูุฑุฉ</span>
                        </li>
                    `;
                    relatedList.innerHTML += html;
                });
            }

            // Show Modal
            if (!productModalObj) productModalObj = new bootstrap.Modal(document.getElementById('productModal'));
            productModalObj.show();
        }

        function handleSearch() {
            const query = document.getElementById('productSearchInput').value.toLowerCase().trim();
            const rows = document.querySelectorAll('#topProductsBody tr');

            rows.forEach(row => {
                // If it's the "No Data" row, ignore or handle differently? 
                // Actually if we hide all rows, we should show "No Filter Results"
                if (row.cells.length < 2) return;

                const catName = row.cells[0].textContent.toLowerCase();
                const prodName = row.cells[1].textContent.toLowerCase(); // Name + ID is in this cell text content essentially

                if (query === '' || catName.includes(query) || prodName.includes(query)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }

        function processGlobalStats(mode) {
            // 0. Filter Data based on Filters (Region/Store)
            let filteredKeys = Object.keys(currentData); // specific store IDs

            if (activeStore !== 'all') {
                filteredKeys = filteredKeys.filter(id => id === activeStore);
            } else if (activeRegion !== 'all') {
                filteredKeys = filteredKeys.filter(id => {
                    const m = storeMeta[id];
                    return m && m.region === activeRegion && isStoreAccessible(id);
                });
            } else {
                // Global view, but respect permissions
                filteredKeys = filteredKeys.filter(id => isStoreAccessible(id));
            }

            // 1. Calculate Category Performance (Aggregation)
            const catMap = {}; // Cat -> {qty, amount}
            let grandTotal = 0;

            filteredKeys.forEach(storeId => {
                const store = currentData[storeId];
                if (!store) return;

                store.categories.forEach(c => {
                    if (!catMap[c.category]) {
                        catMap[c.category] = { name: c.category, qty: 0, amount: 0, share: 0 };
                    }
                    catMap[c.category].qty += c.qty;
                    catMap[c.category].amount += c.amount;
                    grandTotal += c.amount;
                });
            });

            const sortedCats = Object.values(catMap).sort((a, b) => {
                const sortBy = sortState.catPerf.col; // 'qty' or 'val'
                const isAsc = sortState.catPerf.asc;

                let valA = sortBy === 'qty' ? a.qty : a.amount;
                let valB = sortBy === 'qty' ? b.qty : b.amount;

                return isAsc ? valA - valB : valB - valA;
            });

            // Calculate share
            sortedCats.forEach(c => {
                c.share = grandTotal > 0 ? (c.amount / grandTotal * 100) : 0;
            });


            // 2. Render Categories Table
            const catBody = document.getElementById('topCategoriesBody');
            catBody.innerHTML = '';

            if (sortedCats.length === 0) {
                catBody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">ูุง ุชูุฌุฏ ุจูุงูุงุช</td></tr>';
            } else {
                sortedCats.forEach((c, i) => {

                    // Demo Trend for Categories
                    let trendIcon = 'โ';
                    let trendClass = 'text-muted';
                    const rnd = Math.random();
                    if (rnd > 0.6) { trendIcon = 'โฒ'; trendClass = 'text-success'; }
                    else if (rnd < 0.2) { trendIcon = 'โผ'; trendClass = 'text-danger'; }

                    let row = `
                        <tr>
                            <td class="fw-bold text-center">${i + 1}</td>
                            <td class="text-center">${c.name} <span class="${trendClass} small">${trendIcon}</span></td>
                            <td dir="ltr" class="text-center ${currentMetric === 'qty' ? 'fw-bold' : ''}">${c.qty.toLocaleString()}</td>
                            <td class="fw-bold text-center ${currentMetric === 'val' ? 'fw-bold' : ''}">${Math.round(c.amount).toLocaleString()}</td>
                            <td>
                                <div class="d-flex align-items-center justify-content-center">
                                    <span class="me-2">${c.share.toFixed(1)}%</span>
                                    <div class="progress flex-grow-1" style="height: 6px; max-width: 100px;">
                                        <div class="progress-bar bg-warning" style="width: ${c.share}%"></div>
                                    </div>
                                </div>
                            </td>
                        </tr>
                    `;
                    catBody.innerHTML += row;
                });
            }

            // 3. Recalculate Top Products (Global vs Filtered)
            // Original code used 'global_mtd' pre-calculated from backend.
            // PROBLEM: Backend 'global_mtd' is GLOBAL. If we filter by Region, we can't use it directly.
            // We must re-aggregate Top Products from the filtered stores.
            // BUT: currentData (analysis_mtd) only has "Top Item" per category per store.
            // It does NOT have all items. So we can't perfectly re-calculate "Top Product globally in this region" 
            // if the top product in the region wasn't the top product in any single store.
            // However, usually the top product in a region IS top in many stores. 
            // Approximation: We will collect all 'top_item's from the filtered stores and aggregate them.

            const itemMap = {}; // ItemID -> {name, cat, qty, amount}

            filteredKeys.forEach(storeId => {
                const store = currentData[storeId];
                if (!store) return;

                store.categories.forEach(c => {
                    // We only know the top item of this category in this store
                    const tid = c.top_item_id;
                    if (tid && tid !== '-') {
                        if (!itemMap[tid]) itemMap[tid] = {
                            id: tid,
                            name: c.top_item_name,
                            category: c.category,
                            qty: 0,
                            amount: 0
                        };
                        itemMap[tid].qty += c.top_item_qty;
                        itemMap[tid].amount += c.top_item_amount;
                    }
                });
            });

            // Convert to list & Sort
            const topItems = Object.values(itemMap).sort((a, b) => {
                const sortBy = sortState.topProd.col;
                const isAsc = sortState.topProd.asc;

                let valA = sortBy === 'qty' ? a.qty : a.amount;
                let valB = sortBy === 'qty' ? b.qty : b.amount;

                return isAsc ? valA - valB : valB - valA;
            });

            // Render Top Products
            const prodBody = document.getElementById('topProductsBody');
            prodBody.innerHTML = '';

            if (topItems.length === 0) {
                prodBody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">ูุง ุชูุฌุฏ ุจูุงูุงุช</td></tr>';
            } else {
                // Show top 50?
                topItems.slice(0, 100).forEach(item => {
                    // Trend/Alert Simulation (Mock)
                    let trendIcon = 'โ';
                    let trendClass = 'text-muted';
                    const rnd = Math.random();
                    if (rnd > 0.7) { trendIcon = 'โฒ'; trendClass = 'text-success'; }
                    else if (rnd < 0.3) { trendIcon = 'โผ'; trendClass = 'text-danger'; }

                    let alertBadge = '';
                    if (Math.random() < 0.1) alertBadge = '<span class="badge bg-warning text-dark ms-1" style="font-size:0.6em">โ</span>';

                    let row = `
                        <tr>
                            <td class="fw-bold text-center">${item.category}</td>
                            <td class="text-center">
                                <a href="#" onclick="openProductDetails('${item.id}', '${item.name}', '${item.category}', ${item.qty}, ${item.amount}); return false;" class="text-decoration-none fw-bold text-dark hover-primary">${item.name}</a>
                                <small class="text-muted d-block">${item.id} ${alertBadge}</small>
                            </td>
                            <td dir="ltr" class="text-center ${currentMetric === 'qty' ? 'fw-bold text-primary' : ''}">${item.qty}</td>
                            <td class="text-center ${currentMetric === 'val' ? 'fw-bold text-primary' : ''}">
                                ${Math.round(item.amount).toLocaleString()}
                                <small class="${trendClass} ms-1">${trendIcon}</small>
                            </td>
                        </tr>
                    `;
                    prodBody.innerHTML += row;
                });
            }
        }
        // Pie Chart Logic Removed


        function renderOutletsTable() {
            const tbody = document.getElementById('outletsTableBody');
            tbody.innerHTML = '';

            if (!currentData || Object.keys(currentData).length === 0) {
                tbody.innerHTML = `<tr><td colspan="5" class="text-center text-muted">ูุง ุชูุฌุฏ ุจูุงูุงุช ููุฐู ุงููุชุฑุฉ</td></tr>`;
                return;
            }

            // Convert to array and sort by Total Sales
            let outlets = Object.entries(currentData).map(([id, data]) => ({
                id, ...data
            }));

            // Permission Filter
            if (currentUser.role !== 'Admin') {
                outlets = outlets.filter(o => {
                    const meta = storeMeta[o.id];
                    return meta && meta.manager === currentUser.name;
                });
            }

            // Calculate Totals (Qty needed for sort)
            outlets.forEach(o => {
                let tQty = 0;
                o.categories.forEach(c => tQty += c.qty);
                o.total_qty = tQty;
            });

            // Sort
            outlets.sort((a, b) => {
                let valA = sortState.outlets.col === 'qty' ? a.total_qty : a.total_sales;
                let valB = sortState.outlets.col === 'qty' ? b.total_qty : b.total_sales;
                return sortState.outlets.asc ? valA - valB : valB - valA;
            });

            outlets.forEach((o, i) => {
                // Find top category
                let topCat = o.categories.length > 0 ? o.categories[0] : null;
                let topCatStr = topCat ? `${topCat.category} (${Math.round(topCat.amount).toLocaleString()})` : '-';

                let row = `
                    <tr onclick="showStoreDetails('${o.id}')">
                        <td>${i + 1}</td>
                        <td class="fw-bold">${o.store_name}</td>
                        <td dir="ltr" class="text-center">${o.total_qty.toLocaleString()}</td>
                        <td class="text-success fw-bold">${o.total_sales.toLocaleString()}</td>
                        <td class="text-muted small">${topCatStr}</td>
                        <td><button class="btn btn-sm btn-outline-primary">ุนุฑุถ ุงูุชูุงุตูู</button></td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }

        function showStoreDetails(storeId) {
            currentOpenStoreId = storeId;
            const meta = storeMeta[storeId] || {};

            document.getElementById('modalTitle').textContent = `ุชูุงุตูู ูุนุฑุถ: ${meta.name_ar || meta.name || storeId}`;

            // Filter categories for this store
            const storeData = currentData[storeId];
            if (!storeData) return;

            // Sort logic (same as before)
            // ... (omitted for brevity, keeping existing sort logic is handled by renderDashboard usually, but here we do ad-hoc)
            // Actually existing code does rendering here. Let's just fix the modal call.

            // Copying existing logic briefly to ensure I don't break sorting/rendering:
            const tbody = document.getElementById('modalTableBody');
            tbody.innerHTML = '';

            let cats = [...storeData.categories];
            // Sort
            if (sortState.modal.col === 'qty') {
                cats.sort((a, b) => sortState.modal.asc ? a.qty - b.qty : b.qty - a.qty);
            } else {
                cats.sort((a, b) => sortState.modal.asc ? a.amount - b.amount : b.amount - a.amount);
            }

            cats.forEach(cat => {
                // Escape single quotes in category name for onclick
                const escapedCategory = cat.category.replace(/'/g, "\\'");
                let row = `
                    <tr onclick="showCategoryItems('${escapedCategory}', '${storeId}')" style="cursor: pointer;" title="ุงุถุบุท ูุนุฑุถ ุฌููุน ุงูููุชุฌุงุช">
                        <td class="fw-bold text-center text-primary">${cat.category} <small class="text-muted">โต</small></td>
                        <td dir="ltr" class="text-center ${currentMetric === 'qty' ? 'bg-light fw-bold' : ''}">${cat.qty}</td>
                        <td class="text-center ${currentMetric === 'val' ? 'bg-light fw-bold' : ''}">${cat.amount.toLocaleString()}</td>
                        <td class="text-center">
                            <a href="#" onclick="event.stopPropagation(); openProductDetails('${cat.top_item_id}', '${cat.top_item_name}', '${cat.category}', ${cat.top_item_qty}, ${cat.top_item_amount}); return false;" class="text-decoration-none fw-bold text-dark small d-block text-truncate hover-primary" style="max-width: 200px; margin: 0 auto;" title="${cat.top_item_name}">${cat.top_item_name}</a>
                            <small class="text-muted d-block" style="font-size: 0.75em;">${cat.top_item_id}</small>
                        </td>
                        <td dir="ltr" class="text-center small">${cat.top_item_qty}</td>
                        <td class="text-center small fw-bold">${cat.top_item_amount.toLocaleString()}</td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });

            if (!detailsModalObj) detailsModalObj = new bootstrap.Modal(document.getElementById('detailsModal'));
            detailsModalObj.show();
        }

        function showCategoryItems(categoryName, storeId) {
            // Get catalog data for current period
            const pData = rawData.periods ? rawData.periods[currentMode] : null;
            const catalog = pData ? (pData.catalog || {}) : {};

            // Get items for this category
            let items = catalog[categoryName] || [];

            // Get store name for display
            const meta = storeMeta[storeId] || {};
            const storeName = meta.name_ar || meta.name || storeId;

            // Period display names
            const periodNames = {
                'mtd': 'ูู ุจุฏุงูุฉ ุงูุดูุฑ',
                'yest': 'ุฃูุณ',
                '7d': 'ุขุฎุฑ 7 ุฃูุงู',
                '14d': 'ุขุฎุฑ 14 ููู',
                '30d': 'ุขุฎุฑ 30 ููู'
            };

            // Update modal header
            document.getElementById('catItemsTitle').textContent = `ููุชุฌุงุช: ${categoryName}`;
            document.getElementById('catItemsSubtitle').textContent = `${storeName} | ${periodNames[currentMode] || currentMode}`;

            // Populate table
            const tbody = document.getElementById('catItemsBody');
            tbody.innerHTML = '';

            const noDataDiv = document.getElementById('catItemsNoData');

            if (items.length === 0) {
                noDataDiv.classList.remove('d-none');
                tbody.parentElement.classList.add('d-none');
            } else {
                noDataDiv.classList.add('d-none');
                tbody.parentElement.classList.remove('d-none');

                // Sort by amount descending
                items = [...items].sort((a, b) => b.amount - a.amount);

                items.forEach((item, i) => {
                    let row = `
                        <tr onclick="closeCategoryItemsAndOpenProduct('${item.id}', '${item.name.replace(/'/g, "\\'")}', '${categoryName}', ${item.qty}, ${item.amount})" style="cursor: pointer;">
                            <td class="text-center">${i + 1}</td>
                            <td>
                                <span class="fw-bold text-dark">${item.name}</span>
                                <small class="text-muted d-block">${item.id}</small>
                            </td>
                            <td class="text-center">${item.qty}</td>
                            <td class="text-center fw-bold text-success">${Math.round(item.amount).toLocaleString()}</td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                });
            }

            // Show modal
            if (!categoryItemsModalObj) categoryItemsModalObj = new bootstrap.Modal(document.getElementById('categoryItemsModal'));
            categoryItemsModalObj.show();
        }

        function closeCategoryItemsAndOpenProduct(id, name, cat, qty, amt) {
            if (categoryItemsModalObj) categoryItemsModalObj.hide();
            setTimeout(() => {
                openProductDetails(id, name, cat, qty, amt);
            }, 150);
        }

        // ==========================================
        // PRODUCT DETAILS LOGIC
        // ==========================================

        function openProductDetails(itemId, name, category, totalQty, totalAmt) {
            // 1. Setup Modal Header
            document.getElementById('prodModalName').textContent = name;
            document.getElementById('prodModalId').textContent = `${itemId} | ${category}`;

            // 2. Get History
            let history = [];
            if (rawData.product_daily_history && rawData.product_daily_history[itemId]) {
                history = rawData.product_daily_history[itemId];
            } else {
                // No mock data - show empty
            }

            // 3. Render KPIs
            if (history.length === 0) {
                document.getElementById('pmBestDay').textContent = '-';
                document.getElementById('pmBestDayVal').textContent = '-';
                document.getElementById('pmWorstDay').textContent = '-';
                document.getElementById('pmWorstDayVal').textContent = '-';
                document.getElementById('pmZeroDays').textContent = '-';

                renderTrendUI('STABLE', [], 'ูุง ุชูุฌุฏ ุจูุงูุงุช');
                renderProductChart([]);
            } else {
                // Sort by Date for Chart/Trend
                history.sort((a, b) => new Date(a.date) - new Date(b.date));

                // Sort by Value for Best/Worst
                const sortedByVal = [...history].sort((a, b) => b.amount - a.amount);
                const best = sortedByVal[0];
                const worst = sortedByVal[sortedByVal.length - 1];
                const zeroDays = history.filter(d => d.amount === 0).length;

                document.getElementById('pmBestDay').textContent = best.date;
                document.getElementById('pmBestDayVal').textContent = Math.round(best.amount).toLocaleString() + ' SR';

                document.getElementById('pmWorstDay').textContent = worst.amount > 0 ? worst.date : '-';
                document.getElementById('pmWorstDayVal').textContent = Math.round(worst.amount).toLocaleString() + ' SR';

                document.getElementById('pmZeroDays').textContent = zeroDays + ' ููู';

                // Trend Analysis
                const trendInfo = calculateRealTrend(history);
                const alerts = detectAlerts(history);
                renderTrendUI(trendInfo.direction, alerts, trendInfo.reason);

                // Render Chart
                renderProductChart(history);
            }

            // 4. Related Products (Market Basket)
            const relatedList = document.getElementById('modalRelatedItems');
            relatedList.innerHTML = '';

            const allBasketData = rawData.market_basket || {};
            // Use activeStore basket if available, else global
            let basketData = allBasketData[activeStore] || allBasketData['all'] || [];

            // If activeStore is 'all' but we want specific store data? No, if activeStore is global, we show global.
            // But if activeStore is specific, 'basketData' will be that store's data (if > 5 sales).

            const related = basketData.filter(p => p.item_a_id == itemId || p.item_b_id == itemId);

            if (related.length === 0) {
                relatedList.innerHTML = '<li class="list-group-item text-muted text-center small">ูุง ุชูุฌุฏ ุจูุงูุงุช ุฑุจุท ููุฐุง ุงูููุชุฌ</li>';
            } else {
                related.sort((a, b) => b.frequency - a.frequency);
                related.slice(0, 5).forEach(p => {
                    const isA = (p.item_a_id == itemId);
                    const otherId = isA ? p.item_b_id : p.item_a_id;
                    const otherName = isA ? p.item_b_name : p.item_a_name;

                    let html = `
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <div>
                                <span class="fw-bold">${otherName}</span>
                                <small class="text-muted ms-2">${otherId}</small>
                            </div>
                            <span class="badge bg-primary rounded-pill">${p.frequency} ูุฑุฉ</span>
                        </li>
                    `;
                    relatedList.innerHTML += html;
                });
            }

            if (!productModalObj) productModalObj = new bootstrap.Modal(document.getElementById('productModal'));
            productModalObj.show();
        }

        function calculateRealTrend(history) {
            if (history.length < 3) return { direction: 'STABLE', reason: 'ุจูุงูุงุช ุบูุฑ ูุงููุฉ' };

            // Moving Average Logic: Compare Last 3 Days Avg vs Previous 14 Days Avg
            const last3 = history.slice(-3);
            const prevStart = Math.max(0, history.length - 17);
            const prev14 = history.slice(prevStart, history.length - 3);

            if (prev14.length === 0) return { direction: 'STABLE', reason: 'ุจูุงูุงุช ุญุฏูุซุฉ' };

            const avgCurrent = last3.reduce((s, d) => s + d.amount, 0) / last3.length;
            const avgPrev = prev14.reduce((s, d) => s + d.amount, 0) / prev14.length;

            if (avgPrev === 0) {
                return avgCurrent > 0 ? { direction: 'UP', reason: 'ุจุฏุงูุฉ ุงููุจูุนุงุช' } : { direction: 'STABLE', reason: 'ูุง ุชูุฌุฏ ูุจูุนุงุช' };
            }

            const change = ((avgCurrent - avgPrev) / avgPrev) * 100;

            if (change > 15) return { direction: 'UP', reason: `ุงุฑุชูุงุน +${Math.round(change)}% ุนู ุงููุชูุณุท` };
            if (change < -15) return { direction: 'DOWN', reason: `ุงูุฎูุงุถ ${Math.round(change)}% ุนู ุงููุชูุณุท` };

            return { direction: 'STABLE', reason: 'ุฃุฏุงุก ูุณุชูุฑ' };
        }

        function detectAlerts(history) {
            const alerts = [];
            if (history.length > 5) {
                const avg = history.reduce((s, d) => s + d.amount, 0) / history.length;
                const last = history[history.length - 1];

                if (avg > 0 && last.amount > avg * 2.5) {
                    alerts.push({ type: 'spike', msg: 'ุงุฑุชูุงุน ููุงุฌุฆ ุงูููู!' });
                }
                if (avg > 100 && last.amount === 0) {
                    alerts.push({ type: 'drop', msg: 'ุชููู ุงููุจูุนุงุช ุงูููู' });
                }
            }
            return alerts;
        }

        function renderTrendUI(trend, alerts, reason) {
            const box = document.getElementById('trendAlertBox');
            const icon = document.getElementById('trendIcon');
            const text = document.getElementById('trendText');

            box.className = 'alert d-flex align-items-center mb-0';

            let html = '';
            if (trend === 'UP') {
                box.classList.add('alert-success');
                icon.innerHTML = '๐น';
                html = `<strong>ุฃุฏุงุก ูุชุตุงุนุฏ:</strong> ${reason}`;
            } else if (trend === 'DOWN') {
                box.classList.add('alert-danger');
                icon.innerHTML = '๐ป';
                html = `<strong>ุฃุฏุงุก ูุชุฑุงุฌุน:</strong> ${reason}`;
            } else {
                box.classList.add('alert-secondary');
                icon.innerHTML = 'โ';
                html = `<strong>ุฃุฏุงุก ูุณุชูุฑ:</strong> ${reason}`;
            }

            if (alerts.length > 0) {
                html += '<div class="mt-1 border-top pt-1">';
                alerts.forEach(a => {
                    html += `<div class="badge bg-warning text-dark me-1">โ๏ธ ${a.msg}</div>`;
                });
                html += '</div>';
            }
            text.innerHTML = html;
        }

        function renderProductChart(history) {
            const ctx = document.getElementById('productTrendChart').getContext('2d');
            if (window.prodChart) window.prodChart.destroy();

            if (!history || history.length === 0) {
                document.getElementById('productTrendChart').style.display = 'none';
                document.getElementById('chartNoDataMsg').classList.remove('d-none');
                return;
            } else {
                document.getElementById('productTrendChart').style.display = 'block';
                document.getElementById('chartNoDataMsg').classList.add('d-none');
            }

            const labels = history.map(d => d.date);
            const dataVal = history.map(d => currentMetric === 'qty' ? d.qty : d.amount);
            const labelStr = currentMetric === 'qty' ? 'ุงููููุฉ' : 'ุงููุจูุนุงุช';
            const color = currentMetric === 'qty' ? '#0d6efd' : '#fe7900';

            window.prodChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: labelStr,
                        data: dataVal,
                        borderColor: color,
                        backgroundColor: color + '20',
                        fill: true,
                        tension: 0.3,
                        pointRadius: 3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { beginAtZero: true, grid: { borderDash: [2, 2] } },
                        x: { grid: { display: false }, ticks: { maxTicksLimit: 7 } }
                    }
                }
            });
        }

        // ==========================================
        // CATALOG / ACCORDION SEARCH LOGIC
        // ==========================================

        function openCatalogModal() {
            renderCatalog();
            if (!catalogModalObj) catalogModalObj = new bootstrap.Modal(document.getElementById('catalogModal'));
            catalogModalObj.show();
        }

        function closeCatalogAndOpenProduct(id, name, cat, qty, amt) {
            if (catalogModalObj) catalogModalObj.hide();
            setTimeout(() => {
                openProductDetails(id, name, cat, qty, amt);
            }, 150);
        }

        // ==========================================
        // PDF EXPORT UI HELPERS
        // ==========================================

        function openPdfModal() {
            populatePdfStoreSelect();
            new bootstrap.Modal('#pdfExportModal').show();
        }

        function populatePdfStoreSelect() {
            const sel = document.getElementById('pdfStoreSelect');
            sel.innerHTML = '<option value="all">ุงููู (ุญุณุจ ุงูููุชุฑ ุงูุญุงูู)</option>';

            // Use currentData to get names as they appear in the table
            let accessibleStores = [];

            // currentData keys are store IDs
            if (currentData) {
                Object.keys(currentData).forEach(sid => {
                    // Check permission
                    if (isStoreAccessible(sid)) {
                        const store = currentData[sid];
                        const m = storeMeta[sid] || {};
                        // Prioritize store_name from data (which comes from backend/meta usually)
                        const name = store.store_name || m.name_ar || m.name || sid;

                        accessibleStores.push({
                            id: sid,
                            name: name
                        });
                    }
                });
            }

            // Sort by Name
            accessibleStores.sort((a, b) => a.name.localeCompare(b.name));

            accessibleStores.forEach(s => {
                const opt = document.createElement('option');
                opt.value = s.id;
                opt.textContent = s.name;
                sel.appendChild(opt);
            });

            // Set default if activeStore is selected in dashboard
            if (activeStore !== 'all') {
                sel.value = activeStore;
                togglePdfDetailOption();
            }
        }

        function togglePdfDetailOption() {
            const val = document.getElementById('pdfStoreSelect').value;
            const div = document.getElementById('divPdfDetailed');
            if (val === 'all') {
                div.style.display = 'block';
            } else {
                div.style.display = 'none';
                document.getElementById('chkPdfDetailed').checked = false;
            }
        }

        function renderCatalog(filter = '') {
            const container = document.getElementById('categoryAccordion');
            container.innerHTML = '';

            const pData = rawData.periods ? rawData.periods[currentMode] : null;
            const catalog = pData ? (pData.catalog || {}) : {};

            const categories = Object.keys(catalog).sort();

            if (categories.length === 0) {
                if (filter === '') container.innerHTML = '<div class="text-center text-muted p-4">ูุง ุชูุฌุฏ ุจูุงูุงุช ููุฑุณ ูุชุงุญุฉ ูู ูุฐู ุงููุชุฑุฉ.</div>';
                // If filter is active but no cats, logic below handles it
            }

            let hasMatches = false;
            filter = filter.toLowerCase();

            categories.forEach((cat, index) => {
                const items = catalog[cat];
                const filteredItems = items.filter(item => {
                    return filter === '' ||
                        item.name.toLowerCase().includes(filter) ||
                        item.id.includes(filter) ||
                        cat.toLowerCase().includes(filter);
                });

                const isCatMatch = cat.toLowerCase().includes(filter);
                const showItems = isCatMatch ? items : filteredItems;
                if (showItems.length === 0) return;

                hasMatches = true;
                const headerId = `heading${index}`;
                const collapseId = `collapse${index}`;
                const isExpanded = filter !== '';
                const btnClass = isExpanded ? '' : 'collapsed';
                const divClass = isExpanded ? 'show' : '';

                let itemsHtml = '<ul class="list-group list-group-flush">';
                showItems.forEach(item => {
                    // Trend Badge
                    let trendBadge = '';
                    if (item.trend === 'UP') trendBadge = '<span class="badge bg-success-subtle text-success ms-2" style="font-size:0.7em">โ ุตุนูุฏ</span>';
                    else if (item.trend === 'DOWN') trendBadge = '<span class="badge bg-danger-subtle text-danger ms-2" style="font-size:0.7em">โ ูุฒูู</span>';

                    itemsHtml += `
                    <li class="list-group-item list-group-item-action d-flex justify-content-between align-items-center" 
                        role="button"
                        onclick="closeCatalogAndOpenProduct('${item.id}', '${item.name}', '${cat}', ${item.qty}, ${item.amount})">
                        <div>
                            <div class="fw-bold text-dark">${item.name} ${trendBadge}</div>
                            <small class="text-muted">${item.id}</small>
                        </div>
                        <div class="text-end">
                            <div class="badge bg-light text-dark border">${item.qty} pcs</div>
                            <div class="fw-bold small text-primary">${Math.round(item.amount).toLocaleString()}</div>
                        </div>
                    </li>
                `;
                });
                itemsHtml += '</ul>';

                const accordionItem = `
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="${headerId}">
                            <button class="accordion-button ${btnClass} fw-bold" type="button" data-bs-toggle="collapse" data-bs-target="#${collapseId}" aria-expanded="${isExpanded}" aria-controls="${collapseId}">
                                ${cat} 
                                <span class="badge bg-secondary ms-2 rounded-pill">${showItems.length}</span>
                            </button>
                        </h2>
                        <div id="${collapseId}" class="accordion-collapse collapse ${divClass}" aria-labelledby="${headerId}" data-bs-parent="#categoryAccordion">
                            <div class="accordion-body p-0">
                                ${itemsHtml}
                            </div>
                        </div>
                    </div>
                `;
                container.innerHTML += accordionItem;
            });

            const noDataMsg = document.getElementById('catalogNoData');
            if (noDataMsg) {
                if (!hasMatches) noDataMsg.classList.remove('d-none');
                else noDataMsg.classList.add('d-none');
            }
        }

        function filterCatalog() {
            const query = document.getElementById('catalogSearch').value;
            renderCatalog(query);
        }

        // Run
        init();


    </script>
</body>

</html>