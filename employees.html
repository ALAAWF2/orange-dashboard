<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Orange | Ø£Ø¯Ø§Ø¡ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</title>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            --bs-primary: #fe7900;
            --bg-light: #f8f9fa;
            --card-radius: 12px;
            --font-main: 'Tajawal', sans-serif;
        }

        body {
            font-family: var(--font-main);
            background-color: var(--bg-light);
        }

        .navbar {
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            background: white !important;
        }

        .navbar-brand {
            font-weight: 800;
        }

        .brand-orange {
            color: #fe7900;
        }

        .kpi-card {
            background: white;
            border-radius: var(--card-radius);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.03);
            padding: 20px;
            height: 100%;
            transition: transform 0.2s;
        }

        .kpi-card:hover {
            transform: translateY(-3px);
        }

        .section-title {
            font-weight: 700;
            margin-bottom: 20px;
            border-right: 4px solid #fe7900;
            padding-right: 10px;
        }

        .table-custom thead th {
            background-color: #fe7900;
            color: white;
            font-weight: 500;
            border: none;
        }

        .table-custom tbody tr:hover {
            background-color: #fff3e0;
        }

        .rank-badge {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.85rem;
        }

        .rank-1 {
            background: linear-gradient(135deg, #FFD700, #FFA500);
            color: white;
        }

        .rank-2 {
            background: linear-gradient(135deg, #C0C0C0, #A0A0A0);
            color: white;
        }

        .rank-3 {
            background: linear-gradient(135deg, #CD7F32, #8B4513);
            color: white;
        }

        .rank-other {
            background: #e9ecef;
            color: #495057;
        }

        .progress-thin {
            height: 8px;
            border-radius: 4px;
        }

        .emp-card {
            background: white;
            border-radius: var(--card-radius);
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            border-left: 4px solid #fe7900;
        }

        .chart-container {
            background: white;
            padding: 20px;
            border-radius: var(--card-radius);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.03);
            min-height: 300px;
        }

        .text-orange {
            color: #fe7900;
        }

        .bg-orange {
            background-color: #fe7900;
        }
    </style>
</head>

<body>

    <!-- Navbar -->
    <nav class="navbar mb-4 sticky-top">
        <div class="container-fluid">
            <span class="navbar-brand"><span class="brand-orange">ORANGE</span> EMPLOYEES</span>
            <div class="d-flex gap-2 align-items-center">
                <span class="badge bg-light text-dark border" id="lastUpdate">...</span>
                <a href="index.html" class="btn btn-outline-secondary btn-sm fw-bold">ğŸ  Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
                <button onclick="generateEmployeePDF()" class="btn btn-warning btn-sm fw-bold text-white">ğŸ“„ ØªØµØ¯ÙŠØ±
                    PDF</button>
                <button onclick="logout()" class="btn btn-danger btn-sm fw-bold">Ø®Ø±ÙˆØ¬</button>
            </div>
        </div>
    </nav>

    <!-- JS Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <script src="assets/amiri_font.js"></script>
    <script src="pdf_export_employees.js"></script>

    <script>
        const currentUser = JSON.parse(localStorage.getItem('currentUser'));
        if (!currentUser) {
            window.location.href = 'login.html';
        }

        function logout() {
            localStorage.removeItem('currentUser');
            window.location.href = 'login.html';
        }
    </script>

    <div class="container-fluid px-4">

        <!-- Filters -->
        <div class="card border-0 shadow-sm p-3 mb-4">
            <div class="row align-items-end g-2">
                <!-- Manager -->
                <div class="col-md-2 col-lg-2">
                    <label class="form-label small text-muted fw-bold mb-1">Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ù†Ø·Ù‚Ø©</label>
                    <select id="managerFilter" class="form-select form-select-sm" onchange="updatePage()">
                        <option value="all">Ø§Ù„ÙƒÙ„</option>
                    </select>
                </div>
                <!-- Branch -->
                <div class="col-md-2 col-lg-2">
                    <label class="form-label small text-muted fw-bold mb-1">Ø§Ù„ÙØ±Ø¹</label>
                    <select id="branchFilter" class="form-select form-select-sm" onchange="updatePage()">
                        <option value="all">ÙƒØ§ÙØ© Ø§Ù„ÙØ±ÙˆØ¹</option>
                    </select>
                </div>
                <!-- Period -->
                <div class="col-md-3 col-lg-3">
                    <label class="form-label small text-muted fw-bold mb-1">Ø§Ù„ÙØªØ±Ø©</label>
                    <select id="periodFilter" class="form-select form-select-sm" onchange="updatePage()">
                        <option value="mtd" selected>Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ (MTD)</option>
                        <option value="yesterday">ÙŠÙˆÙ… Ø£Ù…Ø³ (Yesterday)</option>
                        <option value="today">Ø§Ù„ÙŠÙˆÙ… (Today)</option>
                    </select>
                </div>
                <!-- Sort -->
                <div class="col-md-2 col-lg-2">
                    <label class="form-label small text-muted fw-bold mb-1">ØªØ±ØªÙŠØ¨ Ø­Ø³Ø¨</label>
                    <select id="sortBy" class="form-select form-select-sm" onchange="updatePage()">
                        <option value="sales">Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</option>
                        <option value="achievement">Ù†Ø³Ø¨Ø© Ø§Ù„ØªØ­Ù‚ÙŠÙ‚ (Target %)</option>
                        <option value="transactions">Ø§Ù„ÙÙˆØ§ØªÙŠØ±</option>
                        <option value="avg_ticket">Ù…Ø¹Ø¯Ù„ Ø§Ù„ÙØ§ØªÙˆØ±Ø©</option>
                        <option value="items_per_inv">Ù…ØªÙˆØ³Ø· Ø§Ù„Ù‚Ø·Ø¹</option>
                    </select>
                </div>
                <!-- Search -->
                <div class="col-md-2 col-lg-2">
                    <label class="form-label small text-muted fw-bold mb-1">Ø¨Ø­Ø« Ù…ÙˆØ¸Ù</label>
                    <input type="text" id="searchEmp" class="form-control form-control-sm" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù..."
                        oninput="updatePage()">
                </div>
                <!-- Update Button -->
                <div class="col-md-1 col-lg-1">
                    <button class="btn btn-primary btn-sm w-100 fw-bold" onclick="updatePage()">
                        <span class="d-none d-md-inline">ğŸ”„</span>
                        <span class="d-md-none">ØªØ­Ø¯ÙŠØ«</span>
                    </button>
                </div>
            </div>

            <!-- Summary KPIs -->
            <div class="row g-3 mb-4">
                <div class="col-md-3">
                    <div class="kpi-card border-bottom border-4 border-warning">
                        <div class="text-muted small">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</div>
                        <div class="fs-3 fw-bold" id="totalEmployees">0</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="kpi-card border-bottom border-4 border-success">
                        <div class="text-muted small">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</div>
                        <div class="fs-3 fw-bold" id="totalSales">0</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="kpi-card border-bottom border-4 border-primary">
                        <div class="text-muted small" id="avgSalesPerEmpLabel">Ù…ØªÙˆØ³Ø· Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª/Ù…ÙˆØ¸Ù</div>
                        <div class="fs-3 fw-bold" id="avgSalesPerEmp">0</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="kpi-card border-bottom border-4 border-info">
                        <div class="text-muted small">Ø£Ø¹Ù„Ù‰ Ù…ÙˆØ¸Ù</div>
                        <div class="fs-5 fw-bold text-truncate" id="topEmployee">-</div>
                        <div class="small text-muted" id="topEmployeeSales">-</div>
                    </div>
                </div>
            </div>

            <!-- Top 10 Chart Section (Moved Up) -->
            <div class="row g-3 mb-4">
                <div class="col-12">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h5 class="section-title mb-0">ğŸ“Š ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† (Charts)</h5>
                        <!-- Chart Controls -->
                        <div class="d-flex gap-2">
                            <select id="chartMetric" class="form-select form-select-sm" onchange="updatePage()"
                                style="width: auto;">
                                <option value="sales">Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</option>
                                <option value="achievement">Ù†Ø³Ø¨Ø© Ø§Ù„ØªØ­Ù‚ÙŠÙ‚ %</option>
                                <option value="max_ticket">Ø£Ø¹Ù„Ù‰ Ù‚ÙŠÙ…Ø© ÙØ§ØªÙˆØ±Ø©</option>
                                <option value="avg_ticket">Ù…Ø¹Ø¯Ù„ Ø§Ù„ÙØ§ØªÙˆØ±Ø©</option>
                                <option value="items_per_inv">Ù…ØªÙˆØ³Ø· Ø§Ù„Ù‚Ø·Ø¹</option>
                            </select>
                            <select id="chartSort" class="form-select form-select-sm" onchange="updatePage()"
                                style="width: auto;">
                                <option value="desc">Ø§Ù„Ø£Ø¹Ù„Ù‰ (Top 10)</option>
                                <option value="asc">Ø§Ù„Ø£Ù‚Ù„ (Bottom 10)</option>
                            </select>
                        </div>
                    </div>
                    <div class="card border-0 shadow-sm" style="height: 300px;">
                        <div class="table-responsive h-100">
                            <table class="table table-sm table-striped table-hover mb-0 sticky-header">
                                <thead class="table-light sticky-top" style="z-index: 1;">
                                    <tr>
                                        <th style="width: 50px;">#</th>
                                        <th>Ø§Ù„Ù…ÙˆØ¸Ù</th>
                                        <th class="text-end">Ø§Ù„Ù‚ÙŠÙ…Ø©</th>
                                    </tr>
                                </thead>
                                <tbody id="top10Body">
                                    <!-- Populated by JS -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row">
                <!-- Leaderboard Table (Full Width) -->
                <div class="col-12">
                    <h5 class="section-title">ğŸ† ØªØ±ØªÙŠØ¨ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† (Leaderboard)</h5>
                    <div class="card border-0 shadow-sm p-3">
                        <div class="table-responsive" style="max-height: 500px; overflow-y: auto;">
                            <table class="table table-custom table-hover align-middle mb-0">
                                <thead class="sticky-top">
                                    <tr>
                                        <th>#</th>
                                        <th>Ø§Ù„Ù…ÙˆØ¸Ù</th>
                                        <th class="d-none d-md-table-cell">Ø§Ù„ÙØ±Ø¹</th>
                                        <th>Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</th>
                                        <th class="text-center">Ø§Ù„Ù‡Ø¯Ù</th>
                                        <th class="text-center">Ø§Ù„ØªØ­Ù‚ÙŠÙ‚ %</th>
                                        <th class="text-center">Ø§Ù„ÙŠÙˆÙ…ÙŠØ© Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©</th>
                                        <th class="d-none d-md-table-cell">Ø§Ù„ÙÙˆØ§ØªÙŠØ±</th>
                                        <th class="d-none d-md-table-cell">Ù…Ø¹Ø¯Ù„ Ø§Ù„ÙØ§ØªÙˆØ±Ø©</th>
                                        <th class="d-none d-md-table-cell">Ù…ØªÙˆØ³Ø· Ø§Ù„Ù‚Ø·Ø¹</th>
                                    </tr>
                                </thead>
                                <tbody id="leaderboardBody">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

        </div>

        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

        <script>
            // Global Data
            let historyData = {};
            let targetsData = {};
            let storesData = {};
            let storeMeta = {}; // To store manager info
            let employeeNames = {}; // New: Arabic names map
            let top10Chart, branchChart;

            // Fetch Data
            async function loadData() {
                const timestamp = new Date().getTime();
                try {
                    const [empRes, mgmtRes] = await Promise.all([
                        fetch('employees_data.json?v=' + timestamp),
                        fetch('management_data.json?v=' + timestamp)
                    ]);

                    const empJson = await empRes.json();
                    historyData = empJson.history;
                    targetsData = empJson.targets;
                    employeeNames = empJson.employee_names || {};

                    const mgmtJson = await mgmtRes.json();
                    storesData = mgmtJson.stores;
                    storeMeta = mgmtJson.store_meta || {};

                    populateFilters();
                    updatePage();

                    // Debug: Show record count
                    const totalStores = Object.keys(historyData).length;
                    document.getElementById('lastUpdate').textContent = new Date().toLocaleDateString('ar-SA') + ` (Stores:
    ${totalStores})`;

                } catch (err) {
                    console.error("Error loading data:", err);
                    document.getElementById('lastUpdate').textContent = "Error loading data: " + err.message;
                    document.getElementById('lastUpdate').className = "badge bg-danger";
                }
            }

            function populateFilters() {
                // Managers
                const managerSelect = document.getElementById('managerFilter');
                const managers = new Set();
                Object.values(storeMeta).forEach(meta => {
                    if (meta.manager && meta.manager !== 'online') {
                        managers.add(meta.manager);
                    }
                });
                Array.from(managers).sort().forEach(m => {
                    const opt = document.createElement('option');
                    opt.value = m;
                    opt.textContent = m;
                    managerSelect.appendChild(opt);
                });

                // Branches
                const branchSelect = document.getElementById('branchFilter');
                const branches = Object.keys(historyData || {});
                branches.forEach(code => {
                    const name = storesData[code] || code;
                    const opt = document.createElement('option');
                    opt.value = code;
                    opt.textContent = name;
                    branchSelect.appendChild(opt);
                });
            }

            function updatePage() {
                let managerFilter = document.getElementById('managerFilter').value;

                // Enforce Permissions
                if (currentUser.role !== 'Admin') {
                    managerFilter = currentUser.name;
                    // Also lock UI
                    const mf = document.getElementById('managerFilter');
                    if (mf.value !== currentUser.name) {
                        mf.value = currentUser.name;
                        mf.parentElement.style.display = 'none';
                    }
                }

                const branchFilter = document.getElementById('branchFilter').value;
                const periodFilter = document.getElementById('periodFilter').value;
                const sortBy = document.getElementById('sortBy').value;
                const searchTerm = document.getElementById('searchEmp').value.toLowerCase();

                // Aggregate employee data
                const empAgg = {};
                const history = historyData || {};
                const targets = targetsData || {};

                // Date Filters
                const today = new Date();
                // Local YYYY-MM-DD
                const toLocalYMD = (d) => {
                    const y = d.getFullYear();
                    const m = String(d.getMonth() + 1).padStart(2, '0');
                    const day = String(d.getDate()).padStart(2, '0');
                    return `${y}-${m}-${day}`;
                };

                const todayStr = toLocalYMD(today);
                const todayYear = today.getFullYear();
                const todayMonth = today.getMonth(); // 0-11
                const todayDay = today.getDate();
                const todayVal = todayYear * 10000 + (todayMonth + 1) * 100 + todayDay; // YYYYMMDD numeric for comparison

                const currentMonthPrefix = todayStr.slice(0, 7); // YYYY-MM

                // Calculate Yesterday
                const yesterday = new Date(today);
                yesterday.setDate(yesterday.getDate() - 1);
                const yesterdayStr = toLocalYMD(yesterday);

                const filterDate = (dateStr) => {
                    const d = new Date(dateStr);
                    const dYear = d.getFullYear();
                    const dMonth = d.getMonth();
                    const dDay = d.getDate();
                    const dVal = dYear * 10000 + (dMonth + 1) * 100 + dDay;

                    if (periodFilter === 'mtd') {
                        // MTD Logic
                        // Must be same month & year
                        // Must be <= today
                        if (dYear === todayYear && dMonth === todayMonth) {
                            return dVal <= todayVal;
                        }
                        return false;
                    } else if (periodFilter === 'mtd_yest') {
                        // MTD until yesterday
                        // Must be same month & year
                        // Must be < today
                        if (dYear === todayYear && dMonth === todayMonth) {
                            return dVal < todayVal;
                        }
                        return false;
                    } else if (periodFilter === 'yesterday') {
                        return dateStr === yesterdayStr;
                    } else if (periodFilter === 'today') {
                        return dateStr === todayStr;
                    }
                    return true; // Should not happen with current options
                };

                Object.entries(history).forEach(([storeCode, records]) => {
                    // Filter by Branch
                    if (branchFilter !== 'all' && branchFilter !== storeCode) return;

                    // Filter by Manager
                    // If manager is selected, check if this store belongs to that manager
                    // Some stores might not use storeMeta, fallback safely
                    if (managerFilter !== 'all') {
                        const meta = storeMeta[storeCode];
                        if (!meta || meta.manager !== managerFilter) {
                            return;
                        }
                    }

                    records.forEach(rec => {
                        // Data Format: [Date, Name, Sales, Trans, Items, MaxTicket]
                        const [date, rawName, sales, trans, items, maxTicket] = rec;
                        if (!filterDate(date)) return;

                        // Clean Name & Extract ID
                        let empName = rawName;
                        let empId = rawName;

                        if (rawName.includes('-')) {
                            const parts = rawName.split('-');
                            empId = parts[0].trim();
                            empName = parts[1].trim();
                        } else {
                            // Fallback for names without ID prefix
                            empId = rawName;
                        }

                        // Handle Unknown/System employees
                        // User requested to show Unknown employees as is.
                        // Only exclude 'merger' (returns aggregation) if desired.
                        if (empName === 'Ù…Ø±ØªØ¬Ø¹') return;

                        // Use Arabic Name if available
                        if (employeeNames[empId]) {
                            empName = employeeNames[empId];
                        }

                        // Unique Key: ID preferred, else Name+Store
                        const key = empId;

                        if (!empAgg[key]) {
                            // Lookup Target (Only relevant if MTD, but we store it anyway)
                            let monthlyTarget = targets[empId] || 0;

                            empAgg[key] = {
                                id: empId,
                                name: empName,
                                storeCode: storeCode,
                                storeName: storesData[storeCode] || storeCode,
                                sales: 0,
                                transactions: 0,
                                items: 0,
                                max_ticket: 0,
                                target: monthlyTarget
                            };
                        }

                        empAgg[key].sales += sales || 0;
                        empAgg[key].transactions += trans || 0;
                        empAgg[key].items += items || 0;
                        if (maxTicket > empAgg[key].max_ticket) {
                            empAgg[key].max_ticket = maxTicket;
                        }
                    });
                });

                // Convert to array
                let empList = Object.values(empAgg).filter(e => e.sales > 0 || e.transactions > 0);

                // Search filter
                if (searchTerm) {
                    empList = empList.filter(e => e.name.toLowerCase().includes(searchTerm));
                }

                // Calculate metrics
                empList.forEach(e => {
                    e.avg_ticket = e.transactions > 0 ? e.sales / e.transactions : 0;
                    // Items per Basket (previously conversion)
                    // Items are stored negative for sales, positive for returns.
                    // We want strict "Activity Strength".
                    // Net items sold is Sum(Items) which will remain negative if sales > returns.
                    // We display absolute value.
                    e.items_per_inv = e.transactions > 0 ? Math.abs(e.items) / e.transactions : 0;

                    // Achievement (Only valid for MTD typically)
                    e.achievement = 0;
                    if (e.target > 0) {
                        if (periodFilter === 'mtd' || periodFilter === 'mtd_yest') {
                            e.achievement = (e.sales / e.target) * 100;
                        } else {
                            // For other periods, showing monthly target achievement might be misleading.
                            e.achievement = 0;
                        }
                    }
                });

                // Sort
                if (sortBy === 'conversion') {
                    // Backward compatibility if someone had it cached
                    empList.sort((a, b) => b.items_per_inv - a.items_per_inv);
                } else if (sortBy === 'items_per_inv') {
                    empList.sort((a, b) => b.items_per_inv - a.items_per_inv);
                } else if (sortBy === 'achievement') {
                    empList.sort((a, b) => b.achievement - a.achievement);
                } else {
                    empList.sort((a, b) => b[sortBy] - a[sortBy]);
                }

                // Update KPIs
                const totalSales = empList.reduce((s, e) => s + e.sales, 0);
                const totalTarget = empList.reduce((s, e) => s + (periodFilter === 'mtd' ? e.target : 0), 0);

                document.getElementById('totalEmployees').textContent = empList.length.toLocaleString();
                document.getElementById('totalSales').textContent = totalSales.toLocaleString('en-US', { maximumFractionDigits: 0 })
                    ;

                // KPI 3: Avg Achievement or Avg Sales
                if (periodFilter === 'mtd' && totalTarget > 0) {
                    const totalAch = (totalSales / totalTarget) * 100;
                    document.getElementById('avgSalesPerEmpLabel').textContent = 'Ù†Ø³Ø¨Ø© ØªØ­Ù‚ÙŠÙ‚ Ø§Ù„Ù‡Ø¯Ù';
                    document.getElementById('avgSalesPerEmp').textContent = totalAch.toFixed(1) + '%';
                    document.getElementById('avgSalesPerEmp').className = totalAch >= 80 ? 'fs-3 fw-bold text-success' : 'fs-3 fw-bold text-warning';
                } else {
                    document.getElementById('avgSalesPerEmpLabel').textContent = 'Ù…ØªÙˆØ³Ø· Ù…Ø¨ÙŠØ¹Ø§Øª/Ù…ÙˆØ¸Ù';
                    document.getElementById('avgSalesPerEmp').textContent = empList.length > 0
                        ? (totalSales / empList.length).toLocaleString('en-US', { maximumFractionDigits: 0 }) : '0';
                    document.getElementById('avgSalesPerEmp').className = 'fs-3 fw-bold';
                }

                if (empList.length > 0) {
                    // Find top by sales specifically for the card
                    const top = [...empList].sort((a, b) => b.sales - a.sales)[0];
                    document.getElementById('topEmployee').textContent = top.name;
                    document.getElementById('topEmployeeSales').textContent = top.sales.toLocaleString('en-US', {
                        maximumFractionDigits:
                            0
                    });
                }

                // Update table
                const tbody = document.getElementById('leaderboardBody');
                tbody.innerHTML = empList.slice(0, 100).map((emp, idx) => {
                    const rank = idx + 1;
                    const rankClass = rank === 1 ? 'rank-1' : rank === 2 ? 'rank-2' : rank === 3 ? 'rank-3' : 'rank-other';

                    // Target Display (Restored)
                    const showTarget = periodFilter === 'mtd' && emp.target > 0;
                    const targetText = showTarget ? emp.target.toLocaleString() : '-';

                    // Daily Required Calculation
                    const today = new Date();
                    const lastDayOfMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0).getDate();
                    const remainingDays = lastDayOfMonth - today.getDate() + 1;

                    let dailyReq = 0;
                    if (periodFilter === 'mtd' && emp.target > emp.sales && remainingDays > 0) {
                        dailyReq = (emp.target - emp.sales) / remainingDays;
                    }
                    const dailyReqText = dailyReq > 0 ? dailyReq.toLocaleString('en-US', { maximumFractionDigits: 0 }) : '-';


                    let achBadge = '<span class="text-muted">-</span>';
                    if (showTarget) {
                        let color = 'bg-secondary';
                        if (emp.achievement >= 100) color = 'bg-success';
                        else if (emp.achievement >= 80) color = 'bg-warning text-dark';
                        else color = 'bg-danger';

                        achBadge = `<span class="badge ${color}">${emp.achievement.toFixed(1)}%</span>`;
                    }

                    return `
    <tr>
        <td><span class="rank-badge ${rankClass}">${rank}</span></td>
        <td>
            <div class="fw-bold">${emp.name}</div>
            <small class="text-muted d-block d-md-none">${emp.storeName}</small>
        </td>
        <td class="d-none d-md-table-cell"><small class="text-muted">${emp.storeName}</small></td>
        <td class="fw-bold text-success" style="font-size:1.1em">${emp.sales.toLocaleString('en-US', {
                        maximumFractionDigits: 0
                    })}</td>
        <td class="text-center">${targetText}</td>
        <td class="text-center">${achBadge}</td>
        <td class="text-center fw-bold text-danger">${dailyReqText}</td>
        <td class="d-none d-md-table-cell">${emp.transactions}</td>
        <td class="d-none d-md-table-cell">${emp.avg_ticket.toLocaleString('en-US', { maximumFractionDigits: 0 })}</td>
        <td class="d-none d-md-table-cell">${emp.items_per_inv.toFixed(1)}</td>
    </tr>
    `;
                }).join('');

                // Update charts
                updateCharts(empList);
            }

            function updateCharts(empList) {
                const metric = document.getElementById('chartMetric').value;
                const sortOrder = document.getElementById('chartSort').value;

                // 1. Sort Data
                let sortedList = [...empList];
                sortedList.sort((a, b) => {
                    let valA = a[metric];
                    let valB = b[metric];
                    return sortOrder === 'desc' ? valB - valA : valA - valB;
                });

                // 2. Slice Top 10
                const top10 = sortedList.slice(0, 10);

                // 3. Populate Table
                const tbody = document.getElementById('top10Body');
                tbody.innerHTML = top10.map((e, index) => {
                    // Format Value
                    let valDisplay = e[metric];
                    if (metric === 'sales' || metric === 'avg_ticket' || metric === 'max_ticket') {
                        valDisplay = valDisplay.toLocaleString('en-US', { maximumFractionDigits: 0 });
                    } else if (metric === 'achievement') {
                        valDisplay = valDisplay.toFixed(1) + '%';
                    } else {
                        valDisplay = Math.round(valDisplay);
                    }

                    return `
                    <tr>
                        <td class="text-muted small">${index + 1}</td>
                        <td class="fw-bold">${e.name}</td>
                        <td class="text-end fw-bold text-primary">${valDisplay}</td>
                    </tr>
                `;
                }).join('');

                // Clean up Chart instance if exists (from previous load)
                if (top10Chart) {
                    top10Chart.destroy();
                    top10Chart = null;
                }
            }


            // Initialize
            loadData();
        </script>

</body>

</html>