<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Orange | Ø£Ø¯Ø§Ø¡ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</title>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            --bs-primary: #fe7900;
            --bg-light: #f8f9fa;
            --card-radius: 12px;
            --font-main: 'Tajawal', sans-serif;
        }

        body {
            font-family: var(--font-main);
            background-color: var(--bg-light);
        }

        .navbar {
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            background: white !important;
        }

        .navbar-brand {
            font-weight: 800;
        }

        .brand-orange {
            color: #fe7900;
        }

        .kpi-card {
            background: white;
            border-radius: var(--card-radius);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.03);
            padding: 20px;
            height: 100%;
            transition: transform 0.2s;
        }

        .kpi-card:hover {
            transform: translateY(-3px);
        }

        .section-title {
            font-weight: 700;
            margin-bottom: 20px;
            border-right: 4px solid #fe7900;
            padding-right: 10px;
        }

        .table-custom thead th {
            background-color: #fe7900;
            color: white;
            font-weight: 500;
            border: none;
        }

        .table-custom tbody tr:hover {
            background-color: #fff3e0;
        }

        .rank-badge {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.85rem;
        }

        .rank-1 {
            background: linear-gradient(135deg, #FFD700, #FFA500);
            color: white;
        }

        .rank-2 {
            background: linear-gradient(135deg, #C0C0C0, #A0A0A0);
            color: white;
        }

        .rank-3 {
            background: linear-gradient(135deg, #CD7F32, #8B4513);
            color: white;
        }

        .rank-other {
            background: #e9ecef;
            color: #495057;
        }

        .progress-thin {
            height: 8px;
            border-radius: 4px;
        }

        .emp-card {
            background: white;
            border-radius: var(--card-radius);
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            border-left: 4px solid #fe7900;
        }

        .chart-container {
            background: white;
            padding: 20px;
            border-radius: var(--card-radius);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.03);
            min-height: 300px;
        }

        .text-orange {
            color: #fe7900;
        }

        .bg-orange {
            background-color: #fe7900;
        }

        /* Sortable Headers */
        .sortable {
            cursor: pointer;
            user-select: none;
            transition: background-color 0.2s;
            position: relative;
        }

        .sortable:hover {
            background-color: #e86800 !important;
        }

        .sortable::after {
            content: 'â‡…';
            margin-right: 5px;
            opacity: 0.5;
            font-size: 0.8em;
        }

        .sortable.asc::after {
            content: 'â†‘';
            opacity: 1;
        }

        .sortable.desc::after {
            content: 'â†“';
            opacity: 1;
        }

        /* Clickable Rows */
        tbody tr {
            cursor: pointer;
            transition: background-color 0.1s;
        }

        tbody tr:hover {
            background-color: #fff3e0 !important;
            /* Light orange hover */
        }

        /* Metric Cards in Offcanvas */
        .insight-card {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            border: 1px solid #eee;
        }

        .insight-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #333;
        }

        .insight-label {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 5px;
        }

        .diff-badge {
            font-size: 0.8rem;
            padding: 4px 8px;
            border-radius: 6px;
            display: inline-block;
            margin-top: 5px;
            font-weight: bold;
        }

        .diff-pos {
            background: #d1e7dd;
            color: #0f5132;
        }

        .diff-neg {
            background: #f8d7da;
            color: #842029;
        }

        .diff-neutral {
            background: #e2e3e5;
            color: #41464b;
        }

        /* Employee Selection Modal Styles */
        .emp-select-modal .modal-body {
            max-height: 60vh;
            overflow-y: auto;
        }

        .emp-select-row {
            transition: background-color 0.2s;
        }

        .emp-select-row:hover {
            background-color: #f8f9fa !important;
        }

        /* Highly suspected (both criteria) */
        .emp-suspected-high {
            background-color: #f8d7da !important;
            border-right: 4px solid #dc3545;
        }

        .emp-suspected-high:hover {
            background-color: #f5c2c7 !important;
        }

        /* Medium suspected (one criteria) */
        .emp-suspected-medium {
            background-color: #fff3cd !important;
            border-right: 4px solid #ffc107;
        }

        .emp-suspected-medium:hover {
            background-color: #ffecb5 !important;
        }

        /* Active employee */
        .emp-active {
            background-color: #d1e7dd !important;
            border-right: 4px solid #198754;
        }

        .emp-active:hover {
            background-color: #badbcc !important;
        }

        .legend-item {
            display: inline-flex;
            align-items: center;
            margin-left: 15px;
            font-size: 0.85rem;
        }

        .legend-dot {
            width: 12px;
            height: 12px;
            border-radius: 3px;
            margin-left: 5px;
        }

        .badge-reason {
            font-size: 0.7rem;
            padding: 2px 6px;
            margin-right: 3px;
        }
    </style>
</head>

<body>

    <!-- Navbar -->
    <nav class="navbar mb-4 sticky-top">
        <div class="container-fluid">
            <span class="navbar-brand"><span class="brand-orange">ORANGE</span> EMPLOYEES</span>
            <div class="d-flex gap-2 align-items-center">
                <span class="badge bg-light text-dark border" id="lastUpdate">...</span>
                <a href="index.html" class="btn btn-outline-secondary btn-sm fw-bold">ğŸ  Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>

                <!-- Export Dropdown -->
                <div class="dropdown">
                    <button class="btn btn-success btn-sm fw-bold dropdown-toggle" type="button"
                        data-bs-toggle="dropdown" aria-expanded="false">
                        ğŸ“Š ØªØµØ¯ÙŠØ± Excel
                    </button>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="#" onclick="exportExcel('current')">Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©</a></li>
                        <li>
                            <hr class="dropdown-divider">
                        </li>
                        <li><a class="dropdown-item" href="#" onclick="exportExcel('template')">ğŸ“„ Ù‚Ø§Ù„Ø¨ ØªØ§Ø±Ø¬Øª Ø§Ù„Ø´Ù‡Ø±
                                Ø§Ù„Ù‚Ø§Ø¯Ù…</a></li>
                    </ul>
                </div>

                <button onclick="openEmployeeSelectionModal('pdf')" class="btn btn-warning btn-sm fw-bold text-white">ğŸ“„
                    ØªØµØ¯ÙŠØ±
                    PDF</button>
                <button onclick="logout()" class="btn btn-danger btn-sm fw-bold">Ø®Ø±ÙˆØ¬</button>
            </div>
        </div>
    </nav>

    <!-- JS Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <script src="assets/amiri_font.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <!-- SheetJS for Excel Export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="assets/amiri_font.js"></script>
    <script src="pdf_export_employees.js"></script>

    <script>
        const currentUser = JSON.parse(localStorage.getItem('currentUser'));
        if (!currentUser) {
            window.location.href = 'login.html';
        }

        function logout() {
            localStorage.removeItem('currentUser');
            window.location.href = 'login.html';
        }
    </script>

    <div class="container-fluid px-4">

        <!-- Filters -->
        <div class="card border-0 shadow-sm p-3 mb-4">
            <div class="row align-items-end g-2">
                <!-- Manager -->
                <div class="col-md-2 col-lg-2">
                    <label class="form-label small text-muted fw-bold mb-1">Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ù†Ø·Ù‚Ø©</label>
                    <select id="managerFilter" class="form-select form-select-sm" onchange="updatePage()">
                        <option value="all">Ø§Ù„ÙƒÙ„</option>
                    </select>
                </div>
                <!-- Branch -->
                <div class="col-md-2 col-lg-2">
                    <label class="form-label small text-muted fw-bold mb-1">Ø§Ù„ÙØ±Ø¹</label>
                    <select id="branchFilter" class="form-select form-select-sm" onchange="updatePage()">
                        <option value="all">ÙƒØ§ÙØ© Ø§Ù„ÙØ±ÙˆØ¹</option>
                    </select>
                </div>
                <!-- Period -->
                <div class="col-md-3 col-lg-3">
                    <label class="form-label small text-muted fw-bold mb-1">Ø§Ù„ÙØªØ±Ø©</label>
                    <select id="periodFilter" class="form-select form-select-sm" onchange="updatePage()">
                        <option value="mtd" selected>Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ (MTD)</option>
                        <option value="yesterday">ÙŠÙˆÙ… Ø£Ù…Ø³ (Yesterday)</option>
                        <option value="today">Ø§Ù„ÙŠÙˆÙ… (Today)</option>
                    </select>
                </div>
                <!-- Sort -->
                <div class="col-md-2 col-lg-2">
                    <label class="form-label small text-muted fw-bold mb-1">ØªØ±ØªÙŠØ¨ Ø­Ø³Ø¨</label>
                    <select id="sortBy" class="form-select form-select-sm" onchange="updatePage()">
                        <option value="sales">Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</option>
                        <option value="achievement">Ù†Ø³Ø¨Ø© Ø§Ù„ØªØ­Ù‚ÙŠÙ‚ (Target %)</option>
                        <option value="transactions">Ø§Ù„ÙÙˆØ§ØªÙŠØ±</option>
                        <option value="avg_ticket">Ù…Ø¹Ø¯Ù„ Ø§Ù„ÙØ§ØªÙˆØ±Ø©</option>
                        <option value="items_per_inv">Ù…ØªÙˆØ³Ø· Ø§Ù„Ù‚Ø·Ø¹</option>
                    </select>
                </div>
                <!-- Search -->
                <div class="col-md-2 col-lg-2">
                    <label class="form-label small text-muted fw-bold mb-1">Ø¨Ø­Ø« Ù…ÙˆØ¸Ù</label>
                    <input type="text" id="searchEmp" class="form-control form-control-sm" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù..."
                        oninput="updatePage()">
                </div>
                <!-- Update Button -->
                <div class="col-md-1 col-lg-1">
                    <button class="btn btn-primary btn-sm w-100 fw-bold" onclick="updatePage()">
                        <span class="d-none d-md-inline">ğŸ”„</span>
                        <span class="d-md-none">ØªØ­Ø¯ÙŠØ«</span>
                    </button>
                </div>
            </div>

            <!-- Summary KPIs -->
            <div class="row g-3 mb-4">
                <div class="col-md-3">
                    <div class="kpi-card border-bottom border-4 border-warning">
                        <div class="text-muted small">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</div>
                        <div class="fs-3 fw-bold" id="totalEmployees">0</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="kpi-card border-bottom border-4 border-success">
                        <div class="text-muted small">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</div>
                        <div class="fs-3 fw-bold" id="totalSales">0</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="kpi-card border-bottom border-4 border-primary">
                        <div class="text-muted small" id="avgSalesPerEmpLabel">Ù…ØªÙˆØ³Ø· Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª/Ù…ÙˆØ¸Ù</div>
                        <div class="fs-3 fw-bold" id="avgSalesPerEmp">0</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="kpi-card border-bottom border-4 border-info">
                        <div class="text-muted small">Ø£Ø¹Ù„Ù‰ Ù…ÙˆØ¸Ù</div>
                        <div class="fs-5 fw-bold text-truncate" id="topEmployee">-</div>
                        <div class="small text-muted" id="topEmployeeSales">-</div>
                    </div>
                </div>
            </div>

            <!-- Top 10 Chart Section (Moved Up) -->
            <div class="row g-3 mb-4">
                <div class="col-12">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h5 class="section-title mb-0">ğŸ“Š ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† (Charts)</h5>
                        <!-- Chart Controls -->
                        <div class="d-flex gap-2">
                            <select id="chartMetric" class="form-select form-select-sm" onchange="updatePage()"
                                style="width: auto;">
                                <option value="sales">Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</option>
                                <option value="achievement">Ù†Ø³Ø¨Ø© Ø§Ù„ØªØ­Ù‚ÙŠÙ‚ %</option>
                                <option value="max_ticket">Ø£Ø¹Ù„Ù‰ Ù‚ÙŠÙ…Ø© ÙØ§ØªÙˆØ±Ø©</option>
                                <option value="avg_ticket">Ù…Ø¹Ø¯Ù„ Ø§Ù„ÙØ§ØªÙˆØ±Ø©</option>
                                <option value="items_per_inv">Ù…ØªÙˆØ³Ø· Ø§Ù„Ù‚Ø·Ø¹</option>
                            </select>
                            <select id="chartSort" class="form-select form-select-sm" onchange="updatePage()"
                                style="width: auto;">
                                <option value="desc">Ø§Ù„Ø£Ø¹Ù„Ù‰ (Top 10)</option>
                                <option value="asc">Ø§Ù„Ø£Ù‚Ù„ (Bottom 10)</option>
                            </select>
                        </div>
                    </div>
                    <div class="card border-0 shadow-sm" style="height: 300px;">
                        <div class="table-responsive h-100">
                            <table class="table table-sm table-striped table-hover mb-0 sticky-header">
                                <thead class="table-light sticky-top" style="z-index: 1;">
                                    <tr>
                                        <th style="width: 50px;">#</th>
                                        <th>Ø§Ù„Ù…ÙˆØ¸Ù</th>
                                        <th class="text-end">Ø§Ù„Ù‚ÙŠÙ…Ø©</th>
                                    </tr>
                                </thead>
                                <tbody id="top10Body">
                                    <!-- Populated by JS -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row">
                <!-- Leaderboard Table (Full Width) -->
                <div class="col-12">
                    <h5 class="section-title">ğŸ† ØªØ±ØªÙŠØ¨ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† (Leaderboard)</h5>
                    <div class="card border-0 shadow-sm p-3">
                        <div class="table-responsive" style="max-height: 500px; overflow-y: auto;">
                            <table class="table table-custom table-hover align-middle mb-0">
                                <thead class="sticky-top">
                                    <tr>
                                        <th>#</th>
                                        <th class="sortable" data-sort="name" onclick="sortTable('name')">Ø§Ù„Ù…ÙˆØ¸Ù</th>
                                        <th class="d-none d-md-table-cell sortable" data-sort="storeName"
                                            onclick="sortTable('storeName')">Ø§Ù„ÙØ±Ø¹</th>
                                        <th class="sortable desc" data-sort="sales" onclick="sortTable('sales')">
                                            Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</th>
                                        <th class="text-center sortable" data-sort="branchShare"
                                            onclick="sortTable('branchShare')">Ø­ØµØ© Ø§Ù„ÙØ±Ø¹ %</th>
                                        <th class="text-center sortable" data-sort="shareGrowth"
                                            onclick="sortTable('shareGrowth')">ØªØ·ÙˆØ± Ø§Ù„Ø­ØµØ©</th>
                                        <th class="text-center sortable" data-sort="target"
                                            onclick="sortTable('target')">Ø§Ù„Ù‡Ø¯Ù</th>
                                        <th class="text-center sortable" data-sort="achievement"
                                            onclick="sortTable('achievement')">Ø§Ù„ØªØ­Ù‚ÙŠÙ‚ %</th>
                                        <th class="text-center sortable" data-sort="dailyReq"
                                            onclick="sortTable('dailyReq')">Ø§Ù„ÙŠÙˆÙ…ÙŠØ© Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©</th>
                                        <th class="d-none d-md-table-cell sortable" data-sort="transactions"
                                            onclick="sortTable('transactions')">Ø§Ù„ÙÙˆØ§ØªÙŠØ±</th>
                                        <th class="d-none d-md-table-cell sortable" data-sort="avg_ticket"
                                            onclick="sortTable('avg_ticket')">Ù…Ø¹Ø¯Ù„ Ø§Ù„ÙØ§ØªÙˆØ±Ø©</th>
                                        <th class="d-none d-md-table-cell sortable" data-sort="items_per_inv"
                                            onclick="sortTable('items_per_inv')">Ù…ØªÙˆØ³Ø· Ø§Ù„Ù‚Ø·Ø¹</th>
                                    </tr>
                                </thead>
                                <tbody id="leaderboardBody">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

        </div>

        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

        <!-- Employee Insight Offcanvas -->
        <div class="offcanvas offcanvas-start" tabindex="-1" id="empInsightPanel"
            style="width: 400px; border-right: 5px solid #fe7900;">
            <div class="offcanvas-header bg-light">
                <div>
                    <h5 class="offcanvas-title fw-bold" id="panelEmpName">Employee Name</h5>
                    <small class="text-muted" id="panelEmpStore">Store Name</small>
                </div>
                <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas"
                    aria-label="Close"></button>
            </div>
            <div class="offcanvas-body">
                <!-- 1. Performance Overview -->
                <div class="d-flex justify-content-between mb-4 text-center">
                    <div class="w-50 border-end pe-2">
                        <div class="text-muted small">Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª (MTD)</div>
                        <div class="h3 fw-bold text-orange mb-0" id="panelSales">0</div>
                        <div class="small" id="panelShare">0% Share</div>
                    </div>
                    <div class="w-50 ps-2">
                        <div class="text-muted small">Ø§Ù„ØªØ­Ù‚ÙŠÙ‚</div>
                        <div class="h3 fw-bold mb-0" id="panelAch">-</div>
                        <div class="small text-muted" id="panelTarget">Target: 0</div>
                    </div>
                </div>

                <hr>

                <!-- 2. Quality Metrics (Comparisons) -->
                <h6 class="fw-bold mb-3">âš¡ Ø¬ÙˆØ¯Ø© Ø§Ù„Ø£Ø¯Ø§Ø¡ (Ù…Ù‚Ø§Ø±Ù†Ø© Ø¨Ø§Ù„ÙØ±Ø¹)</h6>

                <!-- Avg Ticket -->
                <div class="insight-card">
                    <div class="insight-label">Ù…Ø¹Ø¯Ù„ Ø§Ù„ÙØ§ØªÙˆØ±Ø© (Avg Ticket)</div>
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="insight-value" id="panelAvgTicket">0</div>
                        <div id="diffAvgTicket" class="diff-badge">--</div>
                    </div>
                    <small class="text-muted d-block mt-2">Ù…ØªÙˆØ³Ø· Ø§Ù„ÙØ±Ø¹: <span id="branchAvgTicket">0</span></small>
                </div>

                <!-- UPT -->
                <div class="insight-card">
                    <div class="insight-label">Ù…ØªÙˆØ³Ø· Ø§Ù„Ù‚Ø·Ø¹ (Items/Inv)</div>
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="insight-value" id="panelUPT">0</div>
                        <div id="diffUPT" class="diff-badge">--</div>
                    </div>
                    <small class="text-muted d-block mt-2">Ù…ØªÙˆØ³Ø· Ø§Ù„ÙØ±Ø¹: <span id="branchAvgUPT">0</span></small>
                </div>

                <hr>

                <!-- 3. Trend Chart -->
                <h6 class="fw-bold mb-3">ğŸ“ˆ Ø¢Ø®Ø± 7 Ø£ÙŠØ§Ù… ØªØ¯Ø§ÙˆÙ„</h6>
                <div style="height: 200px;">
                    <canvas id="empTrendChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Employee Selection Modal for Target Export -->
        <div class="modal fade emp-select-modal" id="empSelectModal" tabindex="-1" aria-labelledby="empSelectModalLabel"
            aria-hidden="true">
            <div class="modal-dialog modal-lg modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header bg-light">
                        <div>
                            <h5 class="modal-title fw-bold" id="empSelectModalLabel">ğŸ“‹ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ù„Ù„ØªØµØ¯ÙŠØ±</h5>
                            <small class="text-muted">Ø§Ø®ØªØ± Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ø§Ù„Ø°ÙŠÙ† ØªØ±ÙŠØ¯ ØªØ¶Ù…ÙŠÙ†Ù‡Ù… ÙÙŠ Ù‚Ø§Ù„Ø¨ Ø§Ù„ØªØ§Ø±Ø¬Øª</small>
                        </div>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <!-- Legend -->
                        <div class="d-flex flex-wrap justify-content-center mb-3 p-2 bg-light rounded">
                            <div class="legend-item">
                                <span class="legend-dot" style="background: #d1e7dd; border: 1px solid #198754;"></span>
                                <span>Ù…ÙˆØ¸Ù Ù†Ø´Ø·</span>
                            </div>
                            <div class="legend-item">
                                <span class="legend-dot" style="background: #fff3cd; border: 1px solid #ffc107;"></span>
                                <span>Ù…Ø±Ø§Ø¬Ø¹Ø© (Ù…Ø¹ÙŠØ§Ø± ÙˆØ§Ø­Ø¯)</span>
                            </div>
                            <div class="legend-item">
                                <span class="legend-dot" style="background: #f8d7da; border: 1px solid #dc3545;"></span>
                                <span>Ù…Ø³ØªÙ‚ÙŠÙ„ (Ù…Ø¹ÙŠØ§Ø±Ø§Ù†)</span>
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div class="d-flex justify-content-between mb-3">
                            <div class="btn-group btn-group-sm">
                                <button type="button" class="btn btn-outline-primary"
                                    onclick="selectAllEmployees(true)">âœ“ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙƒÙ„</button>
                                <button type="button" class="btn btn-outline-secondary"
                                    onclick="selectAllEmployees(false)">âœ— Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ÙƒÙ„</button>
                                <button type="button" class="btn btn-outline-success" onclick="selectActiveOnly()">ğŸ‘¤
                                    Ø§Ù„Ù†Ø´Ø·ÙŠÙ† ÙÙ‚Ø·</button>
                            </div>
                            <div class="text-muted small align-self-center">
                                Ø§Ù„Ù…Ø­Ø¯Ø¯ÙŠÙ†: <strong id="selectedCount">0</strong> Ù…Ù† <strong id="totalEmpCount">0</strong>
                            </div>
                        </div>

                        <!-- Employees Table -->
                        <div class="table-responsive" style="max-height: 400px;">
                            <table class="table table-sm table-hover mb-0">
                                <thead class="table-dark sticky-top">
                                    <tr>
                                        <th style="width: 40px;">
                                            <input type="checkbox" id="selectAllCheckbox"
                                                onchange="selectAllEmployees(this.checked)">
                                        </th>
                                        <th>Ø§Ù„Ù…ÙˆØ¸Ù</th>
                                        <th>Ø§Ù„ÙØ±Ø¹</th>
                                        <th class="text-center">Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</th>
                                        <th class="text-center">Ø§Ù„Ø­Ø§Ù„Ø©</th>
                                    </tr>
                                </thead>
                                <tbody id="empSelectBody">
                                    <!-- Populated by JS -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Ø¥Ù„ØºØ§Ø¡</button>
                        <button type="button" class="btn btn-success fw-bold" onclick="exportSelectedEmployees()">
                            ğŸ“¥ ØªØµØ¯ÙŠØ± Ø§Ù„Ù…Ø­Ø¯Ø¯ÙŠÙ†
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Logic -->
        <script>
            // Global Data
            let historyData = {};
            let targetsData = {};
            let storesData = {};
            let storeMeta = {}; // To store manager info
            let employeeNames = {}; // New: Arabic names map
            let top10Chart, branchChart;

            // Sorting State
            let currentSortColumn = 'sales';
            let currentSortDirection = 'desc';
            let currentEmpList = []; // Cache for sorting

            // Global for Insight Panel
            let empTrendChartInstance = null;
            let employeeDailyMaps = {}; // Map empId -> Array of daily records
            let branchStats = {}; // Map storeId -> {current, transactions, items}

            // Fetch Data
            async function loadData() {
                // ... existing loadData code ...
                const timestamp = new Date().getTime();
                try {
                    const [empRes, mgmtRes] = await Promise.all([
                        fetch('employees_data.json?v=' + timestamp),
                        fetch('management_data.json?v=' + timestamp)
                    ]);

                    const empJson = await empRes.json();
                    historyData = empJson.history;
                    targetsData = empJson.targets;
                    employeeNames = empJson.employee_names || {};

                    const mgmtJson = await mgmtRes.json();
                    storesData = mgmtJson.stores;
                    storeMeta = mgmtJson.store_meta || {};

                    populateFilters();
                    updatePage();

                    // Debug: Show record count
                    const totalStores = Object.keys(historyData).length;
                    document.getElementById('lastUpdate').textContent = new Date().toLocaleDateString('ar-SA') + ` (Stores:
    ${totalStores})`;

                } catch (err) {
                    console.error("Error loading data:", err);
                    document.getElementById('lastUpdate').textContent = "Error loading data: " + err.message;
                    document.getElementById('lastUpdate').className = "badge bg-danger";
                }
            }

            function populateFilters() {
                // Managers
                const managerSelect = document.getElementById('managerFilter');
                const managers = new Set();
                Object.values(storeMeta).forEach(meta => {
                    if (meta.manager && meta.manager !== 'online') {
                        managers.add(meta.manager);
                    }
                });
                Array.from(managers).sort().forEach(m => {
                    const opt = document.createElement('option');
                    opt.value = m;
                    opt.textContent = m;
                    managerSelect.appendChild(opt);
                });

                // Branches
                const branchSelect = document.getElementById('branchFilter');
                const branches = Object.keys(historyData || {});
                branches.forEach(code => {
                    const name = storesData[code] || code;
                    const opt = document.createElement('option');
                    opt.value = code;
                    opt.textContent = name;
                    branchSelect.appendChild(opt);
                });
            }

            function updatePage() {
                let managerFilter = document.getElementById('managerFilter').value;

                // Enforce Permissions
                if (currentUser.role !== 'Admin') {
                    managerFilter = currentUser.name;
                    // Also lock UI
                    const mf = document.getElementById('managerFilter');
                    if (mf.value !== currentUser.name) {
                        mf.value = currentUser.name;
                        mf.parentElement.style.display = 'none';
                    }
                }

                const branchFilter = document.getElementById('branchFilter').value;
                const periodFilter = document.getElementById('periodFilter').value;
                const sortBy = document.getElementById('sortBy').value;
                const searchTerm = document.getElementById('searchEmp').value.toLowerCase();

                // Aggregate employee data
                const empAgg = {};
                const history = historyData || {};
                const targets = targetsData || {};

                // Date Filters
                const today = new Date();
                branchStats = {}; // Reset Global Variable

                // Local YYYY-MM-DD
                const toLocalYMD = (d) => {
                    const y = d.getFullYear();
                    const m = String(d.getMonth() + 1).padStart(2, '0');
                    const day = String(d.getDate()).padStart(2, '0');
                    return `${y}-${m}-${day}`;
                };

                const todayStr = toLocalYMD(today);
                const todayYear = today.getFullYear();
                const todayMonth = today.getMonth(); // 0-11
                const todayDay = today.getDate();
                const todayVal = todayYear * 10000 + (todayMonth + 1) * 100 + todayDay;

                // Previous Period Logic (for Growth comparison)
                // Logic: Same Period Last Month (Month - 1)
                const prevMonthDate = new Date(todayYear, todayMonth - 1, 1);
                const prevYear = prevMonthDate.getFullYear();
                const prevMonth = prevMonthDate.getMonth();

                // Calculate Yesterday
                const yesterday = new Date(today);
                yesterday.setDate(yesterday.getDate() - 1);
                const yesterdayStr = toLocalYMD(yesterday);
                const yesterdayDay = yesterday.getDate();

                const checkPeriod = (dYear, dMonth, dDay, dVal, dDateStr) => {
                    // Returns: 0 (None), 1 (Current), 2 (Previous)
                    let status = 0;

                    // 1. Check Current
                    if (periodFilter === 'mtd') {
                        if (dYear === todayYear && dMonth === todayMonth && dVal <= todayVal) status = 1;
                    } else if (periodFilter === 'mtd_yest') {
                        if (dYear === todayYear && dMonth === todayMonth && dVal < todayVal) status = 1;
                    } else if (periodFilter === 'yesterday') {
                        if (dDateStr === yesterdayStr) status = 1;
                    } else if (periodFilter === 'today') {
                        if (dDateStr === todayStr) status = 1;
                    }

                    if (status === 1) return 1;

                    // 2. Check Previous (Same period last month)
                    if (dYear === prevYear && dMonth === prevMonth) {
                        if (periodFilter === 'mtd') {
                            if (dDay <= todayDay) return 2;
                        } else if (periodFilter === 'mtd_yest') {
                            if (dDay <= yesterdayDay) return 2;
                        } else if (periodFilter === 'yesterday') {
                            if (dDay === yesterdayDay) return 2;
                        } else if (periodFilter === 'today') {
                            if (dDay === todayDay) return 2;
                        }
                    }
                    return 0;
                };

                Object.entries(history).forEach(([storeCode, records]) => {
                    // Removed early filtering to allow global aggregation
                    // We will filter by Primary Store LATER

                    // Init Store Stats
                    if (!branchStats[storeCode]) {
                        branchStats[storeCode] = {
                            current: 0,
                            prev: 0,
                            transactions: 0,
                            items: 0
                        };
                    }

                    records.forEach(rec => {
                        // Data Format: [Date, Name, Sales, Trans, Items, MaxTicket]
                        const [date, rawName, sales, trans, items, maxTicket] = rec;

                        // Parse Date
                        const d = new Date(date);
                        const dYear = d.getFullYear();
                        const dMonth = d.getMonth();
                        const dDay = d.getDate();
                        const dVal = dYear * 10000 + (dMonth + 1) * 100 + dDay;

                        const pStatus = checkPeriod(dYear, dMonth, dDay, dVal, date);
                        if (pStatus === 0) return; // Not in current or prev period

                        // Update Store Totals & Daily Maps (Current Period Only)
                        if (pStatus === 1) {
                            branchStats[storeCode].current += sales || 0;
                            branchStats[storeCode].transactions += trans || 0;
                            branchStats[storeCode].items += items || 0;
                        }
                        if (pStatus === 2) branchStats[storeCode].prev += sales || 0;

                        // Identify Employee
                        let empName = rawName;
                        let empId = rawName;

                        if (rawName.includes('-')) {
                            const parts = rawName.split('-');
                            empId = parts[0].trim();
                            empName = parts[1].trim();
                        } else {
                            empId = rawName;
                        }

                        if (empName === 'Ù…Ø±ØªØ¬Ø¹') return;
                        if (employeeNames[empId]) empName = employeeNames[empId];
                        const key = empId;

                        // Populate Employee Daily Helper (For Chart) - Current Period OR recent
                        // Only add if pStatus is 1 (Current Period) to show trend in this period
                        if (pStatus === 1) {
                            if (!employeeDailyMaps[key]) {
                                employeeDailyMaps[key] = [];
                            }
                            employeeDailyMaps[key].push({
                                date: date,
                                sales: sales || 0,
                                inv: trans || 0,
                                items: items || 0
                            });
                        }

                        if (!empAgg[key]) {
                            let monthlyTarget = targets[empId] || 0;
                            empAgg[key] = {
                                id: empId,
                                name: empName,
                                storeCode: storeCode, // Placeholder, will be updated
                                storeName: storesData[storeCode] || storeCode,
                                sales: 0,
                                prevSales: 0,
                                transactions: 0,
                                items: 0,
                                max_ticket: 0,
                                target: monthlyTarget,
                                storeStats: {},
                                latestDates: {}  // NEW: Track latest date per store
                            };
                        }

                        // Track Stats & Dates per store for Primary Store determination
                        if (pStatus === 1) {
                            if (!empAgg[key].storeStats[storeCode]) empAgg[key].storeStats[storeCode] = 0;
                            empAgg[key].storeStats[storeCode] += (sales || 0);

                            // Update Latest Date for this store (If sales are positive, it's a stronger indication of presence)
                            if (sales > 0) {
                                if (!empAgg[key].latestDates[storeCode] || date > empAgg[key].latestDates[storeCode]) {
                                    empAgg[key].latestDates[storeCode] = date;
                                }
                            }
                        }

                        // Accumulate Employee Stats
                        if (pStatus === 1) {
                            empAgg[key].sales += sales || 0;
                            empAgg[key].transactions += trans || 0;
                            empAgg[key].items += items || 0;
                            if (maxTicket > empAgg[key].max_ticket) empAgg[key].max_ticket = maxTicket;
                        } else if (pStatus === 2) {
                            empAgg[key].prevSales += sales || 0;
                        }
                    });
                });

                // 1. Determine Primary Store & Apply Filters (Filters moved here)
                let empList = Object.values(empAgg).filter(e => {
                    // Determine Primary Store
                    // Logic Change: Use the store with the MOST RECENT (Latest) POSITIVE sales date.
                    // This correctly handles mid-month transfers.
                    let bestStore = e.storeCode;
                    let latestDate = "";

                    if (Object.keys(e.latestDates).length > 0) {
                        Object.entries(e.latestDates).forEach(([sCode, dStr]) => {
                            if (dStr > latestDate) {
                                latestDate = dStr;
                                bestStore = sCode;
                            }
                        });
                        e.storeCode = bestStore;
                        e.storeName = storesData[bestStore] || bestStore;
                    }

                    // Now Apply Filters based on PRIMARY Store

                    // Filter by Branch
                    if (branchFilter !== 'all' && branchFilter !== e.storeCode) return false;

                    // Filter by Manager
                    if (managerFilter !== 'all') {
                        const meta = storeMeta[e.storeCode];
                        if (!meta || meta.manager !== managerFilter) {
                            return false;
                        }
                    }

                    // Filter Non-Active
                    return e.sales > 0 || e.transactions > 0;
                });

                // Search filter
                if (searchTerm) {
                    empList = empList.filter(e => e.name.toLowerCase().includes(searchTerm));
                }

                // Calculate metrics
                empList.forEach(e => {
                    e.avg_ticket = e.transactions > 0 ? e.sales / e.transactions : 0;
                    e.items_per_inv = e.transactions > 0 ? Math.abs(e.items) / e.transactions : 0;

                    // Achievement
                    e.achievement = 0;
                    if (e.target > 0) {
                        if (periodFilter === 'mtd' || periodFilter === 'mtd_yest') {
                            e.achievement = (e.sales / e.target) * 100;
                        }
                    }

                    // Share & Growth Logic
                    const bStats = branchStats[e.storeCode];
                    const branchTotalCurr = bStats ? bStats.current : 0;
                    const branchTotalPrev = bStats ? bStats.prev : 0;

                    // Current Share
                    e.branchShare = branchTotalCurr > 0 ? (e.sales / branchTotalCurr) * 100 : 0;

                    // Previous Share
                    const prevShare = branchTotalPrev > 0 ? (e.prevSales / branchTotalPrev) * 100 : 0;

                    // Share Growth (Delta)
                    // If prevShare is 0, growth is implied as positive gain of entire current share
                    e.shareGrowth = e.branchShare - prevShare;
                });

                // Calculate dailyReq for sorting
                const todayForDaily = new Date();
                const lastDayOfMonth = new Date(todayForDaily.getFullYear(), todayForDaily.getMonth() + 1, 0).getDate();
                const remainingDays = lastDayOfMonth - todayForDaily.getDate() + 1;

                empList.forEach(e => {
                    e.dailyReq = 0;
                    if (periodFilter === 'mtd' && e.target > e.sales && remainingDays > 0) {
                        e.dailyReq = (e.target - e.sales) / remainingDays;
                    }
                });

                // Cache for column header sorting
                currentEmpList = empList;

                // Sort using current sort column and direction
                sortCurrentList();

                // Update KPIs
                const totalSales = empList.reduce((s, e) => s + e.sales, 0);
                const totalTarget = empList.reduce((s, e) => s + (periodFilter === 'mtd' ? e.target : 0), 0);

                document.getElementById('totalEmployees').textContent = empList.length.toLocaleString();
                document.getElementById('totalSales').textContent = totalSales.toLocaleString('en-US', { maximumFractionDigits: 0 })
                    ;

                // KPI 3: Avg Achievement or Avg Sales
                if (periodFilter === 'mtd' && totalTarget > 0) {
                    const totalAch = (totalSales / totalTarget) * 100;
                    document.getElementById('avgSalesPerEmpLabel').textContent = 'Ù†Ø³Ø¨Ø© ØªØ­Ù‚ÙŠÙ‚ Ø§Ù„Ù‡Ø¯Ù';
                    document.getElementById('avgSalesPerEmp').textContent = totalAch.toFixed(1) + '%';
                    document.getElementById('avgSalesPerEmp').className = totalAch >= 80 ? 'fs-3 fw-bold text-success' : 'fs-3 fw-bold text-warning';
                } else {
                    document.getElementById('avgSalesPerEmpLabel').textContent = 'Ù…ØªÙˆØ³Ø· Ù…Ø¨ÙŠØ¹Ø§Øª/Ù…ÙˆØ¸Ù';
                    document.getElementById('avgSalesPerEmp').textContent = empList.length > 0
                        ? (totalSales / empList.length).toLocaleString('en-US', { maximumFractionDigits: 0 }) : '0';
                    document.getElementById('avgSalesPerEmp').className = 'fs-3 fw-bold';
                }

                if (empList.length > 0) {
                    // Find top by sales specifically for the card
                    const top = [...empList].sort((a, b) => b.sales - a.sales)[0];
                    document.getElementById('topEmployee').textContent = top.name;
                    document.getElementById('topEmployeeSales').textContent = top.sales.toLocaleString('en-US', {
                        maximumFractionDigits:
                            0
                    });
                }

                // Update table using shared render function
                updateHeaderSortIndicators();
                renderTable();

                // Update charts
                updateCharts(currentEmpList);
            }

            function updateCharts(empList) {
                const metric = document.getElementById('chartMetric').value;
                const sortOrder = document.getElementById('chartSort').value;

                // 1. Sort Data
                let sortedList = [...empList];
                sortedList.sort((a, b) => {
                    let valA = a[metric];
                    let valB = b[metric];
                    return sortOrder === 'desc' ? valB - valA : valA - valB;
                });

                // 2. Slice Top 10
                const top10 = sortedList.slice(0, 10);

                // 3. Populate Table
                const tbody = document.getElementById('top10Body');
                tbody.innerHTML = top10.map((e, index) => {
                    // Format Value
                    let valDisplay = e[metric];
                    if (metric === 'sales' || metric === 'avg_ticket' || metric === 'max_ticket') {
                        valDisplay = valDisplay.toLocaleString('en-US', { maximumFractionDigits: 0 });
                    } else if (metric === 'achievement') {
                        valDisplay = valDisplay.toFixed(1) + '%';
                    } else {
                        valDisplay = Math.round(valDisplay);
                    }

                    return `
                    <tr>
                        <td class="text-muted small">${index + 1}</td>
                        <td class="fw-bold">${e.name}</td>
                        <td class="text-end fw-bold text-primary">${valDisplay}</td>
                    </tr>
                `;
                }).join('');

                // Clean up Chart instance if exists (from previous load)
                if (top10Chart) {
                    top10Chart.destroy();
                    top10Chart = null;
                }
            }


            // === COLUMN HEADER SORTING ===
            function sortTable(column) {
                // Toggle direction if same column, else default to desc (except name/storeName)
                if (currentSortColumn === column) {
                    currentSortDirection = currentSortDirection === 'desc' ? 'asc' : 'desc';
                } else {
                    currentSortColumn = column;
                    // Text columns default to asc, numeric to desc
                    currentSortDirection = (column === 'name' || column === 'storeName') ? 'asc' : 'desc';
                }

                updateHeaderSortIndicators();
                sortCurrentList();
                renderTable();
            }

            function updateHeaderSortIndicators() {
                // Remove all sort classes
                document.querySelectorAll('.sortable').forEach(th => {
                    th.classList.remove('asc', 'desc');
                });

                // Add current sort class
                const currentTh = document.querySelector(`.sortable[data-sort="${currentSortColumn}"]`);
                if (currentTh) {
                    currentTh.classList.add(currentSortDirection);
                }
            }

            function sortCurrentList() {
                if (!currentEmpList || currentEmpList.length === 0) return;

                const col = currentSortColumn;
                const dir = currentSortDirection;

                currentEmpList.sort((a, b) => {
                    let valA = a[col];
                    let valB = b[col];

                    // Handle string comparison for name/storeName
                    if (col === 'name' || col === 'storeName') {
                        valA = valA || '';
                        valB = valB || '';
                        const cmp = valA.localeCompare(valB, 'ar');
                        return dir === 'asc' ? cmp : -cmp;
                    }

                    // Numeric comparison
                    valA = valA || 0;
                    valB = valB || 0;
                    return dir === 'desc' ? valB - valA : valA - valB;
                });
            }

            function renderTable() {
                const periodFilter = document.getElementById('periodFilter').value;
                const tbody = document.getElementById('leaderboardBody');

                tbody.innerHTML = currentEmpList.slice(0, 100).map((emp, idx) => {
                    const rank = idx + 1;
                    const rankClass = rank === 1 ? 'rank-1' : rank === 2 ? 'rank-2' : rank === 3 ? 'rank-3' : 'rank-other';

                    // Target Display
                    const showTarget = periodFilter === 'mtd' && emp.target > 0;
                    const targetText = showTarget ? emp.target.toLocaleString() : '-';

                    // Daily Required
                    const dailyReqText = emp.dailyReq > 0 ? emp.dailyReq.toLocaleString('en-US', { maximumFractionDigits: 0 }) : '-';

                    let achBadge = '<span class="text-muted">-</span>';
                    if (showTarget) {
                        let color = 'bg-secondary';
                        if (emp.achievement >= 100) color = 'bg-success';
                        else if (emp.achievement >= 80) color = 'bg-warning text-dark';
                        else color = 'bg-danger';
                        achBadge = `<span class="badge ${color}">${emp.achievement.toFixed(1)}%</span>`;
                    }

                    return `
    <tr onclick="openEmployeeInsights('${emp.id}')">
        <td><span class="rank-badge ${rankClass}">${rank}</span></td>
        <td>
            <div class="fw-bold text-decoration-underline text-primary" style="cursor:pointer">${emp.name}</div>
            <small class="text-muted d-block d-md-none">${emp.storeName}</small>
        </td>
        <td class="d-none d-md-table-cell"><small class="text-muted">${emp.storeName}</small></td>
        <td class="fw-bold text-success" style="font-size:1.1em">${emp.sales.toLocaleString('en-US', { maximumFractionDigits: 0 })}</td>
        
        <!-- Branch Share -->
        <td class="text-center">
            <div class="progress" style="height: 6px; width: 80px; margin: 0 auto;">
                 <div class="progress-bar bg-info" role="progressbar" style="width: ${emp.branchShare}%"></div>
            </div>
            <small class="text-muted" style="font-size:0.75rem">${emp.branchShare.toFixed(1)}%</small>
        </td>

        <!-- Share Growth -->
        <td class="text-center fw-bold ${emp.shareGrowth >= 0 ? 'text-success' : 'text-danger'}">
             ${emp.shareGrowth > 0 ? 'â–²' : emp.shareGrowth < 0 ? 'â–¼' : '-'} ${Math.abs(emp.shareGrowth).toFixed(1)}%
        </td>

        <td class="text-center">${targetText}</td>
        <td class="text-center">${achBadge}</td>
        <td class="text-center fw-bold text-danger">${dailyReqText}</td>
        <td class="d-none d-md-table-cell">${emp.transactions}</td>
        <td class="d-none d-md-table-cell">${emp.avg_ticket.toLocaleString('en-US', { maximumFractionDigits: 0 })}</td>
        <td class="d-none d-md-table-cell">${emp.items_per_inv.toFixed(1)}</td>
    </tr>
    `;
                }).join('');
            }

            // === EXCEL EXPORT ===
            let employeeSelectionData = []; // Store employee data with suspected status
            let currentExportMode = 'excel'; // 'excel' or 'pdf'

            function exportExcel(type) {
                if (!currentEmpList || currentEmpList.length === 0) {
                    alert("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØµØ¯ÙŠØ±");
                    return;
                }

                if (type === 'current') {
                    // 1. Export Current View
                    const data = currentEmpList.map((e, i) => ({
                        "Ø§Ù„ØªØ±ØªÙŠØ¨": i + 1,
                        "Ø§Ù„Ù…ÙˆØ¸Ù": e.name,
                        "Ø§Ù„ÙØ±Ø¹": e.storeName,
                        "Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª": e.sales,
                        "Ø§Ù„ÙÙˆØ§ØªÙŠØ±": e.transactions,
                        "Ù…Ø¹Ø¯Ù„ Ø§Ù„ÙØ§ØªÙˆØ±Ø©": e.avg_ticket,
                        "Ù…ØªÙˆØ³Ø· Ø§Ù„Ù‚Ø·Ø¹": e.items_per_inv,
                        "Ø§Ù„Ù‡Ø¯Ù": e.target || 0,
                        "Ø§Ù„ØªØ­Ù‚ÙŠÙ‚ %": (e.achievement || 0).toFixed(1) + '%',
                        "Ø­ØµØ© Ø§Ù„ÙØ±Ø¹ %": (e.branchShare || 0).toFixed(1) + '%'
                    }));

                    const ws = XLSX.utils.json_to_sheet(data);
                    // Adjust column widths
                    ws['!cols'] = [{ wch: 8 }, { wch: 25 }, { wch: 20 }, { wch: 12 }, { wch: 10 }, { wch: 15 }, { wch: 12 }, { wch: 12 }, { wch: 12 }, { wch: 12 }];

                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, ws, "Employees Report");
                    XLSX.writeFile(wb, "Orange_Employees_Report.xlsx");
                }
                else if (type === 'template') {
                    // Open Employee Selection Modal
                    openEmployeeSelectionModal('excel');
                }
            }

            // === EMPLOYEE SELECTION MODAL FUNCTIONS ===
            function openEmployeeSelectionModal(mode = 'excel') {
                currentExportMode = mode;

                // Analyze employees and detect suspected resigned
                employeeSelectionData = analyzeEmployeesForResignation();

                // Apply Saved Preferences (for PDF only)
                if (mode === 'pdf') {
                    const savedSelection = localStorage.getItem('pdf_selected_employees');
                    if (savedSelection) {
                        const savedIds = JSON.parse(savedSelection); // Array of IDs
                        employeeSelectionData.forEach(emp => {
                            // If ID exists in saved list, select it. otherwise deselect.
                            // Note: We match by ID. New employees (not in list) will be UNSELECTED by this logic.
                            // Better Logic: Default to Active, but Override with Saved.
                            // BUT user wants to "save their choice". So strictly following saved list is expected.
                            // However, if a NEW employee appears, they might be missed.
                            // Hybrid: If ID is in saved list -> true. If ID is NOT in saved list -> false (excluded).
                            // Wait, if I explicitly unchecked someone, they are not in list.
                            // If I added someone, they are in list.
                            // Making it strict (only allow if in list) is safest for "removing people".
                            emp.selected = savedIds.includes(emp.id);
                        });
                    }
                    // Update Modal UI
                    document.getElementById('empSelectModalLabel').innerHTML = 'ğŸ“„ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† (PDF)';
                    document.querySelector('#empSelectModal .text-muted').textContent = 'Ø§Ø®ØªØ± Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ù„Ù„ØªÙ‚Ø±ÙŠØ± ÙˆØ£Ø²Ù„ Ø§Ù„Ù…Ø³ØªÙ‚ÙŠÙ„ÙŠÙ†';
                    const btn = document.querySelector('#empSelectModal .btn-success');
                    btn.innerHTML = 'ğŸ“¥ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªÙ‚Ø±ÙŠØ±';
                    btn.setAttribute('onclick', 'confirmExportSelection()');
                } else {
                    // Excel Mode Defaults
                    document.getElementById('empSelectModalLabel').innerHTML = 'ğŸ“‹ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ù„Ù„ØªØµØ¯ÙŠØ±';
                    document.querySelector('#empSelectModal .text-muted').textContent = 'Ø§Ø®ØªØ± Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ø§Ù„Ø°ÙŠÙ† ØªØ±ÙŠØ¯ ØªØ¶Ù…ÙŠÙ†Ù‡Ù… ÙÙŠ Ù‚Ø§Ù„Ø¨ Ø§Ù„ØªØ§Ø±Ø¬Øª';
                    const btn = document.querySelector('#empSelectModal .btn-success');
                    btn.innerHTML = 'ğŸ“¥ ØªØµØ¯ÙŠØ± Ø§Ù„Ù…Ø­Ø¯Ø¯ÙŠÙ†';
                    btn.setAttribute('onclick', 'confirmExportSelection()');
                }

                // Populate Modal Table
                populateEmployeeSelectionTable();

                // Update Counts
                updateSelectionCount();

                // Show Modal
                const modal = new bootstrap.Modal(document.getElementById('empSelectModal'));
                modal.show();
            }

            function analyzeEmployeesForResignation() {
                const today = new Date();
                const currentYear = today.getFullYear();
                const currentMonth = today.getMonth();
                const currentDay = today.getDate();

                // Calculate last 15 days threshold
                const last15DaysStart = new Date(currentYear, currentMonth, currentDay - 15);

                // Calculate average sales of active employees
                const totalActiveSales = currentEmpList.reduce((sum, e) => sum + e.sales, 0);
                const avgActiveSales = currentEmpList.length > 0 ? totalActiveSales / currentEmpList.length : 0;

                // Analyze each employee
                return currentEmpList.map(emp => {
                    const suspectedReasons = [];

                    // Criteria 1: No sales in last 15 days
                    const dailyRecords = employeeDailyMaps[emp.id] || [];
                    let hasRecentSales = false;

                    dailyRecords.forEach(record => {
                        const recordDate = new Date(record.date);
                        if (recordDate >= last15DaysStart && record.sales > 0) {
                            hasRecentSales = true;
                        }
                    });

                    // Only flag if employee has SOME history but no recent sales
                    const noSalesLast15Days = dailyRecords.length > 0 && !hasRecentSales;
                    if (noSalesLast15Days) {
                        suspectedReasons.push('Ù„Ø§ Ù…Ø¨ÙŠØ¹Ø§Øª Ø¢Ø®Ø± 15 ÙŠÙˆÙ…');
                    }

                    // Criteria 2: Average sales less than 30% of active average
                    const lowAverage = avgActiveSales > 0 && emp.sales < (avgActiveSales * 0.3);
                    if (lowAverage) {
                        suspectedReasons.push('Ù…ØªÙˆØ³Ø· Ù…Ø¨ÙŠØ¹Ø§Øª Ø¶Ø¹ÙŠÙ');
                    }

                    // Determine status
                    let status = 'active'; // Default
                    if (suspectedReasons.length >= 2) {
                        status = 'high'; // Both criteria
                    } else if (suspectedReasons.length === 1) {
                        status = 'medium'; // One criteria
                    }

                    return {
                        ...emp,
                        suspectedStatus: status,
                        suspectedReasons: suspectedReasons,
                        selected: status === 'active' // Pre-select only active employees
                    };
                });
            }

            function populateEmployeeSelectionTable() {
                const tbody = document.getElementById('empSelectBody');

                // Sort: Store Name (ASC) -> Status (Active first -> Medium -> High)
                const sorted = [...employeeSelectionData].sort((a, b) => {
                    // 1. Sort by Store Name
                    const storeA = a.storeName || '';
                    const storeB = b.storeName || '';
                    const storeCmp = storeA.localeCompare(storeB, 'ar');

                    if (storeCmp !== 0) return storeCmp;

                    // 2. Sort by Status
                    const order = { 'active': 0, 'medium': 1, 'high': 2 };
                    return order[a.suspectedStatus] - order[b.suspectedStatus];
                });

                tbody.innerHTML = sorted.map((emp, idx) => {
                    const rowClass = emp.suspectedStatus === 'high' ? 'emp-suspected-high' :
                        emp.suspectedStatus === 'medium' ? 'emp-suspected-medium' : 'emp-active';

                    // Status Badge
                    let statusBadge = '';
                    if (emp.suspectedStatus === 'high') {
                        statusBadge = '<span class="badge bg-danger">Ù…Ø³ØªÙ‚ÙŠÙ„</span>';
                    } else if (emp.suspectedStatus === 'medium') {
                        statusBadge = '<span class="badge bg-warning text-dark">Ù…Ø±Ø§Ø¬Ø¹Ø©</span>';
                    } else {
                        statusBadge = '<span class="badge bg-success">Ù†Ø´Ø·</span>';
                    }

                    // Reasons
                    const reasonsHtml = emp.suspectedReasons.map(r =>
                        `<span class="badge badge-reason bg-secondary">${r}</span>`
                    ).join('');

                    return `
                    <tr class="emp-select-row ${rowClass}" data-emp-id="${emp.id}">
                        <td>
                            <input type="checkbox" class="emp-checkbox" 
                                   data-emp-id="${emp.id}" 
                                   ${emp.selected ? 'checked' : ''} 
                                   onchange="onEmployeeCheckChange('${emp.id}', this.checked)">
                        </td>
                        <td>
                            <div class="fw-bold">${emp.name}</div>
                            <small class="text-muted">${emp.id}</small>
                        </td>
                        <td><small>${emp.storeName}</small></td>
                        <td class="text-center fw-bold">${emp.sales.toLocaleString()}</td>
                        <td class="text-center">
                            ${statusBadge}
                            <div class="mt-1">${reasonsHtml}</div>
                        </td>
                    </tr>
                    `;
                }).join('');

                document.getElementById('totalEmpCount').textContent = employeeSelectionData.length;
            }

            function onEmployeeCheckChange(empId, isChecked) {
                const emp = employeeSelectionData.find(e => e.id === empId);
                if (emp) {
                    emp.selected = isChecked;
                }
                updateSelectionCount();
            }

            function selectAllEmployees(selected) {
                employeeSelectionData.forEach(emp => emp.selected = selected);
                document.querySelectorAll('.emp-checkbox').forEach(cb => cb.checked = selected);
                document.getElementById('selectAllCheckbox').checked = selected;
                updateSelectionCount();
            }

            function selectActiveOnly() {
                employeeSelectionData.forEach(emp => {
                    emp.selected = emp.suspectedStatus === 'active';
                });
                document.querySelectorAll('.emp-checkbox').forEach(cb => {
                    const empId = cb.dataset.empId;
                    const emp = employeeSelectionData.find(e => e.id === empId);
                    cb.checked = emp ? emp.selected : false;
                });
                document.getElementById('selectAllCheckbox').checked = false;
                updateSelectionCount();
            }

            function updateSelectionCount() {
                const selectedCount = employeeSelectionData.filter(e => e.selected).length;
                document.getElementById('selectedCount').textContent = selectedCount;

                // Update header checkbox state
                const allSelected = selectedCount === employeeSelectionData.length;
                document.getElementById('selectAllCheckbox').checked = allSelected;
            }

            function confirmExportSelection() {
                const selectedEmps = employeeSelectionData.filter(e => e.selected);

                if (selectedEmps.length === 0) {
                    alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ù…ÙˆØ¸Ù ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„');
                    return;
                }

                if (currentExportMode === 'pdf') {
                    // Save Selection
                    const selectedIds = selectedEmps.map(e => e.id);
                    localStorage.setItem('pdf_selected_employees', JSON.stringify(selectedIds));

                    // Generate PDF
                    generateEmployeePDF(selectedIds);

                    // Close Modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('empSelectModal'));
                    if (modal) modal.hide();
                    return;
                }

                // Export Target Template with selected employees
                const data = selectedEmps.map(e => {
                    // Clean ID: Remove 'Unknown', 'Unkown' and trim
                    let cleanId = e.id.toString().replace(/unknown/gi, '').replace(/unkown/gi, '').trim();

                    return {
                        "Employee ID": cleanId,
                        "Employee Name": e.name,
                        "Store": e.storeName,
                        "Target Amount": "" // Empty column for user input
                    };
                });

                const ws = XLSX.utils.json_to_sheet(data);
                ws['!cols'] = [{ wch: 15 }, { wch: 30 }, { wch: 20 }, { wch: 15 }];

                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Targets Template");

                const nextMonth = new Date();
                nextMonth.setMonth(nextMonth.getMonth() + 1);
                const monthName = nextMonth.toLocaleString('en-US', { month: 'long', year: 'numeric' });

                XLSX.writeFile(wb, `Target_Template_${monthName}.xlsx`);

                // Close Modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('empSelectModal'));
                if (modal) modal.hide();

                // Show success message
                alert(`ØªÙ… ØªØµØ¯ÙŠØ± ${selectedEmps.length} Ù…ÙˆØ¸Ù Ø¨Ù†Ø¬Ø§Ø­!`);
            }



            // === EMPLOYEE INSIGHT PANEL ===
            function openEmployeeInsights(empId) {
                const emp = currentEmpList.find(e => e.id === empId);
                if (!emp) return;

                // 1. Basic Info
                document.getElementById('panelEmpName').textContent = emp.name;
                document.getElementById('panelEmpStore').textContent = emp.storeName;
                document.getElementById('panelSales').textContent = emp.sales.toLocaleString('en-US', { maximumFractionDigits: 0 });
                document.getElementById('panelShare').textContent = emp.branchShare.toFixed(1) + '% Ù…Ù† Ø§Ù„ÙØ±Ø¹';

                const ach = emp.achievement ? emp.achievement.toFixed(1) + '%' : '-';
                const target = emp.target ? emp.target.toLocaleString() : '0';

                const achEl = document.getElementById('panelAch');
                achEl.textContent = ach;
                achEl.className = 'h3 fw-bold mb-0 ' + (emp.achievement >= 100 ? 'text-success' : emp.achievement >= 80 ? 'text-warning' : 'text-danger');
                document.getElementById('panelTarget').textContent = 'Ø§Ù„Ù‡Ø¯Ù: ' + target;

                // 2. Branch Comparisons
                // Calculate Branch Averages
                const bStats = branchStats[emp.storeCode];
                let bAvgTicket = 0;
                let bAvgUPT = 0;

                if (bStats && bStats.transactions > 0) {
                    bAvgTicket = bStats.current / bStats.transactions;
                    // Items might be needed to be accumulated in branchStats first, let's assume I added it in loadData
                    // Checking loadData modification... Yes I added items to branchStats
                    bAvgUPT = bStats.items / bStats.transactions;
                }

                // Render Comparisons
                renderCompMetric('AvgTicket', emp.avg_ticket, bAvgTicket, true); // true = higher is better
                renderCompMetric('UPT', emp.items_per_inv, bAvgUPT, true);

                document.getElementById('branchAvgTicket').textContent = Math.round(bAvgTicket).toLocaleString();
                document.getElementById('branchAvgUPT').textContent = bAvgUPT.toFixed(2);

                // 3. Render Trend Chart
                renderEmpTrendChart(empId);

                // Show Offcanvas
                const offcanvasEl = document.getElementById('empInsightPanel');
                const bsOffcanvas = new bootstrap.Offcanvas(offcanvasEl);
                bsOffcanvas.show();
            }

            function renderCompMetric(idSuffix, empVal, branchVal, higherIsBetter) {
                const diffBox = document.getElementById('diff' + idSuffix);
                const valBox = document.getElementById('panel' + idSuffix);

                // Set Value
                if (idSuffix === 'UPT') valBox.textContent = empVal.toFixed(2);
                else valBox.textContent = Math.round(empVal).toLocaleString();

                if (branchVal === 0) {
                    diffBox.textContent = '-';
                    diffBox.className = 'diff-badge diff-neutral';
                    return;
                }

                // Calculate % Diff
                const diffPerc = ((empVal - branchVal) / branchVal) * 100;
                const sign = diffPerc >= 0 ? '+' : '';
                const arrow = diffPerc >= 0 ? 'â–²' : 'â–¼';

                diffBox.innerHTML = `${arrow} ${sign}${Math.round(diffPerc)}%`;

                // Color Logic
                let isGood = higherIsBetter ? (diffPerc >= 0) : (diffPerc <= 0);
                // Slight tolerance +/- 1%
                if (Math.abs(diffPerc) < 1) {
                    diffBox.className = 'diff-badge diff-neutral';
                } else {
                    diffBox.className = isGood ? 'diff-badge diff-pos' : 'diff-badge diff-neg';
                }
            }

            function renderEmpTrendChart(empId) {
                const ctx = document.getElementById('empTrendChart').getContext('2d');

                // Get Daily Data (Last 7 days active)
                // Filter only for current month/period if strictly needed, or just last 7 available days
                let daily = employeeDailyMaps[empId] || [];

                // Sort by date
                daily.sort((a, b) => new Date(a.date) - new Date(b.date));

                // Take last 7 days provided they are recent? 
                // Or just last 7 records
                const recent = daily.slice(-7);

                const labels = recent.map(d => {
                    const date = new Date(d.date);
                    return date.getDate() + '/' + (date.getMonth() + 1);
                });
                const data = recent.map(d => d.sales);

                if (empTrendChartInstance) {
                    empTrendChartInstance.destroy();
                }

                empTrendChartInstance = new Chart(ctx, {
                    type: 'line',
                    /*
                    // The following code block was inserted as per instruction.
                    // It appears to be data processing logic and would cause a syntax error
                    // if placed directly within the Chart.js configuration object.
                    // It has been commented out to maintain a syntactically correct document.
                    // Please relocate this code to an appropriate data processing function (e.g., `loadData`)
                    // if it is intended to be active.
                    if (!branchStats[sid]) {
                        branchStats[sid] = { 
                            current: 0, 
                            prev: 0,
                            transactions: 0,
                            items: 0
                        };
                    }
                    
                    // Populate Employee Daily Helper
                    if (!employeeDailyMaps[cleanId]) {
                        employeeDailyMaps[cleanId] = [];
                    }
                    employeeDailyMaps[cleanId].push({
                        date: r[0],
                        sales: r[2],
                        inv: r[3],
                        items: r[4]
                    });

                    if (isCurrentPeriod) {
                        // Employee Aggregation
                        if (!historyData[cleanId]) {
                            historyData[cleanId] = {
                                id: cleanId,
                                name: empName, // Default to mapped name or clean ID
                                sales: 0,
                                transactions: 0,
                                items: 0,
                                storeCode: sid,
                                storeName: storeName,
                                prevSales: 0,
                                target: 0
                            };
                        }
                        historyData[cleanId].sales += r[2];
                        historyData[cleanId].transactions += r[3];
                        historyData[cleanId].items += r[4];

                        // Update Name if Arabic Map available
                        if (employeeNames && employeeNames[cleanId]) {
                            historyData[cleanId].name = employeeNames[cleanId];
                        }

                        // Branch Aggregation (Extended for Averages)
                        branchStats[sid].current += r[2];
                        branchStats[sid].transactions += r[3];
                        branchStats[sid].items += r[4];
                    }
                    */
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª',
                            data: data,
                            borderColor: '#fe7900',
                            backgroundColor: 'rgba(254, 121, 0, 0.1)',
                            borderWidth: 2,
                            tension: 0.3,
                            fill: true,
                            pointRadius: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                grid: { display: false }
                            },
                            x: {
                                grid: { display: false }
                            }
                        }
                    }
                });
            }

            // Initialize
            loadData();
        </script>

</body>

</html>