<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Orange | Executive Dashboard</title>

    <!-- Bootstrap 5 RTL -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">

    <style>
        :root {
            --bs-primary: #fe7900;
            /* Orange Brand */
            --bs-secondary: #6c757d;
            --bg-light: #f8f9fa;
            --card-radius: 12px;
            --font-main: 'Tajawal', sans-serif;
        }

        body {
            font-family: var(--font-main);
            background-color: var(--bg-light);
            color: #212529;
        }

        /* Navbar */
        .navbar {
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            background: white !important;
        }

        .navbar-brand {
            font-weight: 800;
            color: #000 !important;
        }

        .brand-orange {
            color: #fe7900;
        }

        /* KPI Cards */
        .kpi-card {
            background: white;
            border: none;
            border-radius: var(--card-radius);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.03);
            transition: transform 0.2s;
            padding: 20px;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .kpi-card:hover {
            transform: translateY(-3px);
        }

        .kpi-title {
            font-size: 0.9rem;
            color: #6c757d;
            font-weight: 500;
            margin-bottom: 8px;
        }

        .kpi-value {
            font-size: 1.8rem;
            font-weight: 800;
            color: #000;
        }

        .kpi-sub {
            font-size: 0.8rem;
            margin-top: 5px;
        }

        .text-success-custom {
            color: #198754;
        }

        .text-danger-custom {
            color: #dc3545;
        }

        /* Sections */
        .section-title {
            font-weight: 700;
            margin-bottom: 20px;
            border-right: 4px solid #fe7900;
            padding-right: 10px;
        }

        /* Charts */
        .chart-container {
            background: white;
            padding: 20px;
            border-radius: var(--card-radius);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.03);
            margin-bottom: 20px;
            min-height: 350px;
        }

        /* Table */
        .table-custom thead th {
            background-color: #fe7900;
            color: white;
            font-weight: 500;
            border: none;
        }

        .table-custom tbody tr:hover {
            background-color: #fff3e0;
        }

        .rank-badge {
            background: #fe7900;
            color: white;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
        }

        /* Tooltip Customization */
        .custom-tooltip {
            --bs-tooltip-bg: #343a40;
            --bs-tooltip-color: #fff;
        }

        /* Analysis Cards */
        .analysis-card {
            background: white;
            border-radius: var(--card-radius);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.03);
            height: 100%;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .analysis-header {
            padding: 15px;
            border-bottom: 1px solid #eee;
            background-color: #fff;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .analysis-body {
            flex: 1;
            padding: 0;
            overflow-y: auto;
            max-height: 300px;
        }

        /* Growth Table */
        .growth-pos {
            color: #198754;
            font-weight: bold;
        }

        .growth-neg {
            color: #dc3545;
            font-weight: bold;
        }

        /* Early Warning */
        .risk-high {
            background-color: #ffebee;
            color: #c62828;
        }

        .risk-med {
            background-color: #fff3e0;
            color: #ef6c00;
        }

        .risk-low {
            background-color: #e8f5e9;
            color: #2e7d32;
        }

        .progress-micro {
            height: 6px;
            border-radius: 3px;
            background-color: #e9ecef;
            margin-top: 4px;
        }
    </style>
</head>

<body>

    <!-- Top Bar -->
    <nav class="navbar mb-4 sticky-top">
        <div class="container-fluid position-relative">
            <!-- Left: Brand -->
            <span class="navbar-brand"><span class="brand-orange">ORANGE</span> DASHBOARD</span>

            <!-- Center: Today's Sales (Clickable) - DESKTOP ONLY -->
            <div class="position-absolute top-50 start-50 translate-middle d-none d-md-block">
                <button onclick="filterToday()"
                    class="btn btn-white border shadow-sm d-flex align-items-center gap-2 px-3 py-2"
                    title="Ø§Ø¶ØºØ· Ù„Ø¹Ø±Ø¶ Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„ÙŠÙˆÙ…" style="border-radius: 50px;">
                    <span class="fw-bold text-dark" style="font-size: 0.95rem;">
                        ğŸ›’ Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„ÙŠÙˆÙ…: <span class="text-primary today-sales-val">0</span>
                    </span>
                    <span class="text-muted border-start ps-2" style="font-size: 0.85rem;" id="lastUpdate">...</span>
                </button>
            </div>

            <!-- Right: Actions -->
            <div class="d-flex gap-2">
                <!-- Mobile Today's Sales (Hidden on Desktop) -->
                <button onclick="filterToday()"
                    class="btn btn-light border btn-sm d-md-none fw-bold text-primary d-flex align-items-center gap-1">
                    ğŸ›’ <span class="today-sales-val">0</span>
                </button>

                <a href="employees.html" class="btn btn-outline-primary btn-sm fw-bold">
                    ğŸ‘¥ <span class="d-none d-lg-inline">Ø£Ø¯Ø§Ø¡ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</span>
                </a>
                <a href="product_analysis.html" class="btn btn-outline-primary btn-sm fw-bold">
                    ğŸ“¦ <span class="d-none d-lg-inline">ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</span>
                </a>
                <button onclick="generatePDF()" class="btn btn-warning btn-sm fw-bold text-white">
                    ğŸ“„ <span class="d-none d-lg-inline">PDF</span>
                </button>
                <button onclick="logout()" class="btn btn-danger btn-sm fw-bold">Ø®Ø±ÙˆØ¬</button>
            </div>
        </div>
    </nav>

    <!-- jsPDF & Autotable -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <!-- Arabic Font Base64 -->
    <script src="assets/amiri_font.js"></script>
    <script src="pdf_export.js"></script>

    <script>
        // Session Check
        const currentUser = JSON.parse(localStorage.getItem('currentUser'));
        if (!currentUser) {
            window.location.href = 'login.html';
        }

        function logout() {
            localStorage.removeItem('currentUser');
            window.location.href = 'login.html';
        }
    </script>

    <div class="container-fluid px-4">

        <!-- Advanced Filter Bar -->
        <div class="card border-0 shadow-sm p-3 mb-4">
            <div class="row align-items-center g-3">

                <!-- Filter Mode -->
                <div class="col-md-auto">
                    <label class="form-label small text-muted fw-bold">Ù†ÙˆØ¹ Ø§Ù„ØªÙ‚Ø±ÙŠØ±</label>
                    <select id="filterMode" class="form-select form-select-sm" onchange="toggleFilterMode()">
                        <option value="standard">Ø³Ù†ÙˆÙŠ / Ø´Ù‡Ø±ÙŠ</option>
                        <option value="custom" selected>ÙØªØ±Ø© Ù…Ø®ØµØµØ© (Custom Range)</option>
                    </select>
                </div>

                <!-- Standard Filters (Year/Month) -->
                <div id="stdFilters" class="col-md-auto d-flex gap-2">
                    <div id="yearFilterContainer">
                        <label class="form-label small text-muted fw-bold">Ø§Ù„Ø³Ù†Ø©</label>
                        <select id="yearFilter" class="form-select form-select-sm" onchange="updateDashboard()">
                            <option value="2026" selected>2026</option>
                            <option value="2025">2025</option>
                            <option value="2024">2024</option>
                        </select>
                    </div>
                    <div id="monthFilterContainer">
                        <label class="form-label small text-muted fw-bold">Ø§Ù„Ø´Ù‡Ø±</label>
                        <select id="monthFilter" class="form-select form-select-sm" onchange="updateDashboard()">
                            <option value="all">ÙƒÙ„ Ø§Ù„Ø³Ù†Ø©</option>
                            <!-- JS Populated -->
                        </select>
                    </div>
                </div>

                <!-- Custom Filters (Date Range) -->
                <div id="customFilters" class="col-md-auto gap-2" style="display: none;">
                    <div>
                        <label class="form-label small text-muted fw-bold">Ù…Ù† ØªØ§Ø±ÙŠØ®</label>
                        <input type="date" id="startDate" class="form-control form-control-sm">
                    </div>
                    <div>
                        <label class="form-label small text-muted fw-bold">Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®</label>
                        <input type="date" id="endDate" class="form-control form-control-sm">
                    </div>
                </div>

                <!-- Manager Filter -->
                <div class="col-md">
                    <label class="form-label small text-muted fw-bold">Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ù†Ø·Ù‚Ø© (Manager)</label>
                    <select id="managerFilter" class="form-select form-select-sm" onchange="updateDashboard()">
                        <option value="all">Ø§Ù„ÙƒÙ„</option>
                    </select>
                </div>

                <!-- City Filter -->
                <div class="col-md">
                    <label class="form-label small text-muted fw-bold">Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© (City)</label>
                    <select id="cityFilter" class="form-select form-select-sm" onchange="updateDashboard()">
                        <option value="all">Ø§Ù„ÙƒÙ„</option>
                    </select>
                </div>

                <!-- Type Filter (Showroom/Online) -->
                <div class="col-md">
                    <label class="form-label small text-muted fw-bold">Ù†ÙˆØ¹ Ø§Ù„Ù…Ø¹Ø±Ø¶ (Type)</label>
                    <select id="typeFilter" class="form-select form-select-sm" onchange="updateDashboard()">
                        <option value="all">Ø§Ù„ÙƒÙ„</option>
                        <option value="Showroom">Ù…Ø¹Ø§Ø±Ø¶</option>
                        <option value="Online">Ø£ÙˆÙ†Ù„Ø§ÙŠÙ†</option>
                    </select>
                </div>

                <!-- Branch Filter -->
                <div class="col-md">
                    <label class="form-label small text-muted fw-bold">Ø§Ù„Ù…Ø¹Ø±Ø¶ / Ø§Ù„ÙØ±Ø¹</label>
                    <select id="branchFilter" class="form-select form-select-sm" onchange="updateDashboard()">
                        <option value="all">ÙƒØ§ÙØ© Ø§Ù„ÙØ±ÙˆØ¹</option>
                        <!-- JS Populated -->
                    </select>
                </div>

                <div class="col-md-auto align-self-end">
                    <button class="btn btn-primary btn-sm w-100 fw-bold" onclick="updateDashboard()">Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚Ø±ÙŠØ±
                        ğŸ”„</button>
                </div>
            </div>
        </div>

        <!-- Row 1: High Level KPIs (Current) -->
        <h6 class="text-muted fw-bold mb-2">Ø£Ø¯Ø§Ø¡ Ø§Ù„Ø¹Ø§Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ (<span id="currYearTitle">...</span>)</h6>
        <div class="row g-3 mb-3">
            <div class="col">
                <div class="kpi-card border-bottom border-4 border-warning">
                    <div class="kpi-title">Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª (Sales)</div>
                    <div class="kpi-value" id="totalSales">0</div>
                    <div class="kpi-sub">
                        <span id="salesGrowthVal">0%</span>
                        vs <span id="prevYearLabel">Prev Year</span>
                    </div>
                </div>
            </div>
            <div class="col">
                <div class="kpi-card border-bottom border-4 border-dark">
                    <div class="kpi-title">Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¹Ù…ÙŠÙ„ (Cust Value)</div>
                    <div class="kpi-value" id="totalCustValue">0</div>
                    <div class="kpi-sub text-muted">Sales / Visitors</div>
                </div>
            </div>
            <div class="col">
                <div class="kpi-card border-bottom border-4 border-primary">
                    <div class="kpi-title">Ø§Ù„ÙÙˆØ§ØªÙŠØ± (Transactions)</div>
                    <div class="kpi-value" id="totalTrans">0</div>
                    <div class="kpi-sub text-muted">Avg Invoice: <span id="avgTicket" class="fw-bold">0</span></div>
                </div>
            </div>
            <div class="col">
                <div class="kpi-card border-bottom border-4 border-info">
                    <div class="kpi-title">Ø§Ù„Ø²ÙˆØ§Ø± (Visitors)</div>
                    <div class="kpi-value" id="totalVisitors">0</div>
                    <div class="kpi-sub text-muted">Conv. Rate: <span id="convRate" class="fw-bold">0%</span></div>
                </div>
            </div>
            <div class="col">
                <div class="kpi-card border-bottom border-4 border-success">
                    <div class="kpi-title">ØªØ­Ù‚ÙŠÙ‚ Ø§Ù„Ù‡Ø¯Ù (Target)</div>
                    <div class="d-flex align-items-center justify-content-between">
                        <span class="kpi-value" id="targetPct">0%</span>
                        <div style="width: 50px; height: 50px;">
                            <canvas id="miniGauge"></canvas>
                        </div>
                    </div>
                    <div class="kpi-sub text-muted">Target: <span id="targetVal">0</span></div>
                </div>
            </div>
        </div>

        <!-- Row 2: Previous Year KPIs -->
        <h6 class="text-muted fw-bold mb-2">Ø£Ø¯Ø§Ø¡ Ø§Ù„Ø¹Ø§Ù… Ø§Ù„Ø³Ø§Ø¨Ù‚ (<span id="prevYearTitle">...</span>)</h6>
        <div class="row g-3 mb-4">
            <div class="col-md-3">
                <div class="kpi-card bg-light">
                    <div class="kpi-title text-muted">Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„Ø¹Ø§Ù… Ø§Ù„Ø³Ø§Ø¨Ù‚</div>
                    <div class="kpi-value text-secondary" id="prevSales" style="font-size: 1.5rem;">0</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="kpi-card bg-light">
                    <div class="kpi-title text-muted">ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ø¹Ø§Ù… Ø§Ù„Ø³Ø§Ø¨Ù‚</div>
                    <div class="kpi-value text-secondary" id="prevTrans" style="font-size: 1.5rem;">0</div>
                    <div class="kpi-sub text-muted">Avg Invoice: <span id="prevAvgTicket">0</span></div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="kpi-card bg-light">
                    <div class="kpi-title text-muted">Ø²ÙˆØ§Ø± Ø§Ù„Ø¹Ø§Ù… Ø§Ù„Ø³Ø§Ø¨Ù‚</div>
                    <div class="kpi-value text-secondary" id="prevVisitors" style="font-size: 1.5rem;">0</div>
                    <div class="kpi-sub text-muted">Conv. Rate: <span id="prevConvRate">0%</span></div>
                </div>
            </div>
            <!-- Growth Amount -->
            <div class="col-md-3">
                <div class="kpi-card bg-light d-flex align-items-center justify-content-center">
                    <div class="text-center">
                        <div class="kpi-title text-muted">Ù‚ÙŠÙ…Ø© Ø§Ù„Ù†Ù…Ùˆ (Growth Value)</div>
                        <div class="fw-bold fs-4" id="growthAbs">0</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Row 2.5: Daily Report (Accordion) -->
        <div class="accordion mb-4 text-center" id="dailyAccordion">
            <div class="accordion-item border-0 shadow-sm" style="border-radius: var(--card-radius); overflow: hidden;">
                <h2 class="accordion-header" id="headingDaily">
                    <button class="accordion-button collapsed fw-bold text-primary bg-white" type="button"
                        data-bs-toggle="collapse" data-bs-target="#collapseDaily" aria-expanded="false"
                        aria-controls="collapseDaily">
                        ğŸ“Š Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„ÙŠÙˆÙ…ÙŠ: &nbsp;<span id="dailyReportTitle" class="text-dark">Ø¬Ø§Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„...</span>
                    </button>
                </h2>
                <div id="collapseDaily" class="accordion-collapse collapse" aria-labelledby="headingDaily"
                    data-bs-parent="#dailyAccordion">
                    <div class="accordion-body p-0">
                        <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                            <!-- Daily Table -->
                            <table class="table table-striped table-hover mb-0 align-middle">
                                <thead class="table-light sticky-top" style="z-index: 1;">
                                    <tr>
                                        <th class="text-center">#</th>
                                        <th>Ø§Ù„ÙØ±Ø¹</th>
                                        <th onclick="setDailySort('salesY')" style="cursor: pointer;">Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„Ø£Ù…Ø³ â†•
                                        </th>
                                        <th class="text-muted" style="font-size: 0.9em;">Ø§Ù„Ø¹Ø§Ù… Ø§Ù„Ù…Ø§Ø¶ÙŠ</th>
                                        <th onclick="setDailySort('growth')" style="cursor: pointer;">Ø§Ù„Ù†Ù…Ùˆ % â†•
                                        </th>
                                        <th onclick="setDailySort('dailyReq')" style="cursor: pointer;">Ø§Ù„ÙŠÙˆÙ…ÙŠØ© Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©
                                            (Rem. Daily) â†•
                                        </th>
                                        <th onclick="setDailySort('trans')" style="cursor: pointer;">Ø¹Ø¯Ø¯ Ø§Ù„ÙÙˆØ§ØªÙŠØ± â†•</th>
                                        <th onclick="setDailySort('avgInv')" style="cursor: pointer;">Ù…ØªÙˆØ³Ø· Ø§Ù„ÙØ§ØªÙˆØ±Ø©
                                            (Inv Rate) â†•</th>
                                        <th onclick="setDailySort('visitY')" style="cursor: pointer;">Ø²ÙˆØ§Ø± â†•</th>
                                        <th class="text-muted" onclick="setDailySort('visitLY')"
                                            style="font-size: 0.9em; cursor: pointer;">Ø²ÙˆØ§Ø± (LY)</th>
                                        <th onclick="setDailySort('conv')" style="cursor: pointer;">ØªØ­ÙˆÙŠÙ„ % â†•</th>
                                    </tr>
                                </thead>
                                <tbody id="dailyTableBody">
                                    <!-- JS -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Row 3: Charts -->
        <div class="row">
            <!-- Monthly Trend -->
            <div class="col-md-8">
                <h5 class="section-title">Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø§Ù„Ø´Ù‡Ø±ÙŠ (Monthly Trend)</h5>
                <div class="chart-container">
                    <canvas id="trendChart"></canvas>
                </div>
            </div>
            <!-- Top 10 -->
            <div class="col-md-4">
                <h5 class="section-title">Ø£Ø¹Ù„Ù‰ 10 ÙØ±ÙˆØ¹ (Top 10)</h5>
                <div class="chart-container">
                    <canvas id="top10Chart"></canvas>
                </div>
            </div>
        </div>

        <!-- Row 3.5: Advanced Analysis (Growth, Gap, Risk) -->
        <h5 class="section-title mt-4">Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…ØªÙ‚Ø¯Ù… (Advanced Analysis)</h5>
        <div class="row g-3 mb-4">

            <!-- 1. Growth Contribution -->
            <div class="col-lg-4">
                <div class="analysis-card">
                    <div class="analysis-header">
                        <h6 class="m-0 fw-bold text-primary">
                            ğŸŒ± Ù…Ø³Ø§Ù‡Ù…Ø© Ø§Ù„Ù†Ù…Ùˆ (Contribution)
                            <i class="fas fa-info-circle text-muted ms-1" data-bs-toggle="tooltip"
                                title="ÙŠÙˆØ¶Ø­ Ø§Ù„ÙØ±ÙˆØ¹ Ø§Ù„Ø£ÙƒØ«Ø± Ù…Ø³Ø§Ù‡Ù…Ø© ÙÙŠ Ø²ÙŠØ§Ø¯Ø© (Ø£Ùˆ Ù†Ù‚Øµ) Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ù…Ù‚Ø§Ø±Ù†Ø© Ø¨Ø§Ù„Ø¹Ø§Ù… Ø§Ù„Ù…Ø§Ø¶ÙŠ"></i>
                        </h6>
                    </div>
                    <div class="analysis-body">
                        <table class="table table-sm table-hover mb-0" style="font-size: 0.9rem;">
                            <thead class="table-light sticky-top">
                                <tr>
                                    <th>Ø§Ù„ÙØ±Ø¹</th>
                                    <th>Ø§Ù„Ù†Ù…Ùˆ</th>
                                    <th>Ø§Ù„Ù…Ø³Ø§Ù‡Ù…Ø© %</th>
                                </tr>
                            </thead>
                            <tbody id="growthContribBody">
                                <!-- JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- 2. Target Gap -->
            <div class="col-lg-4">
                <div class="analysis-card">
                    <div class="analysis-header">
                        <h6 class="m-0 fw-bold text-danger">
                            ğŸ¯ ÙØ¬ÙˆØ© Ø§Ù„Ù‡Ø¯Ù (Target Gap)
                            <i class="fas fa-info-circle text-muted ms-1" data-bs-toggle="tooltip"
                                title="Ø§Ù„ÙØ±ÙˆØ¹ Ø§Ù„ØªÙŠ Ù„Ù… ØªØ­Ù‚Ù‚ Ø§Ù„Ù‡Ø¯Ù Ø¨Ø¹Ø¯ØŒ Ù…Ø±ØªØ¨Ø© Ø­Ø³Ø¨ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ (Ø§Ù„Ø£Ø¹Ù„Ù‰ ÙØ§Ù„Ø£Ù‚Ù„)"></i>
                        </h6>
                    </div>
                    <div class="analysis-body p-3">
                        <ul class="list-group list-group-flush" id="targetGapList">
                            <!-- JS -->
                        </ul>
                    </div>
                </div>
            </div>

            <!-- 3. Early Warning -->
            <div class="col-lg-4">
                <div class="analysis-card">
                    <div class="analysis-header">
                        <h6 class="m-0 fw-bold text-warning">
                            âš ï¸ Ø§Ù„Ø¥Ù†Ø°Ø§Ø± Ø§Ù„Ù…Ø¨ÙƒØ± (Early Warning)
                            <i class="fas fa-info-circle text-muted ms-1" data-bs-toggle="tooltip"
                                title="ÙØ±ÙˆØ¹ Ø£Ø¯Ø§Ø¤Ù‡Ø§ Ø£Ù‚Ù„ Ù…Ù† Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…Ù†Ù‚Ø¶ÙŠ Ù…Ù† Ø§Ù„Ø´Ù‡Ø± ÙˆØªÙˆØ§Ø¬Ù‡ Ø®Ø·Ø± Ø¹Ø¯Ù… ØªØ­Ù‚ÙŠÙ‚ Ø§Ù„Ù‡Ø¯Ù"></i>
                        </h6>
                    </div>
                    <div class="analysis-body">
                        <table class="table table-sm mb-0" style="font-size: 0.85rem;">
                            <thead class="table-light sticky-top">
                                <tr>
                                    <th>Ø§Ù„ÙØ±Ø¹</th>
                                    <th>Ø§Ù„ØªØ­Ù‚ÙŠÙ‚</th>
                                    <th>Ø§Ù„ØªÙ‚ÙŠÙŠÙ…</th>
                                </tr>
                            </thead>
                            <tbody id="earlyWarningBody">
                                <!-- JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Row 3: Detailed Table -->
        <div class="row mt-4">
            <div class="col-12">
                <h5 class="section-title">ØªÙØ§ØµÙŠÙ„ Ø§Ù„ÙØ±ÙˆØ¹ (Detailed Report)</h5>
                <div class="card border-0 shadow-sm p-3">
                    <div class="table-responsive">
                        <table class="table table-custom align-middle">
                            <thead>
                                <tr>
                                    <th class="text-center">#</th>
                                    <th onclick="setSort('name')" style="cursor: pointer;">Ø§Ù„ÙØ±Ø¹ (Branch) â†•</th>
                                    <th class="text-center" onclick="setSort('val')" style="cursor: pointer;">Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª
                                        (Sales) â†•</th>
                                    <th class="text-center" onclick="setSort('prevVal')" style="cursor: pointer;">Ù…Ø¨ÙŠØ¹Ø§Øª
                                        Ø§Ù„Ø¹Ø§Ù… Ø§Ù„Ø³Ø§Ø¨Ù‚ (Last Year) â†•</th>
                                    <th class="text-center" onclick="setSort('target')" style="cursor: pointer;">Ø§Ù„Ù‡Ø¯Ù
                                        (Target) â†•</th>
                                    <th class="text-center" onclick="setSort('ach')" style="cursor: pointer;">
                                        Ø§Ù„ØªØ­Ù‚ÙŠÙ‚ (%)
                                        â†•</th>
                                    <th class="text-center" onclick="setSort('growth')" style="cursor: pointer;">Ø§Ù„Ù†Ù…Ùˆ
                                        (Growth %) â†•</th>
                                    <th class="text-center" onclick="setSort('absGrowth')" style="cursor: pointer;">Ù‚ÙŠÙ…Ø©
                                        Ø§Ù„Ù†Ù…Ùˆ (Growth Val) â†•</th>
                                    <th class="text-center" onclick="setSort('dailyReq')" style="cursor: pointer;">
                                        Ø§Ù„ÙŠÙˆÙ…ÙŠØ© Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ© (Remaining Daily) â†•</th>
                                    <th class="text-center" onclick="setSort('trans')" style="cursor: pointer;">Ø§Ù„ÙÙˆØ§ØªÙŠØ±
                                        (Trans) â†•</th>
                                    <th class="text-center" onclick="setSort('avgInv')" style="cursor: pointer;">Ù…ØªÙˆØ³Ø·
                                        Ø§Ù„ÙØ§ØªÙˆØ±Ø© (Inv Rate) â†•</th>
                                    <th class="text-center" onclick="setSort('visitors')" style="cursor: pointer;">
                                        Ø§Ù„Ø²ÙˆØ§Ø± (Vis) â†•</th>
                                    <th class="text-center text-muted" onclick="setSort('prevVisitors')"
                                        style="cursor: pointer;">
                                        Ø²ÙˆØ§Ø± Ø§Ù„Ø¹Ø§Ù… Ø§Ù„Ø³Ø§Ø¨Ù‚ (Vis LY) â†•</th>
                                    <th class="text-center" onclick="setSort('custVal')" style="cursor: pointer;">Ù‚ÙŠÙ…Ø©
                                        Ø§Ù„Ø¹Ù…ÙŠÙ„ (Val) â†•</th>
                                    <th class="text-center" onclick="setSort('conv')" style="cursor: pointer;">Ø§Ù„ØªØ­ÙˆÙŠÙ„
                                        (Vis Rate) â†•</th>
                                </tr>
                            </thead>
                            <tbody id="detailsTableBody">
                                <!-- JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Branch Details Modal -->
        <div class="modal fade" id="branchModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-xl">
                <div class="modal-content">
                    <div class="modal-header bg-light">
                        <h5 class="modal-title fw-bold" id="branchModalTitle">ØªÙØ§ØµÙŠÙ„ Ø§Ù„ÙØ±Ø¹</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div id="modalSpinner" class="text-center py-5">
                            <div class="spinner-border text-primary" role="status"></div>
                            <p class="mt-2 text-muted">Ø¬Ø§Ø± ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†...</p>
                        </div>

                        <div id="modalContent" style="display: none;">
                            <div class="row">
                                <!-- Left: Yesterday -->
                                <div class="col-lg-6 mb-3">
                                    <div class="card shadow-sm border-0 h-100">
                                        <div class="card-header bg-white fw-bold text-center border-bottom-0">
                                            ğŸ“… Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„Ø£Ù…Ø³ (<span id="modalDateYesterday"></span>)
                                        </div>
                                        <div class="table-responsive">
                                            <table class="table table-sm table-hover mb-0" style="font-size: 0.9rem;">
                                                <thead class="table-light">
                                                    <tr>
                                                        <th>Ø§Ù„Ù…ÙˆØ¸Ù</th>
                                                        <th>Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</th>
                                                        <th>Ù…Ø³Ø§Ù‡Ù…Ø© %</th>
                                                        <th>ÙÙˆØ§ØªÙŠØ±</th>
                                                        <th>Avg Inv</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="tbodyYest"></tbody>
                                                <tfoot id="tfootYest" class="fw-bold table-light"></tfoot>
                                            </table>
                                        </div>
                                    </div>
                                </div>

                                <!-- Right: Month to Date -->
                                <div class="col-lg-6 mb-3">
                                    <div class="card shadow-sm border-0 h-100">
                                        <div class="card-header bg-white fw-bold text-center border-bottom-0">
                                            ğŸ“… Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„Ø´Ù‡Ø± (<span id="modalDateMonth"></span>)
                                        </div>
                                        <div class="table-responsive">
                                            <table class="table table-sm table-hover mb-0" style="font-size: 0.9rem;">
                                                <thead class="table-light">
                                                    <tr>
                                                        <th>Ø§Ù„Ù…ÙˆØ¸Ù</th>
                                                        <th>Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</th>
                                                        <th>Ù…Ø³Ø§Ù‡Ù…Ø© %</th>
                                                        <th>ÙÙˆØ§ØªÙŠØ±</th>
                                                        <th>Avg Inv</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="tbodyMonth"></tbody>
                                                <tfoot id="tfootMonth" class="fw-bold table-light"></tfoot>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        let rawData = null;
        let charts = {};

        // Sorting State

        let currentSort = { col: 'val', asc: false }; // Default: Sales Desc
        let dailySort = { col: 'salesY', asc: false }; // Daily Report Sort

        function setSort(col) {
            if (currentSort.col === col) {
                currentSort.asc = !currentSort.asc;
            } else {
                currentSort.col = col;
                currentSort.asc = false; // Default desc for new col
            }
            updateDashboard();
        }

        function setDailySort(col) {
            if (dailySort.col === col) {
                dailySort.asc = !dailySort.asc;
            } else {
                dailySort.col = col;
                dailySort.asc = false;
            }
            renderDailyReport();
        }

        async function init() {
            // Init Month Filter
            const months = ["ÙŠÙ†Ø§ÙŠØ±", "ÙØ¨Ø±Ø§ÙŠØ±", "Ù…Ø§Ø±Ø³", "Ø£Ø¨Ø±ÙŠÙ„", "Ù…Ø§ÙŠÙˆ", "ÙŠÙˆÙ†ÙŠÙˆ", "ÙŠÙˆÙ„ÙŠÙˆ", "Ø£ØºØ³Ø·Ø³", "Ø³Ø¨ØªÙ…Ø¨Ø±", "Ø£ÙƒØªÙˆØ¨Ø±", "Ù†ÙˆÙÙ…Ø¨Ø±", "Ø¯ÙŠØ³Ù…Ø¨Ø±"];
            const mSelect = document.getElementById('monthFilter');
            months.forEach((m, i) => {
                let opt = document.createElement('option');
                opt.value = i + 1;
                opt.textContent = m;
                mSelect.appendChild(opt);
            });

            try {
                const res = await fetch('management_data.json?t=' + Date.now());
                rawData = await res.json();

                // 1. Update Time (Show Time Only or Date+Time)
                // User asked for "Time of last update"
                let genTime = rawData.metadata.generated_at.split(' ')[1]; // HH:MM:SS
                // Remove seconds if desired, but seconds are fine. 
                // Let's format it nicer: HH:MM
                let shortTime = genTime.split(':').slice(0, 2).join(':');
                document.getElementById('lastUpdate').textContent = shortTime;

                // 2. Calculate Today's Sales (Global or Filtered?)
                // Usually Header KPI is Global (for the logged in user's scope)
                calculateTodayHeader();

                // Populate Filters (Branch, City, Manager)
                const bSelect = document.getElementById('branchFilter');
                const cSelect = document.getElementById('cityFilter');
                const mSelect = document.getElementById('managerFilter');

                const storeIds = Object.keys(rawData.stores);
                const cities = new Set();
                const managers = new Set();

                // Sort by Name
                storeIds.sort((a, b) => (rawData.stores[a] || '').localeCompare(rawData.stores[b] || ''));

                storeIds.forEach(sid => {
                    // Branch
                    let opt = document.createElement('option');
                    opt.value = sid;
                    opt.textContent = rawData.stores[sid] || sid;
                    bSelect.appendChild(opt);

                    // Collect Meta
                    let meta = rawData.store_meta ? rawData.store_meta[sid] : null;
                    if (meta) {
                        if (meta.city && meta.city !== 'Unknown') cities.add(meta.city);
                        if (meta.manager && meta.manager !== 'Unknown') managers.add(meta.manager);
                    }
                });

                // Populate City
                [...cities].sort().forEach(c => {
                    let opt = document.createElement('option');
                    opt.value = c;
                    opt.textContent = c;
                    cSelect.appendChild(opt);
                });

                // Populate Manager
                [...managers].sort().forEach(m => {
                    let opt = document.createElement('option');
                    opt.value = m;
                    opt.textContent = m;
                    mSelect.appendChild(opt);
                });

                // Set Dates Default for Custom Range (Month Start -> Yesterday)
                let today = new Date();
                let yesterday = new Date(today);
                yesterday.setDate(today.getDate() - 1);

                document.getElementById('endDate').value = yesterday.toLocaleDateString('en-CA');

                // Start date: Start of this month
                let firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
                document.getElementById('startDate').value = firstDay.toLocaleDateString('en-CA');

                // Ensure UI reflects Custom Mode
                toggleFilterMode();

                // Apply Permissions
                if (currentUser.role !== 'Admin') {
                    // Hide Manager Filter
                    document.getElementById('managerFilter').parentElement.style.display = 'none';
                    // Force Select (Visual)
                    mSelect.value = currentUser.name;
                    mSelect.disabled = true;
                }

                // [CUSTOM REQUEST] Add Ramadan Filter for Sales Manager ONLY
                if (currentUser.name === 'Sales Manager' || currentUser.role === 'Admin') {
                    // Note: User asked for "Sales Manager" specifically, but Admin role check is safer/broader.
                    // Adjusted to be strict on name if preferred, but usually Role is better. 
                    // User said: "When sales manager logs in..."
                    // The login for Sales Manager has role 'Admin' (see users.js).
                    // So we can check for that, or specific name. Let's use specific name to be precise to the request.
                    if (currentUser.name === 'Sales Manager') {
                        const fm = document.getElementById('filterMode');
                        const opt = document.createElement('option');
                        opt.value = 'ramadan';
                        opt.textContent = 'Ù…Ù‚Ø§Ø±Ù†Ø© Ø±Ù…Ø¶Ø§Ù† (Ramadan)';
                        fm.appendChild(opt);
                    }
                }

                updateDashboard();
            } catch (e) { console.error(e); }
        }

        // Toggle UI
        function toggleFilterMode() {
            const mode = document.getElementById('filterMode').value;
            const std = document.getElementById('stdFilters');
            const cust = document.getElementById('customFilters');
            const yearC = document.getElementById('yearFilterContainer');
            const monthC = document.getElementById('monthFilterContainer');

            if (mode === 'custom') {
                std.style.display = 'none';
                cust.style.display = 'flex';
            } else if (mode === 'ramadan') {
                std.style.display = 'flex';
                cust.style.display = 'none';
                // Show Year, Hide Month
                yearC.style.display = 'block';
                monthC.style.display = 'none';
            } else {
                // Standard
                std.style.display = 'flex';
                cust.style.display = 'none';
                yearC.style.display = 'block';
                monthC.style.display = 'block';
            }
        }

        // Helper: Format Date YYYY-MM-DD
        const toYMD = (d) => d.toLocaleDateString('en-CA');

        function filterToday() {
            const today = toYMD(new Date());

            // Set Filter Mode to Custom
            const modeSelect = document.getElementById('filterMode');
            modeSelect.value = 'custom';
            toggleFilterMode(); // Update UI

            // Set Dates
            document.getElementById('startDate').value = today;
            document.getElementById('endDate').value = today;

            // Trigger Update
            updateDashboard();
        }

        function calculateTodayHeader() {
            if (!rawData) return;

            // Get today's date string YYYY-MM-DD
            // Note: rawData uses local time dates usually. 
            // Ensure we match the timezone logic of the system.
            let todayStr = toYMD(new Date());

            let totalToday = 0;

            // Respect Manager Filter (Security)
            let selManager = 'all';
            if (currentUser.role !== 'Admin') {
                selManager = currentUser.name;
            }

            rawData.sales.forEach(([d, s, v]) => {
                if (d === todayStr) {
                    // Check Manager Permission
                    if (selManager !== 'all') {
                        let meta = rawData.store_meta ? rawData.store_meta[s] : null;
                        if (!meta || meta.manager !== selManager) return;
                    }
                    totalToday += v;
                }
            });

            // Update UI (All instances)
            const els = document.querySelectorAll('.today-sales-val');
            els.forEach(el => {
                el.textContent = totalToday.toLocaleString();
            });
        }

        function updateDashboard() {
            if (!rawData) return;

            const mode = document.getElementById('filterMode').value;
            const selBranch = document.getElementById('branchFilter').value;
            const selCity = document.getElementById('cityFilter').value;

            // Manager Filter Logic (Security)
            let selManager = document.getElementById('managerFilter').value;

            if (currentUser.role !== 'Admin') {
                // Enforce current user as manager
                selManager = currentUser.name;
            }

            const selType = document.getElementById('typeFilter').value;

            let currentStart, currentEnd;
            let prevStart, prevEnd;

            // 1. Determine Date Ranges
            if (mode === 'custom') {
                // Custom Range
                let s = document.getElementById('startDate').value;
                let e = document.getElementById('endDate').value;
                if (!s || !e) return; // Alert user?

                currentStart = new Date(s);
                currentEnd = new Date(e);

                // Prev: Same dates, 1 year ago
                prevStart = new Date(currentStart);
                prevStart.setFullYear(prevStart.getFullYear() - 1);

                prevEnd = new Date(currentEnd);
                prevEnd.setFullYear(prevEnd.getFullYear() - 1);

            } else if (mode === 'ramadan') {
                // Ramadan Logic
                const selYear = parseInt(document.getElementById('yearFilter').value);
                const rDates = rawData.metadata.ramadan_dates || [];

                // Find Current Ramadan
                const currR = rDates.find(r => r.year === selYear);
                const prevR = rDates.find(r => r.year === selYear - 1);

                if (currR) {
                    currentStart = new Date(currR.start);
                    currentEnd = new Date(currR.end);
                } else {
                    currentStart = new Date(selYear, 0, 1);
                    currentEnd = new Date(selYear, 0, 1);
                }

                if (prevR) {
                    prevStart = new Date(prevR.start);
                    prevEnd = new Date(prevR.end);
                } else {
                    prevStart = new Date(currentStart);
                    prevStart.setFullYear(prevStart.getFullYear() - 1);
                    prevEnd = new Date(currentEnd);
                    prevEnd.setFullYear(prevEnd.getFullYear() - 1);
                }
            } else {
                // Standard (Year/Month)
                const selYear = parseInt(document.getElementById('yearFilter').value);
                const selMonth = document.getElementById('monthFilter').value;

                // Current Range
                currentStart = new Date(selYear, 0, 1); // Jan 1

                if (selMonth === 'all') {
                    // YTD Logic: If viewing current year (2026), limit to Today
                    let now = new Date();
                    if (selYear === 2026) { // Hardcoded "Current Year" awareness or dynamic
                        // Use "today" as end date for fair comparison
                        currentEnd = now;
                    } else {
                        currentEnd = new Date(selYear, 11, 31); // Dec 31
                    }
                } else {
                    currentStart = new Date(selYear, selMonth - 1, 1);
                    // End of Month
                    currentEnd = new Date(selYear, selMonth, 0);
                    // Cap at today if future
                    let now = new Date();
                    if (currentEnd > now) currentEnd = now;
                }

                // Previous Range (Fair Comparison)
                prevStart = new Date(currentStart);
                prevStart.setFullYear(prevStart.getFullYear() - 1);

                prevEnd = new Date(currentEnd);
                prevEnd.setFullYear(prevEnd.getFullYear() - 1);



            }

            // Debug Dates
            // console.log("Curr", currentStart, currentEnd);
            // console.log("Prev", prevStart, prevEnd);

            // Update Titles
            document.getElementById('currYearTitle').textContent = `(${toYMD(currentStart)} - ${toYMD(currentEnd)})`;
            document.getElementById('prevYearTitle').textContent = `(${toYMD(prevStart)} - ${toYMD(prevEnd)})`;

            // --- 2. Aggregation Function ---
            const calcStats = (start, end) => {
                let sales = 0, trans = 0, visitors = 0, target = 0;
                let monthly = {};
                let branchSales = {};
                let branchTrans = {};
                let branchVisitors = {};
                let branchTarget = {};

                // Convert to comparable value
                let sTime = start.getTime();
                let eTime = end.getTime();

                const filterFn = (dStr, sId) => {
                    // Branch Filter
                    if (selBranch !== 'all' && sId !== selBranch) return false;

                    // City & Manager & Type Filter
                    if (rawData.store_meta && rawData.store_meta[sId]) {
                        let meta = rawData.store_meta[sId];
                        if (selCity !== 'all' && meta.city !== selCity) return false;
                        if (selManager !== 'all' && meta.manager !== selManager) return false;
                        if (selType !== 'all' && meta.type !== selType) return false;
                    } else {
                        // Logic for missing metadata (fallback)
                        if (selCity !== 'all') return false;
                        if (selManager !== 'all') return false;

                        // Default assumption if meta missing? exclude from both specifics
                        if (selType !== 'all') return false;
                    }

                    // Date Filter
                    let dTime = new Date(dStr).getTime();
                    return dTime >= sTime && dTime <= eTime;
                };

                // Sales
                rawData.sales.forEach(([d, s, v]) => {
                    if (filterFn(d, s)) {
                        sales += v;
                        let m = new Date(d).getMonth() + 1;
                        monthly[m] = (monthly[m] || 0) + v;
                        branchSales[s] = (branchSales[s] || 0) + v;
                    }
                });
                // Targets
                rawData.targets.forEach(([d, s, v]) => {
                    if (filterFn(d, s)) {
                        target += v;
                        branchTarget[s] = (branchTarget[s] || 0) + v;
                    }
                });
                // Visitors
                rawData.visitors.forEach(([d, s, v]) => {
                    if (filterFn(d, s)) {
                        visitors += v;
                        branchVisitors[s] = (branchVisitors[s] || 0) + v;
                    }
                });
                // Trans
                rawData.transactions.forEach(([d, s, v]) => {
                    if (filterFn(d, s)) {
                        trans += v;
                        branchTrans[s] = (branchTrans[s] || 0) + v;
                    }
                });

                return { sales, trans, visitors, target, monthly, branchSales, branchTrans, branchVisitors, branchTarget };
            };

            const curr = calcStats(currentStart, currentEnd);
            const prev = calcStats(prevStart, prevEnd);

            // --- 3. Update KPI Cards (Current) ---
            fmt(document.getElementById('totalSales'), curr.sales);
            fmt(document.getElementById('totalTrans'), curr.trans);
            fmt(document.getElementById('totalVisitors'), curr.visitors);
            fmt(document.getElementById('targetVal'), curr.target);

            // Growth
            let growth = prev.sales > 0 ? ((curr.sales - prev.sales) / prev.sales) * 100 : 0;
            let gEl = document.getElementById('salesGrowthVal');
            gEl.textContent = (growth > 0 ? '+' : '') + growth.toFixed(1) + '%';
            gEl.className = growth >= 0 ? 'text-success-custom fw-bold' : 'text-danger-custom fw-bold';

            // Rates
            let avgTicket = curr.trans > 0 ? curr.sales / curr.trans : 0;
            document.getElementById('avgTicket').textContent = avgTicket.toFixed(0);

            let convRate = curr.visitors > 0 ? (curr.trans / curr.visitors) * 100 : 0;
            document.getElementById('convRate').textContent = convRate.toFixed(1) + '%';

            // Target Pct
            let targetPct = curr.target > 0 ? (curr.sales / curr.target) * 100 : 0;
            document.getElementById('targetPct').textContent = targetPct.toFixed(1) + '%';
            renderMiniGauge('miniGauge', targetPct);

            // Cust Value
            let custValue = curr.visitors > 0 ? curr.sales / curr.visitors : 0;
            document.getElementById('totalCustValue').textContent = custValue.toFixed(0);

            // --- 4. Update KPI Cards (Previous) ---
            fmt(document.getElementById('prevSales'), prev.sales);
            fmt(document.getElementById('prevTrans'), prev.trans);
            fmt(document.getElementById('prevVisitors'), prev.visitors);

            // Prev Rates
            let prevAvgTicket = prev.trans > 0 ? prev.sales / prev.trans : 0;
            document.getElementById('prevAvgTicket').textContent = prevAvgTicket.toFixed(0);

            let prevConvRate = prev.visitors > 0 ? (prev.trans / prev.visitors) * 100 : 0;
            document.getElementById('prevConvRate').textContent = prevConvRate.toFixed(1) + '%';

            // Absolute Growth
            let absGrowth = curr.sales - prev.sales;
            let absGEl = document.getElementById('growthAbs');
            absGEl.textContent = valFmt(absGrowth);
            absGEl.className = absGrowth >= 0 ? 'fw-bold fs-4 text-success' : 'fw-bold fs-4 text-danger';

            // --- 4. Trend Chart ---
            // Extract Year for Chart Labels from starts
            let cYear = currentStart.getFullYear();
            let pYear = prevStart.getFullYear();
            renderTrendChart(curr.monthly, prev.monthly, cYear, pYear);

            // --- 5. Top 10 Chart & Table ---
            // Prepare Branch Data
            let branchList = [];
            let allStores = new Set([
                ...Object.keys(curr.branchSales), ...Object.keys(prev.branchSales),
                ...Object.keys(curr.branchTarget), ...Object.keys(curr.branchTrans), ...Object.keys(curr.branchVisitors)
            ]);

            // Calculate Remaining Days
            const nowForReq = new Date();
            const lastDayOfMonth = new Date(nowForReq.getFullYear(), nowForReq.getMonth() + 1, 0).getDate();
            let remainingDays = lastDayOfMonth - nowForReq.getDate() + 1;
            if (remainingDays < 1) remainingDays = 1;

            allStores.forEach(sid => {
                let name = rawData.stores[sid] || sid;

                // Metrics
                let val = curr.branchSales[sid] || 0;
                let prevVal = prev.branchSales[sid] || 0;
                let target = curr.branchTarget[sid] || 0;
                let trans = curr.branchTrans[sid] || 0;
                let visitors = curr.branchVisitors[sid] || 0;
                let prevVisitors = prev.branchVisitors[sid] || 0;

                // Calcs
                let growth = prevVal > 0 ? ((val - prevVal) / prevVal) * 100 : 0;
                let ach = target > 0 ? (val / target) * 100 : 0;
                let avgInv = trans > 0 ? val / trans : 0;
                let conv = visitors > 0 ? (trans / visitors) * 100 : 0;
                let custVal = visitors > 0 ? val / visitors : 0;

                // Daily Required Calculation
                let dailyReq = 0;
                if (target > val) {
                    dailyReq = (target - val) / remainingDays;
                }

                // Save to Global Map for Daily Report usage
                globalDailyReq[sid] = dailyReq;

                // New Metrics
                let absGrowth = val - prevVal;

                branchList.push({
                    name, val, prevVal, growth, absGrowth, target, trans, visitors, prevVisitors, ach, avgInv, conv, custVal, dailyReq
                });
            });

            // Sort Logic
            branchList.sort((a, b) => {
                let valA = a[currentSort.col];
                let valB = b[currentSort.col];

                // Handle strings (names) although mostly numbers
                if (typeof valA === 'string') valA = valA.toLowerCase();
                if (typeof valB === 'string') valB = valB.toLowerCase();

                if (valA < valB) return currentSort.asc ? -1 : 1;
                if (valA > valB) return currentSort.asc ? 1 : -1;
                return 0;
            });

            // Render Top 10 Chart
            renderTop10(branchList.slice(0, 10));

            // Render Table
            const tbody = document.getElementById('detailsTableBody');
            tbody.innerHTML = '';

            branchList.forEach((b, i) => {
                let tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="text-center"><span class="rank-badge">${i + 1}</span></td>
                    <td class="fw-bold fs-6">${b.name}</td>
                    <td class="text-center">${b.val.toLocaleString()}</td>
                    <td class="text-center text-muted">${b.prevVal.toLocaleString()}</td>
                    <td class="text-center">${b.target.toLocaleString()}</td>
                    <td class="text-center ${b.ach >= 100 ? 'text-success' : 'text-warning'} fw-bold">${b.ach.toFixed(1)}%</td>
                    <td class="text-center ${b.growth >= 0 ? 'text-success' : 'text-danger'} fw-bold" dir="ltr">${b.growth.toFixed(1)}%</td>
                    <td class="text-center ${b.absGrowth >= 0 ? 'text-success' : 'text-danger'} fw-bold" dir="ltr">${b.absGrowth.toLocaleString()}</td>
                    <td class="text-center fw-bold text-danger">${(b.dailyReq || 0).toLocaleString(undefined, { maximumFractionDigits: 0 })}</td>
                    <td class="text-center">${b.trans.toLocaleString()}</td>
                    <td class="text-center">${b.avgInv.toFixed(0)}</td>
                    <td class="text-center">${b.visitors.toLocaleString()}</td>
                    <td class="text-center text-muted">${b.prevVisitors.toLocaleString()}</td>
                    <td class="text-center fw-bold">${b.custVal.toFixed(0)}</td>
                    <td class="text-center">${b.conv.toFixed(1)}%</td>
                `;
                tbody.appendChild(tr);
            });

            // --- 6. Render Daily Report ---
            renderDailyReport();

            // --- 7. Advanced Analysis ---
            updateAdvancedAnalysis(curr, prev, branchList);
        }

        // Global Data for Daily Report
        let globalDailyReq = {};

        // Global Data for Daily Report
        // let globalDailyReq = {}; // Already defined above? No, ensuring it's global.
        // Actually line 1099 has it.

        function renderDailyReport() {
            if (!rawData) return;
            // Removed incorrect updateDashboard logic from here

            let today = new Date();
            let yesterday = new Date(today);
            yesterday.setDate(today.getDate() - 1);

            let lastYear = new Date(yesterday);
            lastYear.setFullYear(yesterday.getFullYear() - 1);

            // Format YYYY-MM-DD
            const fmtDate = (d) => {
                let year = d.getFullYear();
                let month = (d.getMonth() + 1).toString().padStart(2, '0');
                let day = d.getDate().toString().padStart(2, '0');
                return `${year}-${month}-${day}`;
            };
            const dateYest = fmtDate(yesterday);
            const dateLastY = fmtDate(lastYear);

            // UI Label
            const dayNames = ["Ø§Ù„Ø£Ø­Ø¯", "Ø§Ù„Ø§Ø«Ù†ÙŠÙ†", "Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡", "Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡", "Ø§Ù„Ø®Ù…ÙŠØ³", "Ø§Ù„Ø¬Ù…Ø¹Ø©", "Ø§Ù„Ø³Ø¨Øª"];
            document.getElementById('dailyReportTitle').textContent = `ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø£Ù…Ø³ (${dayNames[yesterday.getDay()]} ${dateYest}) Ù…Ù‚Ø§Ø±Ù†Ø© Ø¨Ù€ (${dateLastY})`;

            // 2. Aggregate Data
            let stats = {}; // StoreID -> { salesY, salesLY, transY, visitY }

            // Manager Filter Logic (Same as Dashboard)
            let selManager = document.getElementById('managerFilter').value;
            if (currentUser.role !== 'Admin') {
                selManager = currentUser.name;
            }

            // Initialize all stores
            Object.keys(rawData.stores).forEach(sid => {
                if (sid !== '0' && sid !== '9999') { // Skip Warehouse/Unknown if desired
                    // Check Manager Filter
                    if (selManager !== 'all') {
                        let meta = rawData.store_meta ? rawData.store_meta[sid] : null;
                        if (!meta || meta.manager !== selManager) return;
                    }

                    stats[sid] = { salesY: 0, salesLY: 0, transY: 0, visitY: 0, visitLY: 0 };
                }
            });

            // Sales
            rawData.sales.forEach(([d, s, v]) => {
                if (!stats[s]) return;
                if (d === dateYest) stats[s].salesY += v;
                if (d === dateLastY) stats[s].salesLY += v;
            });
            // Trans
            rawData.transactions.forEach(([d, s, v]) => {
                if (!stats[s]) return;
                if (d === dateYest) stats[s].transY += v;
            });
            // Visitors
            rawData.visitors.forEach(([d, s, v]) => {
                if (!stats[s]) return;
                if (d === dateYest) stats[s].visitY += v;
                if (d === dateLastY) stats[s].visitLY += v;
            });

            // 3. Convert to Array and Sort
            let dailyList = [];
            Object.keys(stats).forEach(sid => {
                let d = stats[sid];
                if (d.salesY === 0 && d.salesLY === 0 && d.transY === 0) return;

                let name = rawData.stores[sid] || sid;
                let growth = d.salesLY > 0 ? ((d.salesY - d.salesLY) / d.salesLY) * 100 : 0;
                if (d.salesLY === 0 && d.salesY > 0) growth = 100;

                let avgInv = d.transY > 0 ? d.salesY / d.transY : 0;
                let conv = d.visitY > 0 ? (d.transY / d.visitY) * 100 : 0;
                let dailyReq = globalDailyReq[sid] || 0;

                dailyList.push({ sid, name, ...d, growth, avgInv, conv, dailyReq });
            });

            // Sort Daily List
            dailyList.sort((a, b) => {
                let valA = a[dailySort.col];
                let valB = b[dailySort.col];
                // Handle strings (names) although mostly numbers
                if (typeof valA === 'string') valA = valA.toLowerCase();
                if (typeof valB === 'string') valB = valB.toLowerCase();

                if (valA < valB) return dailySort.asc ? -1 : 1;
                if (valA > valB) return dailySort.asc ? 1 : -1;
                return 0;
            });

            // 4. Render Table
            const tbody = document.getElementById('dailyTableBody');
            tbody.innerHTML = '';

            dailyList.forEach((r, i) => {
                let tr = document.createElement('tr');
                let dReq = globalDailyReq[r.sid] || 0;

                tr.innerHTML = `
                    <td>${i + 1}</td>
                    <td class="fw-bold fs-6">
                        <a href="branch_details.html?sid=${r.sid}&name=${encodeURIComponent(r.name)}" target="_blank" class="text-decoration-none text-dark hover-primary">${r.name}</a>
                    </td>
                    <td class="fw-bold">${r.salesY.toLocaleString()}</td>
                    <td class="text-secondary">${r.salesLY.toLocaleString()}</td>
                    <td class="${r.growth >= 0 ? 'text-success' : 'text-danger'} fw-bold" dir="ltr">${r.growth > 0 ? '+' : ''}${r.growth.toFixed(1)}%</td>
                    <td class="fw-bold text-danger">${dReq.toLocaleString(undefined, { maximumFractionDigits: 0 })}</td>
                    <td>${r.transY.toLocaleString()}</td>
                    <td>${r.avgInv.toFixed(0)}</td>
                    <td>${r.visitY.toLocaleString()}</td>
                    <td class="text-secondary">${r.visitLY.toLocaleString()}</td>
                    <td>${r.conv.toFixed(1)}%</td>
                `;
                tbody.appendChild(tr);
            });
        }



        // --- Helpers ---
        function fmt(el, v) { el.textContent = v.toLocaleString(undefined, { maximumFractionDigits: 0 }); }
        function valFmt(v) { return v.toLocaleString(undefined, { maximumFractionDigits: 0 }); } // Explicit helper if needed

        function renderMiniGauge(id, pct) {
            const ctx = document.getElementById(id).getContext('2d');
            if (charts[id]) charts[id].destroy();
            charts[id] = new Chart(ctx, {
                type: 'doughnut',
                data: { datasets: [{ data: [pct, Math.max(0, 100 - pct)], backgroundColor: ['#fe7900', '#eee'], borderWidth: 0 }] },
                options: { cutout: '70%', events: [] }
            });
        }

        function renderTrendChart(currM, prevM, y1, y2) {
            const ctx = document.getElementById('trendChart').getContext('2d');
            if (charts['trend']) charts['trend'].destroy();

            const selectedM = document.getElementById('monthFilter').value;

            const labels = Array.from({ length: 12 }, (_, i) => i + 1);
            charts['trend'] = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels,
                    datasets: [
                        {
                            label: y1,
                            data: labels.map(m => currM[m] || 0),
                            // Selected: Dark Brand (#cc6100), Unselected: Faded (#ffd8a8), All: Brand (#fe7900)
                            backgroundColor: (ctx) => {
                                if (selectedM === 'all') return '#fe7900';
                                return (ctx.dataIndex + 1) == selectedM ? '#cc6100' : '#ffd8a8';
                            },
                            borderRadius: 4
                        },
                        { label: y2, data: labels.map(m => prevM[m] || 0), backgroundColor: '#e9ecef', borderRadius: 4 }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: { x: { grid: { display: false } }, y: { grid: { borderDash: [5, 5] } } },
                    plugins: { legend: { position: 'top' } },
                    onClick: (e, activeEls, chart) => {
                        const points = chart.getElementsAtEventForMode(e, 'nearest', { intersect: true }, true);
                        if (points.length) {
                            const index = points[0].index;
                            const month = index + 1;

                            const mFilter = document.getElementById('monthFilter');
                            const modeSelect = document.getElementById('filterMode');

                            // Ensure we switch to Standard mode if currently Custom (logic edge case)
                            // But usually chart is visible in both. Best to just set month filter.
                            if (modeSelect.value === 'custom') {
                                modeSelect.value = 'standard';
                                toggleFilterMode();
                            }

                            if (mFilter.value == month) {
                                mFilter.value = 'all';
                            } else {
                                mFilter.value = month;
                            }
                            updateDashboard();
                        }
                    },
                    onHover: (event, chartElement) => {
                        event.native.target.style.cursor = chartElement.length ? 'pointer' : 'default';
                    }
                }
            });
        }

        function renderTop10(data) {
            const ctx = document.getElementById('top10Chart').getContext('2d');
            if (charts['top10']) charts['top10'].destroy();

            charts['top10'] = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.map(d => d.name),
                    datasets: [{
                        label: 'Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª',
                        data: data.map(d => d.val),
                        backgroundColor: '#198754',
                        borderRadius: 4,
                        barThickness: 20
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true, maintainAspectRatio: false,
                    scales: { x: { display: false }, y: { grid: { display: false } } },
                    plugins: { legend: { display: false } }
                }
            });
        }

        // --- NEW: Advanced Analysis Function ---
        function updateAdvancedAnalysis(curr, prev, branchList) {

            // 1. Growth Contribution
            // Total Growth (Absolute)
            const totalGrowth = curr.sales - prev.sales;
            const isPositiveGrowth = totalGrowth >= 0;

            // Sort by Absolute Growth (High to Low)
            // We want to see who Added the most value, and who Removed the most.
            let sortedByGrowth = [...branchList].sort((a, b) => b.absGrowth - a.absGrowth);

            const growthBody = document.getElementById('growthContribBody');
            growthBody.innerHTML = '';

            // Take Top 3 Positive contributors and Top 3 Negative contributors
            // Or just top 5 contributors to the change?
            // Let's show Top 3 Gainers and Bottom 3 Losers if exist
            let gainers = sortedByGrowth.filter(b => b.absGrowth > 0);
            let losers = sortedByGrowth.filter(b => b.absGrowth < 0);

            // Render Helper
            const renderGrowthRow = (b) => {
                let contrib = totalGrowth !== 0 ? (b.absGrowth / Math.abs(totalGrowth)) * 100 : 0;
                // If company declined, positive branch held it up? 

                return `
                    <tr>
                        <td class="fw-bold" style="font-size: 0.85rem">${b.name}</td>
                        <td class="${b.absGrowth >= 0 ? 'text-success' : 'text-danger'} text-end" dir="ltr" style="font-size: 0.85rem">
                            ${b.absGrowth > 0 ? '+' : ''}${valFmt(b.absGrowth)}
                        </td>
                        <td class="text-end text-muted" style="font-size: 0.8rem">
                             ${b.growth.toFixed(1)}%
                        </td>
                    </tr>
                `;
            };

            // Header for Positive
            let rows = [];

            // Add top 3 gainers
            gainers.slice(0, 3).forEach(b => rows.push(renderGrowthRow(b)));

            // Divider if needed, or just list them. 
            // If we have losers, show them too.
            if (losers.length > 0) {
                // Sort losers ascending (most negative first)
                losers.sort((a, b) => a.absGrowth - b.absGrowth);
                losers.slice(0, 3).forEach(b => rows.push(renderGrowthRow(b)));
            }

            // Fallback if empty
            if (rows.length === 0) {
                growthBody.innerHTML = '<tr><td colspan="3" class="text-center text-muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</td></tr>';
            } else {
                growthBody.innerHTML = rows.join('');
            }


            // 2. Target Gap
            const gapList = document.getElementById('targetGapList');
            gapList.innerHTML = '';

            // Filter stores that missed target
            let missed = branchList.filter(b => b.target > 0 && b.val < b.target);
            // Sort by Gap Amount (Desc) - Biggest opportunity first
            missed.sort((a, b) => (b.target - b.val) - (a.target - a.val));

            if (missed.length === 0) {
                gapList.innerHTML = '<li class="list-group-item text-center text-muted">Ø§Ù„Ø¬Ù…ÙŠØ¹ Ø­Ù‚Ù‚ Ø§Ù„Ù‡Ø¯Ù! ğŸ‰</li>';
            } else {
                missed.slice(0, 10).forEach(b => {
                    let gap = b.target - b.val;
                    let pct = (b.val / b.target) * 100;

                    let item = document.createElement('li');
                    item.className = 'list-group-item d-flex justify-content-between align-items-center px-0 py-2';
                    item.setAttribute('data-bs-toggle', 'tooltip');
                    item.setAttribute('data-bs-placement', 'left');
                    item.setAttribute('title', `Ø§Ù„Ù‡Ø¯Ù: ${valFmt(b.target)} | Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª: ${valFmt(b.val)} | Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: ${valFmt(gap)}`);

                    item.innerHTML = `
                        <div class="ms-2 me-auto">
                            <div class="fw-bold" style="font-size: 0.9rem">${b.name}</div>
                            <div class="text-muted" style="font-size: 0.75rem">Ø­Ù‚Ù‚ ${pct.toFixed(1)}%</div>
                        </div>
                        <div class="text-end">
                            <span class="badge bg-danger rounded-pill mb-1">${valFmt(gap)}</span>
                            <div class="progress text-end" style="height: 4px; width: 60px; margin-left: auto;">
                                <div class="progress-bar bg-danger" role="progressbar" style="width: ${pct}%"></div>
                            </div>
                        </div>
                    `;
                    gapList.appendChild(item);
                });
            }

            // 3. Early Warning
            const warningBody = document.getElementById('earlyWarningBody');
            warningBody.innerHTML = '';

            let withTarget = branchList.filter(b => b.target > 0);
            withTarget.sort((a, b) => a.ach - b.ach);

            // Show Top 10 at Risk
            withTarget.slice(0, 10).forEach(b => {
                let riskClass = 'risk-low';
                let riskLabel = 'Ø·Ù…Ø¦Ù†';

                if (b.ach < 50) { riskClass = 'risk-high'; riskLabel = 'Ø­Ø±Ø¬'; }
                else if (b.ach < 85) { riskClass = 'risk-med'; riskLabel = 'Ù…ØªÙˆØ³Ø·'; }

                let tr = document.createElement('tr');
                let riskTip = `ØªØ­Ù‚ÙŠÙ‚: ${b.ach.toFixed(1)}% | Ø§Ù„Ù…Ø¹Ø¯Ù„ Ø§Ù„Ø·Ø¨ÙŠØ¹ÙŠ Ø§Ù„Ù…ØªÙˆÙ‚Ø¹: >${(new Date().getDate() / 30 * 100).toFixed(0)}%`;

                tr.innerHTML = `
                    <td class="fw-bold" data-bs-toggle="tooltip" title="${riskTip}">${b.name}</td>
                    <td class="text-center">
                        <span style="font-size:0.9rem">${b.ach.toFixed(1)}%</span>
                        <div class="progress-micro">
                            <div class="progress-bar ${b.ach < 50 ? 'bg-danger' : 'bg-warning'}" style="width: ${b.ach}%"></div>
                        </div>
                    </td>
                    <td class="text-center">
                        <span class="badge ${riskClass === 'risk-high' ? 'bg-danger' : (riskClass === 'risk-med' ? 'bg-warning text-dark' : 'bg-success')}">${riskLabel}</span>
                    </td>
                `;
                warningBody.appendChild(tr);
            });

            // Re-init tooltips
            var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });
        }

        init();
    </script>
</body>

</html>