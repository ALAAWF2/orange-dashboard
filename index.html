<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Orange | Executive Dashboard</title>

    <!-- Bootstrap 5 RTL -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">

    <style>
        :root {
            --bs-primary: #fe7900;
            /* Orange Brand */
            --bs-secondary: #6c757d;
            --bg-light: #f8f9fa;
            --card-radius: 12px;
            --font-main: 'Tajawal', sans-serif;
        }

        body {
            font-family: var(--font-main);
            background-color: var(--bg-light);
            color: #212529;
        }

        /* Navbar */
        .navbar {
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            background: white !important;
        }

        .navbar-brand {
            font-weight: 800;
            color: #000 !important;
        }

        .brand-orange {
            color: #fe7900;
        }

        /* KPI Cards */
        .kpi-card {
            background: white;
            border: none;
            border-radius: var(--card-radius);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.03);
            transition: transform 0.2s;
            padding: 20px;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .kpi-card:hover {
            transform: translateY(-3px);
        }

        .kpi-title {
            font-size: 0.9rem;
            color: #6c757d;
            font-weight: 500;
            margin-bottom: 8px;
        }

        .kpi-value {
            font-size: 1.8rem;
            font-weight: 800;
            color: #000;
        }

        .kpi-sub {
            font-size: 0.8rem;
            margin-top: 5px;
        }

        .text-success-custom {
            color: #198754;
        }

        .text-danger-custom {
            color: #dc3545;
        }

        /* Sections */
        .section-title {
            font-weight: 700;
            margin-bottom: 20px;
            border-right: 4px solid #fe7900;
            padding-right: 10px;
        }

        /* Charts */
        .chart-container {
            background: white;
            padding: 20px;
            border-radius: var(--card-radius);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.03);
            margin-bottom: 20px;
            min-height: 350px;
        }

        /* Table */
        .table-custom thead th {
            background-color: #fe7900;
            color: white;
            font-weight: 500;
            border: none;
        }

        .table-custom tbody tr:hover {
            background-color: #fff3e0;
        }

        .rank-badge {
            background: #fe7900;
            color: white;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
        }
    </style>
</head>

<body>

    <!-- Top Bar -->
    <nav class="navbar mb-4 sticky-top">
        <div class="container-fluid">
            <span class="navbar-brand"><span class="brand-orange">ORANGE</span> DASHBOARD</span>

            <!-- Filters Removed (Moved to Main Body) -->
            <span class="badge bg-light text-dark border d-flex align-items-center" id="lastUpdate">...</span>
        </div>
    </nav>

    <div class="container-fluid px-4">

        <!-- Advanced Filter Bar -->
        <div class="card border-0 shadow-sm p-3 mb-4">
            <div class="row align-items-center g-3">

                <!-- Filter Mode -->
                <div class="col-md-auto">
                    <label class="form-label small text-muted fw-bold">Ù†ÙˆØ¹ Ø§Ù„ØªÙ‚Ø±ÙŠØ±</label>
                    <select id="filterMode" class="form-select form-select-sm" onchange="toggleFilterMode()">
                        <option value="standard">Ø³Ù†ÙˆÙŠ / Ø´Ù‡Ø±ÙŠ</option>
                        <option value="custom">ÙØªØ±Ø© Ù…Ø®ØµØµØ© (Custom Range)</option>
                    </select>
                </div>

                <!-- Standard Filters (Year/Month) -->
                <div id="stdFilters" class="col-md-auto d-flex gap-2">
                    <div>
                        <label class="form-label small text-muted fw-bold">Ø§Ù„Ø³Ù†Ø©</label>
                        <select id="yearFilter" class="form-select form-select-sm" onchange="updateDashboard()">
                            <option value="2026" selected>2026</option>
                            <option value="2025">2025</option>
                            <option value="2024">2024</option>
                        </select>
                    </div>
                    <div>
                        <label class="form-label small text-muted fw-bold">Ø§Ù„Ø´Ù‡Ø±</label>
                        <select id="monthFilter" class="form-select form-select-sm" onchange="updateDashboard()">
                            <option value="all">ÙƒÙ„ Ø§Ù„Ø³Ù†Ø©</option>
                            <!-- JS Populated -->
                        </select>
                    </div>
                </div>

                <!-- Custom Filters (Date Range) -->
                <div id="customFilters" class="col-md-auto gap-2" style="display: none;">
                    <div>
                        <label class="form-label small text-muted fw-bold">Ù…Ù† ØªØ§Ø±ÙŠØ®</label>
                        <input type="date" id="startDate" class="form-control form-control-sm">
                    </div>
                    <div>
                        <label class="form-label small text-muted fw-bold">Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®</label>
                        <input type="date" id="endDate" class="form-control form-control-sm">
                    </div>
                </div>

                <!-- Manager Filter -->
                <div class="col-md">
                    <label class="form-label small text-muted fw-bold">Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ù†Ø·Ù‚Ø© (Manager)</label>
                    <select id="managerFilter" class="form-select form-select-sm" onchange="updateDashboard()">
                        <option value="all">Ø§Ù„ÙƒÙ„</option>
                    </select>
                </div>

                <!-- City Filter -->
                <div class="col-md">
                    <label class="form-label small text-muted fw-bold">Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© (City)</label>
                    <select id="cityFilter" class="form-select form-select-sm" onchange="updateDashboard()">
                        <option value="all">Ø§Ù„ÙƒÙ„</option>
                    </select>
                </div>

                <!-- Branch Filter -->
                <div class="col-md">
                    <label class="form-label small text-muted fw-bold">Ø§Ù„Ù…Ø¹Ø±Ø¶ / Ø§Ù„ÙØ±Ø¹</label>
                    <select id="branchFilter" class="form-select form-select-sm" onchange="updateDashboard()">
                        <option value="all">ÙƒØ§ÙØ© Ø§Ù„ÙØ±ÙˆØ¹</option>
                        <!-- JS Populated -->
                    </select>
                </div>

                <div class="col-md-auto align-self-end">
                    <button class="btn btn-primary btn-sm w-100 fw-bold" onclick="updateDashboard()">Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚Ø±ÙŠØ±
                        ğŸ”„</button>
                </div>
            </div>
        </div>

        <!-- Row 1: High Level KPIs (Current) -->
        <h6 class="text-muted fw-bold mb-2">Ø£Ø¯Ø§Ø¡ Ø§Ù„Ø¹Ø§Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ (<span id="currYearTitle">...</span>)</h6>
        <div class="row g-3 mb-3">
            <div class="col-md-3">
                <div class="kpi-card border-bottom border-4 border-warning">
                    <div class="kpi-title">Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª (Sales)</div>
                    <div class="kpi-value" id="totalSales">0</div>
                    <div class="kpi-sub">
                        <span id="salesGrowthVal">0%</span>
                        vs <span id="prevYearLabel">Prev Year</span>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="kpi-card border-bottom border-4 border-primary">
                    <div class="kpi-title">Ø§Ù„ÙÙˆØ§ØªÙŠØ± (Transactions)</div>
                    <div class="kpi-value" id="totalTrans">0</div>
                    <div class="kpi-sub text-muted">Avg Invoice: <span id="avgTicket" class="fw-bold">0</span></div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="kpi-card border-bottom border-4 border-info">
                    <div class="kpi-title">Ø§Ù„Ø²ÙˆØ§Ø± (Visitors)</div>
                    <div class="kpi-value" id="totalVisitors">0</div>
                    <div class="kpi-sub text-muted">Conv. Rate: <span id="convRate" class="fw-bold">0%</span></div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="kpi-card border-bottom border-4 border-success">
                    <div class="kpi-title">ØªØ­Ù‚ÙŠÙ‚ Ø§Ù„Ù‡Ø¯Ù (Target)</div>
                    <div class="d-flex align-items-center justify-content-between">
                        <span class="kpi-value" id="targetPct">0%</span>
                        <div style="width: 50px; height: 50px;">
                            <canvas id="miniGauge"></canvas>
                        </div>
                    </div>
                    <div class="kpi-sub text-muted">Target: <span id="targetVal">0</span></div>
                </div>
            </div>
        </div>

        <!-- Row 2: Previous Year KPIs -->
        <h6 class="text-muted fw-bold mb-2">Ø£Ø¯Ø§Ø¡ Ø§Ù„Ø¹Ø§Ù… Ø§Ù„Ø³Ø§Ø¨Ù‚ (<span id="prevYearTitle">...</span>)</h6>
        <div class="row g-3 mb-4">
            <div class="col-md-3">
                <div class="kpi-card bg-light">
                    <div class="kpi-title text-muted">Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„Ø¹Ø§Ù… Ø§Ù„Ø³Ø§Ø¨Ù‚</div>
                    <div class="kpi-value text-secondary" id="prevSales" style="font-size: 1.5rem;">0</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="kpi-card bg-light">
                    <div class="kpi-title text-muted">ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ø¹Ø§Ù… Ø§Ù„Ø³Ø§Ø¨Ù‚</div>
                    <div class="kpi-value text-secondary" id="prevTrans" style="font-size: 1.5rem;">0</div>
                    <div class="kpi-sub text-muted">Avg Invoice: <span id="prevAvgTicket">0</span></div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="kpi-card bg-light">
                    <div class="kpi-title text-muted">Ø²ÙˆØ§Ø± Ø§Ù„Ø¹Ø§Ù… Ø§Ù„Ø³Ø§Ø¨Ù‚</div>
                    <div class="kpi-value text-secondary" id="prevVisitors" style="font-size: 1.5rem;">0</div>
                    <div class="kpi-sub text-muted">Conv. Rate: <span id="prevConvRate">0%</span></div>
                </div>
            </div>
            <!-- Growth Amount -->
            <div class="col-md-3">
                <div class="kpi-card bg-light d-flex align-items-center justify-content-center">
                    <div class="text-center">
                        <div class="kpi-title text-muted">Ù‚ÙŠÙ…Ø© Ø§Ù„Ù†Ù…Ùˆ (Growth Value)</div>
                        <div class="fw-bold fs-4" id="growthAbs">0</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Row 2.5: Daily Report (Accordion) -->
        <div class="accordion mb-4 text-center" id="dailyAccordion">
            <div class="accordion-item border-0 shadow-sm" style="border-radius: var(--card-radius); overflow: hidden;">
                <h2 class="accordion-header" id="headingDaily">
                    <button class="accordion-button collapsed fw-bold text-primary bg-white" type="button"
                        data-bs-toggle="collapse" data-bs-target="#collapseDaily" aria-expanded="false"
                        aria-controls="collapseDaily">
                        ğŸ“Š Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„ÙŠÙˆÙ…ÙŠ: &nbsp;<span id="dailyReportTitle" class="text-dark">Ø¬Ø§Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„...</span>
                    </button>
                </h2>
                <div id="collapseDaily" class="accordion-collapse collapse" aria-labelledby="headingDaily"
                    data-bs-parent="#dailyAccordion">
                    <div class="accordion-body p-0">
                        <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                            <!-- Daily Table -->
                            <table class="table table-striped table-hover mb-0 align-middle">
                                <thead class="table-light sticky-top" style="z-index: 1;">
                                    <tr>
                                        <th>#</th>
                                        <th>Ø§Ù„ÙØ±Ø¹</th>
                                        <th>Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„Ø£Ù…Ø³</th>
                                        <th class="text-muted" style="font-size: 0.9em;">Ø§Ù„Ø¹Ø§Ù… Ø§Ù„Ù…Ø§Ø¶ÙŠ</th>
                                        <th>Ø§Ù„Ù†Ù…Ùˆ %</th>
                                        <th>ÙÙˆØ§ØªÙŠØ±</th>
                                        <th>Ù…ØªÙˆØ³Ø· Ø§Ù„ÙØ§ØªÙˆØ±Ø© (Inv Rate)</th>
                                        <th>Ø²ÙˆØ§Ø±</th>
                                        <th>ØªØ­ÙˆÙŠÙ„ %</th>
                                    </tr>
                                </thead>
                                <tbody id="dailyTableBody">
                                    <!-- JS -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Row 3: Charts -->
        <div class="row">
            <!-- Monthly Trend -->
            <div class="col-md-8">
                <h5 class="section-title">Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø§Ù„Ø´Ù‡Ø±ÙŠ (Monthly Trend)</h5>
                <div class="chart-container">
                    <canvas id="trendChart"></canvas>
                </div>
            </div>
            <!-- Top 10 -->
            <div class="col-md-4">
                <h5 class="section-title">Ø£Ø¹Ù„Ù‰ 10 ÙØ±ÙˆØ¹ (Top 10)</h5>
                <div class="chart-container">
                    <canvas id="top10Chart"></canvas>
                </div>
            </div>
        </div>

        <!-- Row 3: Detailed Table -->
        <div class="row mt-4">
            <div class="col-12">
                <h5 class="section-title">ØªÙØ§ØµÙŠÙ„ Ø§Ù„ÙØ±ÙˆØ¹ (Detailed Report)</h5>
                <div class="card border-0 shadow-sm p-3">
                    <div class="table-responsive">
                        <table class="table table-custom align-middle">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Ø§Ù„ÙØ±Ø¹ (Branch)</th>
                                    <th>Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª (Sales)</th>
                                    <th>Ø§Ù„Ù‡Ø¯Ù (Target)</th>
                                    <th onclick="setSort('ach')" style="cursor: pointer; text-decoration: underline;">
                                        Ø§Ù„ØªØ­Ù‚ÙŠÙ‚ (%)
                                        â†•</th>
                                    <th>Ø§Ù„Ù†Ù…Ùˆ (Growth)</th>
                                    <th>Ø§Ù„ÙÙˆØ§ØªÙŠØ± (Trans)</th>
                                    <th>Ù…ØªÙˆØ³Ø· Ø§Ù„ÙØ§ØªÙˆØ±Ø© (Inv Rate)</th>
                                    <th>Ø§Ù„Ø²ÙˆØ§Ø± (Visitors)</th>
                                    <th>Ø§Ù„ØªØ­ÙˆÙŠÙ„ (Vis Rate)</th>
                                </tr>
                            </thead>
                            <tbody id="detailsTableBody">
                                <!-- JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Branch Details Modal -->
        <div class="modal fade" id="branchModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-xl">
                <div class="modal-content">
                    <div class="modal-header bg-light">
                        <h5 class="modal-title fw-bold" id="branchModalTitle">ØªÙØ§ØµÙŠÙ„ Ø§Ù„ÙØ±Ø¹</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div id="modalSpinner" class="text-center py-5">
                            <div class="spinner-border text-primary" role="status"></div>
                            <p class="mt-2 text-muted">Ø¬Ø§Ø± ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†...</p>
                        </div>

                        <div id="modalContent" style="display: none;">
                            <div class="row">
                                <!-- Left: Yesterday -->
                                <div class="col-lg-6 mb-3">
                                    <div class="card shadow-sm border-0 h-100">
                                        <div class="card-header bg-white fw-bold text-center border-bottom-0">
                                            ğŸ“… Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„Ø£Ù…Ø³ (<span id="modalDateYesterday"></span>)
                                        </div>
                                        <div class="table-responsive">
                                            <table class="table table-sm table-hover mb-0" style="font-size: 0.9rem;">
                                                <thead class="table-light">
                                                    <tr>
                                                        <th>Ø§Ù„Ù…ÙˆØ¸Ù</th>
                                                        <th>Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</th>
                                                        <th>Ù…Ø³Ø§Ù‡Ù…Ø© %</th>
                                                        <th>ÙÙˆØ§ØªÙŠØ±</th>
                                                        <th>Avg Inv</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="tbodyYest"></tbody>
                                                <tfoot id="tfootYest" class="fw-bold table-light"></tfoot>
                                            </table>
                                        </div>
                                    </div>
                                </div>

                                <!-- Right: Month to Date -->
                                <div class="col-lg-6 mb-3">
                                    <div class="card shadow-sm border-0 h-100">
                                        <div class="card-header bg-white fw-bold text-center border-bottom-0">
                                            ğŸ“… Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„Ø´Ù‡Ø± (<span id="modalDateMonth"></span>)
                                        </div>
                                        <div class="table-responsive">
                                            <table class="table table-sm table-hover mb-0" style="font-size: 0.9rem;">
                                                <thead class="table-light">
                                                    <tr>
                                                        <th>Ø§Ù„Ù…ÙˆØ¸Ù</th>
                                                        <th>Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</th>
                                                        <th>Ù…Ø³Ø§Ù‡Ù…Ø© %</th>
                                                        <th>ÙÙˆØ§ØªÙŠØ±</th>
                                                        <th>Avg Inv</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="tbodyMonth"></tbody>
                                                <tfoot id="tfootMonth" class="fw-bold table-light"></tfoot>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        let rawData = null;
        let charts = {};

        // Sorting State
        let currentSort = { col: 'val', asc: false }; // Default: Sales Desc

        function setSort(col) {
            if (currentSort.col === col) {
                currentSort.asc = !currentSort.asc;
            } else {
                currentSort.col = col;
                currentSort.asc = false; // Default desc for new col
            }
            updateDashboard();
        }

        async function init() {
            // Init Month Filter
            const months = ["ÙŠÙ†Ø§ÙŠØ±", "ÙØ¨Ø±Ø§ÙŠØ±", "Ù…Ø§Ø±Ø³", "Ø£Ø¨Ø±ÙŠÙ„", "Ù…Ø§ÙŠÙˆ", "ÙŠÙˆÙ†ÙŠÙˆ", "ÙŠÙˆÙ„ÙŠÙˆ", "Ø£ØºØ³Ø·Ø³", "Ø³Ø¨ØªÙ…Ø¨Ø±", "Ø£ÙƒØªÙˆØ¨Ø±", "Ù†ÙˆÙÙ…Ø¨Ø±", "Ø¯ÙŠØ³Ù…Ø¨Ø±"];
            const mSelect = document.getElementById('monthFilter');
            months.forEach((m, i) => {
                let opt = document.createElement('option');
                opt.value = i + 1;
                opt.textContent = m;
                mSelect.appendChild(opt);
            });

            try {
                const res = await fetch('management_data.json?t=' + Date.now());
                rawData = await res.json();
                document.getElementById('lastUpdate').textContent = rawData.metadata.generated_at.split(' ')[0];

                // Populate Branch Filter
                const bSelect = document.getElementById('branchFilter');
                // Use a Set to handle potential duplicates or just object keys
                const storeIds = Object.keys(rawData.stores);
                // Sort by Name
                storeIds.sort((a, b) => (rawData.stores[a] || '').localeCompare(rawData.stores[b] || ''));

                storeIds.forEach(sid => {
                    let opt = document.createElement('option');
                    opt.value = sid;
                    opt.textContent = rawData.stores[sid] || sid;
                    bSelect.appendChild(opt);
                });

                // Set Dates Default for Custom Range (Today)
                let today = new Date().toISOString().split('T')[0];
                document.getElementById('endDate').value = today;
                // Start date: Start of this month
                let firstDay = new Date();
                firstDay.setDate(1);
                document.getElementById('startDate').value = firstDay.toISOString().split('T')[0];

                updateDashboard();
            } catch (e) { console.error(e); }
        }

        // Toggle UI
        function toggleFilterMode() {
            const mode = document.getElementById('filterMode').value;
            const std = document.getElementById('stdFilters');
            const cust = document.getElementById('customFilters');

            if (mode === 'custom') {
                std.style.display = 'none';
                cust.style.display = 'flex';
            } else {
                std.style.display = 'flex';
                cust.style.display = 'none';
            }
        }

        // Helper: Format Date YYYY-MM-DD
        const toYMD = (d) => d.toISOString().split('T')[0];

        function updateDashboard() {
            if (!rawData) return;

            const mode = document.getElementById('filterMode').value;
            const selBranch = document.getElementById('branchFilter').value;

            let currentStart, currentEnd;
            let prevStart, prevEnd;

            // 1. Determine Date Ranges
            if (mode === 'custom') {
                // Custom Range
                let s = document.getElementById('startDate').value;
                let e = document.getElementById('endDate').value;
                if (!s || !e) return; // Alert user?

                currentStart = new Date(s);
                currentEnd = new Date(e);

                // Prev: Same dates, 1 year ago
                prevStart = new Date(currentStart);
                prevStart.setFullYear(prevStart.getFullYear() - 1);

                prevEnd = new Date(currentEnd);
                prevEnd.setFullYear(prevEnd.getFullYear() - 1);

            } else {
                // Standard (Year/Month)
                const selYear = parseInt(document.getElementById('yearFilter').value);
                const selMonth = document.getElementById('monthFilter').value;

                // Current Range
                currentStart = new Date(selYear, 0, 1); // Jan 1

                if (selMonth === 'all') {
                    // YTD Logic: If viewing current year (2026), limit to Today
                    let now = new Date();
                    if (selYear === 2026) { // Hardcoded "Current Year" awareness or dynamic
                        // Use "today" as end date for fair comparison
                        currentEnd = now;
                    } else {
                        currentEnd = new Date(selYear, 11, 31); // Dec 31
                    }
                } else {
                    currentStart = new Date(selYear, selMonth - 1, 1);
                    // End of Month
                    currentEnd = new Date(selYear, selMonth, 0);
                    // Cap at today if future
                    let now = new Date();
                    if (currentEnd > now) currentEnd = now;
                }

                // Previous Range (Fair Comparison)
                prevStart = new Date(currentStart);
                prevStart.setFullYear(prevStart.getFullYear() - 1);

                prevEnd = new Date(currentEnd);
                prevEnd.setFullYear(prevEnd.getFullYear() - 1);
            }

            // Debug Dates
            // console.log("Curr", currentStart, currentEnd);
            // console.log("Prev", prevStart, prevEnd);

            // Update Titles
            document.getElementById('currYearTitle').textContent = `(${toYMD(currentStart)} - ${toYMD(currentEnd)})`;
            document.getElementById('prevYearTitle').textContent = `(${toYMD(prevStart)} - ${toYMD(prevEnd)})`;

            // --- 2. Aggregation Function ---
            const calcStats = (start, end) => {
                let sales = 0, trans = 0, visitors = 0, target = 0;
                let monthly = {};
                let branchSales = {};
                let branchTrans = {};
                let branchVisitors = {};
                let branchTarget = {};

                // Convert to comparable value
                let sTime = start.getTime();
                let eTime = end.getTime();

                const filterFn = (dStr, sId) => {
                    // Branch Filter
                    if (selBranch !== 'all' && sId !== selBranch) return false;

                    // Date Filter
                    let dTime = new Date(dStr).getTime();
                    return dTime >= sTime && dTime <= eTime;
                };

                // Sales
                rawData.sales.forEach(([d, s, v]) => {
                    if (filterFn(d, s)) {
                        sales += v;
                        let m = new Date(d).getMonth() + 1;
                        monthly[m] = (monthly[m] || 0) + v;
                        branchSales[s] = (branchSales[s] || 0) + v;
                    }
                });
                // Targets
                rawData.targets.forEach(([d, s, v]) => {
                    if (filterFn(d, s)) {
                        target += v;
                        branchTarget[s] = (branchTarget[s] || 0) + v;
                    }
                });
                // Visitors
                rawData.visitors.forEach(([d, s, v]) => {
                    if (filterFn(d, s)) {
                        visitors += v;
                        branchVisitors[s] = (branchVisitors[s] || 0) + v;
                    }
                });
                // Trans
                rawData.transactions.forEach(([d, s, v]) => {
                    if (filterFn(d, s)) {
                        trans += v;
                        branchTrans[s] = (branchTrans[s] || 0) + v;
                    }
                });

                return { sales, trans, visitors, target, monthly, branchSales, branchTrans, branchVisitors, branchTarget };
            };

            const curr = calcStats(currentStart, currentEnd);
            const prev = calcStats(prevStart, prevEnd);

            // --- 3. Update KPI Cards (Current) ---
            fmt(document.getElementById('totalSales'), curr.sales);
            fmt(document.getElementById('totalTrans'), curr.trans);
            fmt(document.getElementById('totalVisitors'), curr.visitors);
            fmt(document.getElementById('targetVal'), curr.target);

            // Growth
            let growth = prev.sales > 0 ? ((curr.sales - prev.sales) / prev.sales) * 100 : 0;
            let gEl = document.getElementById('salesGrowthVal');
            gEl.textContent = (growth > 0 ? '+' : '') + growth.toFixed(1) + '%';
            gEl.className = growth >= 0 ? 'text-success-custom fw-bold' : 'text-danger-custom fw-bold';

            // Rates
            let avgTicket = curr.trans > 0 ? curr.sales / curr.trans : 0;
            document.getElementById('avgTicket').textContent = avgTicket.toFixed(0);

            let convRate = curr.visitors > 0 ? (curr.trans / curr.visitors) * 100 : 0;
            document.getElementById('convRate').textContent = convRate.toFixed(1) + '%';

            // Target Pct
            let targetPct = curr.target > 0 ? (curr.sales / curr.target) * 100 : 0;
            document.getElementById('targetPct').textContent = targetPct.toFixed(1) + '%';
            renderMiniGauge('miniGauge', targetPct);

            // --- 4. Update KPI Cards (Previous) ---
            fmt(document.getElementById('prevSales'), prev.sales);
            fmt(document.getElementById('prevTrans'), prev.trans);
            fmt(document.getElementById('prevVisitors'), prev.visitors);

            // Prev Rates
            let prevAvgTicket = prev.trans > 0 ? prev.sales / prev.trans : 0;
            document.getElementById('prevAvgTicket').textContent = prevAvgTicket.toFixed(0);

            let prevConvRate = prev.visitors > 0 ? (prev.trans / prev.visitors) * 100 : 0;
            document.getElementById('prevConvRate').textContent = prevConvRate.toFixed(1) + '%';

            // Absolute Growth
            let absGrowth = curr.sales - prev.sales;
            let absGEl = document.getElementById('growthAbs');
            absGEl.textContent = valFmt(absGrowth);
            absGEl.className = absGrowth >= 0 ? 'fw-bold fs-4 text-success' : 'fw-bold fs-4 text-danger';

            // --- 4. Trend Chart ---
            // Extract Year for Chart Labels from starts
            let cYear = currentStart.getFullYear();
            let pYear = prevStart.getFullYear();
            renderTrendChart(curr.monthly, prev.monthly, cYear, pYear);

            // --- 5. Top 10 Chart & Table ---
            // Prepare Branch Data
            let branchList = [];
            let allStores = new Set([
                ...Object.keys(curr.branchSales), ...Object.keys(prev.branchSales),
                ...Object.keys(curr.branchTarget), ...Object.keys(curr.branchTrans), ...Object.keys(curr.branchVisitors)
            ]);

            allStores.forEach(sid => {
                let name = rawData.stores[sid] || sid;

                // Metrics
                let val = curr.branchSales[sid] || 0;
                let prevVal = prev.branchSales[sid] || 0;
                let target = curr.branchTarget[sid] || 0;
                let trans = curr.branchTrans[sid] || 0;
                let visitors = curr.branchVisitors[sid] || 0;

                // Calcs
                let growth = prevVal > 0 ? ((val - prevVal) / prevVal) * 100 : 0;
                let ach = target > 0 ? (val / target) * 100 : 0;
                let avgInv = trans > 0 ? val / trans : 0;
                let conv = visitors > 0 ? (trans / visitors) * 100 : 0;

                branchList.push({
                    name, val, prevVal, growth, target, trans, visitors, ach, avgInv, conv
                });
            });

            // Sort Logic
            branchList.sort((a, b) => {
                let valA = a[currentSort.col];
                let valB = b[currentSort.col];
                // Handle names (strings) just in case, though usually numbers
                if (valA < valB) return currentSort.asc ? -1 : 1;
                if (valA > valB) return currentSort.asc ? 1 : -1;
                return 0;
            });

            // Render Top 10 Chart
            renderTop10(branchList.slice(0, 10));

            // Render Table
            const tbody = document.getElementById('detailsTableBody');
            tbody.innerHTML = '';

            branchList.forEach((b, i) => {
                let tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><span class="rank-badge">${i + 1}</span></td>
                    <td class="fw-bold fs-6">${b.name}</td>
                    <td>${b.val.toLocaleString()}</td>
                    <td>${b.target.toLocaleString()}</td>
                    <td class="${b.ach >= 100 ? 'text-success' : 'text-warning'} fw-bold">${b.ach.toFixed(1)}%</td>
                    <td class="${b.growth >= 0 ? 'text-success' : 'text-danger'} fw-bold" dir="ltr">${b.growth.toFixed(1)}%</td>
                    <td>${b.trans.toLocaleString()}</td>
                    <td>${b.avgInv.toFixed(0)}</td>
                    <td>${b.visitors.toLocaleString()}</td>
                    <td>${b.conv.toFixed(1)}%</td>
                `;
                tbody.appendChild(tr);
            });

            // --- 6. Render Daily Report ---
            renderDailyReport();
        }

        // --- Daily Report Logic (Yesterday vs Last Year) ---
        function renderDailyReport() {
            if (!rawData) return;

            // 1. Determine "Yesterday"
            let today = new Date();
            let yesterday = new Date(today);
            yesterday.setDate(today.getDate() - 1);

            let lastYear = new Date(yesterday);
            lastYear.setFullYear(yesterday.getFullYear() - 1);

            // Format YYYY-MM-DD
            const fmtDate = (d) => {
                let year = d.getFullYear();
                let month = (d.getMonth() + 1).toString().padStart(2, '0');
                let day = d.getDate().toString().padStart(2, '0');
                return `${year}-${month}-${day}`;
            };
            const dateYest = fmtDate(yesterday);
            const dateLastY = fmtDate(lastYear);

            // UI Label
            const dayNames = ["Ø§Ù„Ø£Ø­Ø¯", "Ø§Ù„Ø§Ø«Ù†ÙŠÙ†", "Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡", "Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡", "Ø§Ù„Ø®Ù…ÙŠØ³", "Ø§Ù„Ø¬Ù…Ø¹Ø©", "Ø§Ù„Ø³Ø¨Øª"];
            document.getElementById('dailyReportTitle').textContent = `ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø£Ù…Ø³ (${dayNames[yesterday.getDay()]} ${dateYest}) Ù…Ù‚Ø§Ø±Ù†Ø© Ø¨Ù€ (${dateLastY})`;

            // 2. Aggregate Data
            let stats = {}; // StoreID -> { salesY, salesLY, transY, visitY }

            // Initialize all stores
            Object.keys(rawData.stores).forEach(sid => {
                if (sid !== '0' && sid !== '9999') { // Skip Warehouse/Unknown if desired
                    stats[sid] = { salesY: 0, salesLY: 0, transY: 0, visitY: 0 };
                }
            });

            // Sales
            rawData.sales.forEach(([d, s, v]) => {
                if (!stats[s]) return;
                if (d === dateYest) stats[s].salesY += v;
                if (d === dateLastY) stats[s].salesLY += v;
            });
            // Trans
            rawData.transactions.forEach(([d, s, v]) => {
                if (!stats[s]) return;
                if (d === dateYest) stats[s].transY += v;
            });
            // Visitors
            rawData.visitors.forEach(([d, s, v]) => {
                if (!stats[s]) return;
                if (d === dateYest) stats[s].visitY += v;
            });

            // 3. Convert to Array and Sort
            let dailyList = [];
            Object.keys(stats).forEach(sid => {
                let d = stats[sid];
                if (d.salesY === 0 && d.salesLY === 0 && d.transY === 0) return;

                let name = rawData.stores[sid] || sid;
                let growth = d.salesLY > 0 ? ((d.salesY - d.salesLY) / d.salesLY) * 100 : 0;
                if (d.salesLY === 0 && d.salesY > 0) growth = 100;

                let avgInv = d.transY > 0 ? d.salesY / d.transY : 0;
                let conv = d.visitY > 0 ? (d.transY / d.visitY) * 100 : 0;

                dailyList.push({ sid, name, ...d, growth, avgInv, conv });
            });

            dailyList.sort((a, b) => b.salesY - a.salesY);

            // 4. Render Table
            const tbody = document.getElementById('dailyTableBody');
            tbody.innerHTML = '';

            dailyList.forEach((r, i) => {
                let tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${i + 1}</td>
                    <td class="fw-bold fs-6">
                        <a href="branch_details.html?sid=${r.sid}&name=${encodeURIComponent(r.name)}" target="_blank" class="text-decoration-none text-dark hover-primary">${r.name}</a>
                    </td>
                    <td class="fw-bold">${r.salesY.toLocaleString()}</td>
                    <td class="text-secondary">${r.salesLY.toLocaleString()}</td>
                    <td class="${r.growth >= 0 ? 'text-success' : 'text-danger'} fw-bold" dir="ltr">${r.growth > 0 ? '+' : ''}${r.growth.toFixed(1)}%</td>
                    <td>${r.transY.toLocaleString()}</td>
                    <td>${r.avgInv.toFixed(0)}</td>
                    <td>${r.visitY.toLocaleString()}</td>
                    <td>${r.conv.toFixed(1)}%</td>
                `;
                tbody.appendChild(tr);
            });
        }



        // --- Helpers ---
        function fmt(el, v) { el.textContent = v.toLocaleString(undefined, { maximumFractionDigits: 0 }); }
        function valFmt(v) { return v.toLocaleString(undefined, { maximumFractionDigits: 0 }); } // Explicit helper if needed

        function renderMiniGauge(id, pct) {
            const ctx = document.getElementById(id).getContext('2d');
            if (charts[id]) charts[id].destroy();
            charts[id] = new Chart(ctx, {
                type: 'doughnut',
                data: { datasets: [{ data: [pct, Math.max(0, 100 - pct)], backgroundColor: ['#fe7900', '#eee'], borderWidth: 0 }] },
                options: { cutout: '70%', events: [] }
            });
        }

        function renderTrendChart(currM, prevM, y1, y2) {
            const ctx = document.getElementById('trendChart').getContext('2d');
            if (charts['trend']) charts['trend'].destroy();

            const selectedM = document.getElementById('monthFilter').value;

            const labels = Array.from({ length: 12 }, (_, i) => i + 1);
            charts['trend'] = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels,
                    datasets: [
                        {
                            label: y1,
                            data: labels.map(m => currM[m] || 0),
                            // Selected: Dark Brand (#cc6100), Unselected: Faded (#ffd8a8), All: Brand (#fe7900)
                            backgroundColor: (ctx) => {
                                if (selectedM === 'all') return '#fe7900';
                                return (ctx.dataIndex + 1) == selectedM ? '#cc6100' : '#ffd8a8';
                            },
                            borderRadius: 4
                        },
                        { label: y2, data: labels.map(m => prevM[m] || 0), backgroundColor: '#e9ecef', borderRadius: 4 }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: { x: { grid: { display: false } }, y: { grid: { borderDash: [5, 5] } } },
                    plugins: { legend: { position: 'top' } },
                    onClick: (e, activeEls, chart) => {
                        const points = chart.getElementsAtEventForMode(e, 'nearest', { intersect: true }, true);
                        if (points.length) {
                            const index = points[0].index;
                            const month = index + 1;

                            const mFilter = document.getElementById('monthFilter');
                            const modeSelect = document.getElementById('filterMode');

                            // Ensure we switch to Standard mode if currently Custom (logic edge case)
                            // But usually chart is visible in both. Best to just set month filter.
                            if (modeSelect.value === 'custom') {
                                modeSelect.value = 'standard';
                                toggleFilterMode();
                            }

                            if (mFilter.value == month) {
                                mFilter.value = 'all';
                            } else {
                                mFilter.value = month;
                            }
                            updateDashboard();
                        }
                    },
                    onHover: (event, chartElement) => {
                        event.native.target.style.cursor = chartElement.length ? 'pointer' : 'default';
                    }
                }
            });
        }

        function renderTop10(data) {
            const ctx = document.getElementById('top10Chart').getContext('2d');
            if (charts['top10']) charts['top10'].destroy();

            charts['top10'] = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.map(d => d.name),
                    datasets: [{
                        label: 'Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª',
                        data: data.map(d => d.val),
                        backgroundColor: '#198754',
                        borderRadius: 4,
                        barThickness: 20
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true, maintainAspectRatio: false,
                    scales: { x: { display: false }, y: { grid: { display: false } } },
                    plugins: { legend: { display: false } }
                }
            });
        }

        init();
    </script>
</body>

</html>